<!DOCTYPE HTML>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<title>inf.sp_WhoIsActive</title>
<script src="../../../../../../scripts/jquery-1.12.0.min.js" type="text/javascript"></script>
<script src="../../../../../../scripts/bootstrap.min.js" type="text/javascript"></script>
<script src="../../../../../../scripts/clipboard.min.js" type="text/javascript"></script>
<script src="../../../../../../scripts/main.js" type="text/javascript"></script>
<link rel="stylesheet" href="../../../../../../styles/bootstrap/Default.css" type="text/css">
<link rel="stylesheet" href="../../../../../../styles/main.css" type="text/css">
</head>
<body>
  <div class="page-wrap">
    <div class="header">
      <div class="row">
        <div class="col-xs-12">
          <ol class="breadcrumb">
            <li><a href="../../../../../../startpage.html" data-mapping-enabled="true">Project</a></li>
            <li><a href="../../../../../../Servers\Servers.html" data-mapping-enabled="true">Servers</a></li>
            <li><a href="../../../../../../Servers\SRV\SRV.html" data-mapping-enabled="true">SRV</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\UserDatabases.html" data-mapping-enabled="true">User databases</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\SRV.html" data-mapping-enabled="true">SRV</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Programmability.html" data-mapping-enabled="true">Programmability</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\Procedures.html" data-mapping-enabled="true">Stored Procedures</a></li>
            <li class="active">inf.sp_WhoIsActive</li>
          </ol>
        </div>
      </div>
      <div class="row">
        <div class="title col-xs-12">
          <div><img class="inline-middle image-large" src="../../../../../../images/procedure.svg" title="inf.sp_WhoIsActive" />
            <h1 class="inline-middle">inf.sp_WhoIsActive</h1>
            <div class="dropdown actions-btn-wrap">
              <button type="button" class="btn btn-default actions-btn" data-toggle="dropdown"><span class="icon-actions icon-small actions-btn-span"></span></button>
              <ul class="dropdown-menu dropdown-menu-right">
                <li><a id="CollapseAll" href="#">Collapse All</a></li>
                <li><a id="ExpandAll" href="#">Expand All</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="content">
      <div id="Description" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Description</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <span>Устаревшее (описание внутри, использовалось до MS SQL Server 2012)</span>
          </div>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Properties</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <table class="table table-hover table-bordered">
              <tbody>
                <tr>
                  <th>Name</th>
                  <th>Value</th>
                </tr>
                <tr>
                  <td>ANSI Nulls ON</td>
                  <td><p class="value-true">True</p></td>
                </tr>
                <tr>
                  <td>Quoted Identifier ON</td>
                  <td><p class="value-true">True</p></td>
                </tr>
                <tr>
                  <td>Encrypted</td>
                  <td><p class="value-false">False</p></td>
                </tr>
                <tr>
                  <td>Execute As</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Assembly</td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="Parameters" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Parameters</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <table class="table table-hover table-bordered table-100">
              <tbody>
                <tr>
                  <th>Name</th>
                  <th>Data Type</th>
                  <th>Length</th>
                  <th class="column-description-35">Description</th>
                </tr>
                <tr>
                  <td>@filter</td>
                  <td>sysname</td>
                  <td>256</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@filter_type</td>
                  <td>varchar</td>
                  <td>10</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@not_filter</td>
                  <td>sysname</td>
                  <td>256</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@not_filter_type</td>
                  <td>varchar</td>
                  <td>10</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@show_own_spid</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@show_system_spids</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@show_sleeping_spids</td>
                  <td>tinyint</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@get_full_inner_text</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@get_plans</td>
                  <td>tinyint</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@get_outer_command</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@get_transaction_info</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@get_task_info</td>
                  <td>tinyint</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@get_locks</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@get_avg_time</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@get_additional_info</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@find_block_leaders</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@delta_interval</td>
                  <td>tinyint</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@output_column_list</td>
                  <td>varchar</td>
                  <td>8000</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@sort_order</td>
                  <td>varchar</td>
                  <td>500</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@format_output</td>
                  <td>tinyint</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@destination_table</td>
                  <td>varchar</td>
                  <td>4000</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@return_schema</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@schema</td>
                  <td>varchar</td>
                  <td>-1</td>
                  <td></td>
                </tr>
                <tr>
                  <td>@help</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="SqlScript" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">SQL Script</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <div class="sqlscript panel-default">
              <font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">QUOTED_IDENTIFIER</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">ANSI_NULLS</font>&nbsp;<font color="#0000ff">ON</font><br><font color="#0000ff">GO</font><br><font color="#000000"></font><br><font color="#000000"></font><br><font color="#008000">/*********************************************************************************************
Who Is Active? v11.17 (2016-10-18)
(C) 2007-2016, Adam Machanic

Feedback: mailto:amachanic@gmail.com
Updates: http://whoisactive.com

License: 
	Who is Active? is free to download and use for personal, educational, and internal 
	corporate purposes, provided that this header is preserved. Redistribution or sale 
	of Who is Active?, in whole or in part, is prohibited without the author's express 
	written consent.
*********************************************************************************************/</font><br><font color="#0000ff">CREATE</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#0000ff">ALTER</font>&nbsp;<font color="#0000ff">PROC</font>&nbsp;<font color="#008080">inf</font><font color="#808080">.</font><font color="#008080">sp_WhoIsActive</font><br><font color="#808080">(</font><br><font color="#008000">--~</font><br>&nbsp;<font color="#008000">--Filters--Both inclusive and exclusive</font><br>&nbsp;<font color="#008000">--Set either filter to '' to disable</font><br>&nbsp;<font color="#008000">--Valid filter types are: session, program, database, login, and host</font><br>&nbsp;<font color="#008000">--Session is a session ID, and either 0 or '' can be used to indicate "all" sessions</font><br>&nbsp;<font color="#008000">--All other filter types support % or _ as wildcards</font><br>&nbsp;<font color="#008080">@filter</font>&nbsp;<font color="#0000ff">sysname</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">@filter_type</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'session'</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">@not_filter</font>&nbsp;<font color="#0000ff">sysname</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">@not_filter_type</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'session'</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Retrieve data about the calling session?</font><br>&nbsp;<font color="#008080">@show_own_spid</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Retrieve data about system sessions?</font><br>&nbsp;<font color="#008080">@show_system_spids</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Controls how sleeping SPIDs are handled, based on the idea of levels of interest</font><br>&nbsp;<font color="#008000">--0 does not pull any sleeping SPIDs</font><br>&nbsp;<font color="#008000">--1 pulls only those sleeping SPIDs that also have an open transaction</font><br>&nbsp;<font color="#008000">--2 pulls all sleeping SPIDs</font><br>&nbsp;<font color="#008080">@show_sleeping_spids</font>&nbsp;<font color="#0000ff">TINYINT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--If 1, gets the full stored procedure or running batch, when available</font><br>&nbsp;<font color="#008000">--If 0, gets only the actual statement that is currently running in the batch or procedure</font><br>&nbsp;<font color="#008080">@get_full_inner_text</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Get associated query plans for running tasks, if available</font><br>&nbsp;<font color="#008000">--If @get_plans = 1, gets the plan based on the request's statement offset</font><br>&nbsp;<font color="#008000">--If @get_plans = 2, gets the entire plan based on the request's plan_handle</font><br>&nbsp;<font color="#008080">@get_plans</font>&nbsp;<font color="#0000ff">TINYINT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Get the associated outer ad hoc query or stored procedure call, if available</font><br>&nbsp;<font color="#008080">@get_outer_command</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Enables pulling transaction log write info and transaction duration</font><br>&nbsp;<font color="#008080">@get_transaction_info</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Get information on active tasks, based on three interest levels</font><br>&nbsp;<font color="#008000">--Level 0 does not pull any task-related information</font><br>&nbsp;<font color="#008000">--Level 1 is a lightweight mode that pulls the top non-CXPACKET wait, giving preference to blockers</font><br>&nbsp;<font color="#008000">--Level 2 pulls all available task-based metrics, including: </font><br>&nbsp;<font color="#008000">--number of active tasks, current wait stats, physical I/O, context switches, and blocker information</font><br>&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#0000ff">TINYINT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Gets associated locks for each request, aggregated in an XML format</font><br>&nbsp;<font color="#008080">@get_locks</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Get average time for past runs of an active query</font><br>&nbsp;<font color="#008000">--(based on the combination of plan handle, sql handle, and offset)</font><br>&nbsp;<font color="#008080">@get_avg_time</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Get additional non-performance-related information about the session or request</font><br>&nbsp;<font color="#008000">--text_size, language, date_format, date_first, quoted_identifier, arithabort, ansi_null_dflt_on, </font><br>&nbsp;<font color="#008000">--ansi_defaults, ansi_warnings, ansi_padding, ansi_nulls, concat_null_yields_null, </font><br>&nbsp;<font color="#008000">--transaction_isolation_level, lock_timeout, deadlock_priority, row_count, command_type</font><br>&nbsp;<font color="#008000">--</font><br>&nbsp;<font color="#008000">--If a SQL Agent job is running, an subnode called agent_info will be populated with some or all of</font><br>&nbsp;<font color="#008000">--the following: job_id, job_name, step_id, step_name, msdb_query_error (in the event of an error)</font><br>&nbsp;<font color="#008000">--</font><br>&nbsp;<font color="#008000">--If @get_task_info is set to 2 and a lock wait is detected, a subnode called block_info will be</font><br>&nbsp;<font color="#008000">--populated with some or all of the following: lock_type, database_name, object_id, file_id, hobt_id, </font><br>&nbsp;<font color="#008000">--applock_hash, metadata_resource, metadata_class_id, object_name, schema_name</font><br>&nbsp;<font color="#008080">@get_additional_info</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Walk the blocking chain and count the number of </font><br>&nbsp;<font color="#008000">--total SPIDs blocked all the way down by a given session</font><br>&nbsp;<font color="#008000">--Also enables task_info Level 1, if @get_task_info is set to 0</font><br>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Pull deltas on various metrics</font><br>&nbsp;<font color="#008000">--Interval in seconds to wait before doing the second data pull</font><br>&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#0000ff">TINYINT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--List of desired output columns, in desired order</font><br>&nbsp;<font color="#008000">--Note that the final output will be the intersection of all enabled features and all </font><br>&nbsp;<font color="#008000">--columns in the list. Therefore, only columns associated with enabled features will </font><br>&nbsp;<font color="#008000">--actually appear in the output. Likewise, removing columns from this list may effectively</font><br>&nbsp;<font color="#008000">--disable features, even if they are turned on</font><br>&nbsp;<font color="#008000">--</font><br>&nbsp;<font color="#008000">--Each element in this list must be one of the valid output column names. Names must be</font><br>&nbsp;<font color="#008000">--delimited by square brackets. White space, formatting, and additional characters are</font><br>&nbsp;<font color="#008000">--allowed, as long as the list contains exact matches of delimited valid column names.</font><br>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">8000</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'[dd%][session_id][sql_text][sql_command][login_name][wait_info][tasks][tran_log%][cpu%][temp%][block%][reads%][writes%][context%][physical%][query_plan][locks][%]'</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Column(s) by which to sort output, optionally with sort directions. </font><br>&nbsp;&nbsp;<font color="#008000">--Valid column choices:</font><br>&nbsp;&nbsp;<font color="#008000">--session_id, physical_io, reads, physical_reads, writes, tempdb_allocations,</font><br>&nbsp;&nbsp;<font color="#008000">--tempdb_current, CPU, context_switches, used_memory, physical_io_delta, </font><br>&nbsp;&nbsp;<font color="#008000">--reads_delta, physical_reads_delta, writes_delta, tempdb_allocations_delta, </font><br>&nbsp;&nbsp;<font color="#008000">--tempdb_current_delta, CPU_delta, context_switches_delta, used_memory_delta, </font><br>&nbsp;&nbsp;<font color="#008000">--tasks, tran_start_time, open_tran_count, blocking_session_id, blocked_session_count,</font><br>&nbsp;&nbsp;<font color="#008000">--percent_complete, host_name, login_name, database_name, start_time, login_time</font><br>&nbsp;&nbsp;<font color="#008000">--</font><br>&nbsp;&nbsp;<font color="#008000">--Note that column names in the list must be bracket-delimited. Commas and/or white</font><br>&nbsp;&nbsp;<font color="#008000">--space are not required. </font><br>&nbsp;<font color="#008080">@sort_order</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">500</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'[start_time] ASC'</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Formats some of the output columns in a more "human readable" form</font><br>&nbsp;<font color="#008000">--0 disables outfput format</font><br>&nbsp;<font color="#008000">--1 formats the output for variable-width fonts</font><br>&nbsp;<font color="#008000">--2 formats the output for fixed-width fonts</font><br>&nbsp;<font color="#008080">@format_output</font>&nbsp;<font color="#0000ff">TINYINT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--If set to a non-blank value, the script will attempt to insert into the specified </font><br>&nbsp;<font color="#008000">--destination table. Please note that the script will not verify that the table exists, </font><br>&nbsp;<font color="#008000">--or that it has the correct schema, before doing the insert.</font><br>&nbsp;<font color="#008000">--Table can be specified in one, two, or three-part format</font><br>&nbsp;<font color="#008080">@destination_table</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">4000</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--If set to 1, no data collection will happen and no result set will be returned; instead,</font><br>&nbsp;<font color="#008000">--a CREATE TABLE statement will be returned via the @schema parameter, which will match </font><br>&nbsp;<font color="#008000">--the schema of the result set that would be returned by using the same collection of the</font><br>&nbsp;<font color="#008000">--rest of the parameters. The CREATE TABLE statement will have a placeholder token of </font><br>&nbsp;<font color="#008000">--<table_name> in place of an actual table name.</font><br>&nbsp;<font color="#008080">@return_schema</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">@schema</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">OUTPUT</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;<font color="#008000">--Help! What do I do?</font><br>&nbsp;<font color="#008080">@help</font>&nbsp;<font color="#0000ff">BIT</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br><font color="#008000">--~</font><br><font color="#808080">)</font><br><font color="#008000">/*
OUTPUT COLUMNS
--------------
Formatted/Non:	[session_id] [smallint] NOT NULL
	Session ID (a.k.a. SPID)

Formatted:		[dd hh:mm:ss.mss] [varchar](15) NULL
Non-Formatted:	<not returned>
	For an active request, time the query has been running
	For a sleeping session, time since the last batch completed

Formatted:		[dd hh:mm:ss.mss (avg)] [varchar](15) NULL
Non-Formatted:	[avg_elapsed_time] [int] NULL
	(Requires @get_avg_time option)
	How much time has the active portion of the query taken in the past, on average?

Formatted:		[physical_io] [varchar](30) NULL
Non-Formatted:	[physical_io] [bigint] NULL
	Shows the number of physical I/Os, for active requests

Formatted:		[reads] [varchar](30) NULL
Non-Formatted:	[reads] [bigint] NULL
	For an active request, number of reads done for the current query
	For a sleeping session, total number of reads done over the lifetime of the session

Formatted:		[physical_reads] [varchar](30) NULL
Non-Formatted:	[physical_reads] [bigint] NULL
	For an active request, number of physical reads done for the current query
	For a sleeping session, total number of physical reads done over the lifetime of the session

Formatted:		[writes] [varchar](30) NULL
Non-Formatted:	[writes] [bigint] NULL
	For an active request, number of writes done for the current query
	For a sleeping session, total number of writes done over the lifetime of the session

Formatted:		[tempdb_allocations] [varchar](30) NULL
Non-Formatted:	[tempdb_allocations] [bigint] NULL
	For an active request, number of TempDB writes done for the current query
	For a sleeping session, total number of TempDB writes done over the lifetime of the session

Formatted:		[tempdb_current] [varchar](30) NULL
Non-Formatted:	[tempdb_current] [bigint] NULL
	For an active request, number of TempDB pages currently allocated for the query
	For a sleeping session, number of TempDB pages currently allocated for the session

Formatted:		[CPU] [varchar](30) NULL
Non-Formatted:	[CPU] [int] NULL
	For an active request, total CPU time consumed by the current query
	For a sleeping session, total CPU time consumed over the lifetime of the session

Formatted:		[context_switches] [varchar](30) NULL
Non-Formatted:	[context_switches] [bigint] NULL
	Shows the number of context switches, for active requests

Formatted:		[used_memory] [varchar](30) NOT NULL
Non-Formatted:	[used_memory] [bigint] NOT NULL
	For an active request, total memory consumption for the current query
	For a sleeping session, total current memory consumption

Formatted:		[physical_io_delta] [varchar](30) NULL
Non-Formatted:	[physical_io_delta] [bigint] NULL
	(Requires @delta_interval option)
	Difference between the number of physical I/Os reported on the first and second collections. 
	If the request started after the first collection, the value will be NULL

Formatted:		[reads_delta] [varchar](30) NULL
Non-Formatted:	[reads_delta] [bigint] NULL
	(Requires @delta_interval option)
	Difference between the number of reads reported on the first and second collections. 
	If the request started after the first collection, the value will be NULL

Formatted:		[physical_reads_delta] [varchar](30) NULL
Non-Formatted:	[physical_reads_delta] [bigint] NULL
	(Requires @delta_interval option)
	Difference between the number of physical reads reported on the first and second collections. 
	If the request started after the first collection, the value will be NULL

Formatted:		[writes_delta] [varchar](30) NULL
Non-Formatted:	[writes_delta] [bigint] NULL
	(Requires @delta_interval option)
	Difference between the number of writes reported on the first and second collections. 
	If the request started after the first collection, the value will be NULL

Formatted:		[tempdb_allocations_delta] [varchar](30) NULL
Non-Formatted:	[tempdb_allocations_delta] [bigint] NULL
	(Requires @delta_interval option)
	Difference between the number of TempDB writes reported on the first and second collections. 
	If the request started after the first collection, the value will be NULL

Formatted:		[tempdb_current_delta] [varchar](30) NULL
Non-Formatted:	[tempdb_current_delta] [bigint] NULL
	(Requires @delta_interval option)
	Difference between the number of allocated TempDB pages reported on the first and second 
	collections. If the request started after the first collection, the value will be NULL

Formatted:		[CPU_delta] [varchar](30) NULL
Non-Formatted:	[CPU_delta] [int] NULL
	(Requires @delta_interval option)
	Difference between the CPU time reported on the first and second collections. 
	If the request started after the first collection, the value will be NULL

Formatted:		[context_switches_delta] [varchar](30) NULL
Non-Formatted:	[context_switches_delta] [bigint] NULL
	(Requires @delta_interval option)
	Difference between the context switches count reported on the first and second collections
	If the request started after the first collection, the value will be NULL

Formatted:		[used_memory_delta] [varchar](30) NULL
Non-Formatted:	[used_memory_delta] [bigint] NULL
	Difference between the memory usage reported on the first and second collections
	If the request started after the first collection, the value will be NULL

Formatted:		[tasks] [varchar](30) NULL
Non-Formatted:	[tasks] [smallint] NULL
	Number of worker tasks currently allocated, for active requests

Formatted/Non:	[status] [varchar](30) NOT NULL
	Activity status for the session (running, sleeping, etc)

Formatted/Non:	[wait_info] [nvarchar](4000) NULL
	Aggregates wait information, in the following format:
		(Ax: Bms/Cms/Dms)E
	A is the number of waiting tasks currently waiting on resource type E. B/C/D are wait
	times, in milliseconds. If only one thread is waiting, its wait time will be shown as B.
	If two tasks are waiting, each of their wait times will be shown (B/C). If three or more 
	tasks are waiting, the minimum, average, and maximum wait times will be shown (B/C/D).
	If wait type E is a page latch wait and the page is of a "special" type (e.g. PFS, GAM, SGAM), 
	the page type will be identified.
	If wait type E is CXPACKET, the nodeId from the query plan will be identified

Formatted/Non:	[locks] [xml] NULL
	(Requires @get_locks option)
	Aggregates lock information, in XML format.
	The lock XML includes the lock mode, locked object, and aggregates the number of requests. 
	Attempts are made to identify locked objects by name

Formatted/Non:	[tran_start_time] [datetime] NULL
	(Requires @get_transaction_info option)
	Date and time that the first transaction opened by a session caused a transaction log 
	write to occur.

Formatted/Non:	[tran_log_writes] [nvarchar](4000) NULL
	(Requires @get_transaction_info option)
	Aggregates transaction log write information, in the following format:
	A:wB (C kB)
	A is a database that has been touched by an active transaction
	B is the number of log writes that have been made in the database as a result of the transaction
	C is the number of log kilobytes consumed by the log records

Formatted:		[open_tran_count] [varchar](30) NULL
Non-Formatted:	[open_tran_count] [smallint] NULL
	Shows the number of open transactions the session has open

Formatted:		[sql_command] [xml] NULL
Non-Formatted:	[sql_command] [nvarchar](max) NULL
	(Requires @get_outer_command option)
	Shows the "outer" SQL command, i.e. the text of the batch or RPC sent to the server, 
	if available

Formatted:		[sql_text] [xml] NULL
Non-Formatted:	[sql_text] [nvarchar](max) NULL
	Shows the SQL text for active requests or the last statement executed
	for sleeping sessions, if available in either case.
	If @get_full_inner_text option is set, shows the full text of the batch.
	Otherwise, shows only the active statement within the batch.
	If the query text is locked, a special timeout message will be sent, in the following format:
		<timeout_exceeded />
	If an error occurs, an error message will be sent, in the following format:
		<error message="message" />

Formatted/Non:	[query_plan] [xml] NULL
	(Requires @get_plans option)
	Shows the query plan for the request, if available.
	If the plan is locked, a special timeout message will be sent, in the following format:
		<timeout_exceeded />
	If an error occurs, an error message will be sent, in the following format:
		<error message="message" />

Formatted/Non:	[blocking_session_id] [smallint] NULL
	When applicable, shows the blocking SPID

Formatted:		[blocked_session_count] [varchar](30) NULL
Non-Formatted:	[blocked_session_count] [smallint] NULL
	(Requires @find_block_leaders option)
	The total number of SPIDs blocked by this session,
	all the way down the blocking chain.

Formatted:		[percent_complete] [varchar](30) NULL
Non-Formatted:	[percent_complete] [real] NULL
	When applicable, shows the percent complete (e.g. for backups, restores, and some rollbacks)

Formatted/Non:	[host_name] [sysname] NOT NULL
	Shows the host name for the connection

Formatted/Non:	[login_name] [sysname] NOT NULL
	Shows the login name for the connection

Formatted/Non:	[database_name] [sysname] NULL
	Shows the connected database

Formatted/Non:	[program_name] [sysname] NULL
	Shows the reported program/application name

Formatted/Non:	[additional_info] [xml] NULL
	(Requires @get_additional_info option)
	Returns additional non-performance-related session/request information
	If the script finds a SQL Agent job running, the name of the job and job step will be reported
	If @get_task_info = 2 and the script finds a lock wait, the locked object will be reported

Formatted/Non:	[start_time] [datetime] NOT NULL
	For active requests, shows the time the request started
	For sleeping sessions, shows the time the last batch completed

Formatted/Non:	[login_time] [datetime] NOT NULL
	Shows the time that the session connected

Formatted/Non:	[request_id] [int] NULL
	For active requests, shows the request_id
	Should be 0 unless MARS is being used

Formatted/Non:	[collection_time] [datetime] NOT NULL
	Time that this script's final SELECT ran
*/</font><br><font color="#0000ff">AS</font><br><font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">NOCOUNT</font>&nbsp;<font color="#0000ff">ON</font><font color="#808080">;</font>&nbsp;<br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">TRANSACTION</font>&nbsp;<font color="#0000ff">ISOLATION</font>&nbsp;<font color="#0000ff">LEVEL</font>&nbsp;<font color="#0000ff">READ</font>&nbsp;<font color="#0000ff">UNCOMMITTED</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">QUOTED_IDENTIFIER</font>&nbsp;<font color="#0000ff">ON</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">ANSI_PADDING</font>&nbsp;<font color="#0000ff">ON</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">CONCAT_NULL_YIELDS_NULL</font>&nbsp;<font color="#0000ff">ON</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">ANSI_WARNINGS</font>&nbsp;<font color="#0000ff">ON</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">NUMERIC_ROUNDABORT</font>&nbsp;<font color="#0000ff">OFF</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">ARITHABORT</font>&nbsp;<font color="#0000ff">ON</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">IF</font><br>&nbsp;&nbsp;<font color="#008080">@filter</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@filter_type</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@not_filter</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@not_filter_type</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@show_own_spid</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@show_system_spids</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@show_sleeping_spids</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@get_full_inner_text</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@get_plans</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@get_outer_command</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@get_transaction_info</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@get_locks</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@get_avg_time</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@get_additional_info</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@format_output</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@sort_order</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@return_schema</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@destination_table</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@help</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'Input parameters cannot be NULL'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@filter_type</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#ff0000">'session'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'program'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'database'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'login'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'host'</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'Valid filter types are: session, program, database, login, host'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@filter_type</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'session'</font>&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@filter</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%[^0123456789]%'</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'Session filters must be valid integers'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@not_filter_type</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#ff0000">'session'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'program'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'database'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'login'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'host'</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'Valid filter types are: session, program, database, login, host'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@not_filter_type</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'session'</font>&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@not_filter</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%[^0123456789]%'</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'Session filters must be valid integers'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@show_sleeping_spids</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#000000">0</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'Valid values for @show_sleeping_spids are: 0, 1, or 2'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@get_plans</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#000000">0</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'Valid values for @get_plans are: 0, 1, or 2'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#000000">0</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'Valid values for @get_task_info are: 0, 1, or 2'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@format_output</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#000000">0</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'Valid values for @format_output are: 0, 1, or 2'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@help</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@header</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@params</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@outputs</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@header</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'/'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">REPLICATE</font><font color="#808080">(</font><font color="#ff0000">'*'</font><font color="#808080">,</font>&nbsp;<font color="#000000">93</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">94</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff00ff">REPLICATE</font><font color="#808080">(</font><font color="#ff0000">'*'</font><font color="#808080">,</font>&nbsp;<font color="#000000">93</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'/'</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'/'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">REPLICATE</font><font color="#808080">(</font><font color="#ff0000">'*'</font><font color="#808080">,</font>&nbsp;<font color="#000000">93</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">94</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">+</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'	'</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@params</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'--~'</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">5</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'--~'</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'--~'</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">5</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'--~'</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">5</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">+</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'	'</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@outputs</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'OUTPUT COLUMNS'</font><font color="#808080">+</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">+</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font><font color="#808080">+</font><font color="#ff0000">'--------------'</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">32</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'*/'</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'OUTPUT COLUMNS'</font><font color="#808080">+</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">+</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font><font color="#808080">+</font><font color="#ff0000">'--------------'</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">32</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'OUTPUT COLUMNS'</font><font color="#808080">+</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">+</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font><font color="#808080">+</font><font color="#ff0000">'--------------'</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">32</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">9</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">+</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'	'</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_requests</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">r</font><br>&nbsp;&nbsp;<font color="#808080">CROSS</font>&nbsp;<font color="#0000ff">APPLY</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_sql_text</font><font color="#808080">(</font><font color="#008080">r</font><font color="#808080">.</font><font color="#008080">sql_handle</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#0000ff">t</font><br>&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">r</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">@@SPID</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">WITH</font><br>&nbsp;&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font>&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a4</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">numbers</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@header</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a4</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">RTRIM</font><font color="#808080">(</font><font color="#ff00ff">LTRIM</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@header</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">@header</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[------header---------------------------------------------------------------------------------------------------------------]</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">numbers</font><br>&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">@header</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">WITH</font><br>&nbsp;&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font>&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a4</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">numbers</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@params</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a4</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">tokens</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">RTRIM</font><font color="#808080">(</font><font color="#ff00ff">LTRIM</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@params</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">@params</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">token</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">@params</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">','</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">@params</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@params</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">param_group</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PARTITION</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">','</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">@params</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">@params</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">+</font><font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">group_order</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">numbers</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">@params</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">parsed_tokens</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">MIN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">token</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'@%'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">token</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">parameter</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">MIN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">token</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'--%'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#0000ff">RIGHT</font><font color="#808080">(</font><font color="#008080">token</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">token</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#0000ff">description</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">param_group</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">group_order</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">tokens</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">NOT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">token</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">''</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">group_order</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">param_group</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">group_order</font><br>&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#0000ff">description</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">parameter</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'-------------------------------------------------------------------------'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">param_group</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">MAX</font><font color="#808080">(</font><font color="#008080">param_group</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">parameter</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#0000ff">LEFT</font><font color="#808080">(</font><font color="#008080">parameter</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">parameter</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[------parameter----------------------------------------------------------]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#0000ff">description</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">parameter</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'----------------------------------------------------------------------------------------------------------------------'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#0000ff">description</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[------description-----------------------------------------------------------------------------------------------------]</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">parsed_tokens</font><br>&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">param_group</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">group_order</font><font color="#808080">;</font><br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">WITH</font><br>&nbsp;&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font>&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">a4</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">numbers</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@outputs</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a4</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">tokens</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">RTRIM</font><font color="#808080">(</font><font color="#ff00ff">LTRIM</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@outputs</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'Formatted'</font><font color="#808080">,</font>&nbsp;<font color="#008080">@outputs</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@outputs</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#808080"><</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">@outputs</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@outputs</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'Formatted'</font><font color="#808080">,</font>&nbsp;<font color="#008080">@outputs</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@outputs</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">@outputs</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@outputs</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">token</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'Formatted'</font><font color="#808080">,</font>&nbsp;<font color="#008080">@outputs</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@outputs</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">output_group</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PARTITION</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'Formatted'</font><font color="#808080">,</font>&nbsp;<font color="#008080">@outputs</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@outputs</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">output_group_order</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">numbers</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">@outputs</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">,</font>&nbsp;<font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'Formatted'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">@outputs</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><br>&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">output_tokens</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">*</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">output_group_order</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff00ff">MAX</font><font color="#808080">(</font><font color="#0000ff">CASE</font>&nbsp;<font color="#008080">output_group_order</font>&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">token</font>&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">END</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">PARTITION</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#008080">output_group</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">column_info</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">tokens</font><br>&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">output_group_order</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'-----------------------------------'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Formatted/Non:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">2</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">-</font><font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">formatted_column_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">output_group_order</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'-----------------------------------'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Formatted/Non:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">2</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">2</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">-</font><font color="#000000">3</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">formatted_column_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">output_group_order</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'---------------------------------------'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Formatted/Non:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'<'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'>'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">unformatted_column_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">output_group_order</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'---------------------------------------'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Formatted/Non:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'<'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">2</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'Non-Formatted:'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">column_info</font><font color="#808080">)</font><font color="#808080">-</font><font color="#000000">3</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">unformatted_column_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">output_group_order</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'----------------------------------------------------------------------------------------------------------------------'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#008080">token</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[------description-----------------------------------------------------------------------------------------------------]</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">output_tokens</font><br>&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">NOT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">output_group_order</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">output_group</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@outputs</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">output_group</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">output_group_order</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">99</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#008080">output_group_order</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">WITH</font><br>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font>&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">a4</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">numbers</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@output_column_list</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a4</font><br>&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><br>&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">tokens</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#ff0000">'|['</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">@output_column_list</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'|]'</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">token</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">numbers</font><br>&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">@output_column_list</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'['</font><br>&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">ordered_columns</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">column_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PARTITION</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">column_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tokens</font><font color="#808080">.</font><font color="#008080">number</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">default_order</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">r</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tokens</font><font color="#808080">.</font><font color="#008080">number</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">default_order</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">tokens</font><br>&nbsp;&nbsp;<font color="#808080">JOIN</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[session_id]'</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">column_name</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">default_order</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[dd hh:mm:ss.mss]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@format_output</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[dd hh:mm:ss.mss (avg)]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">3</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@format_output</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@get_avg_time</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[avg_elapsed_time]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">4</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@format_output</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@get_avg_time</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[physical_io]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">5</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[reads]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">6</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[physical_reads]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">7</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[writes]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">8</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tempdb_allocations]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">9</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tempdb_current]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">10</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[CPU]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">11</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[context_switches]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">12</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[used_memory]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">13</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[physical_io_delta]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">14</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[reads_delta]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">15</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[physical_reads_delta]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[writes_delta]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">17</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tempdb_allocations_delta]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">18</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tempdb_current_delta]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">19</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[CPU_delta]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">20</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[context_switches_delta]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">21</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[used_memory_delta]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">22</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tasks]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">23</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[status]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">24</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[wait_info]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">25</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[locks]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">26</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_locks</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tran_start_time]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">27</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_transaction_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tran_log_writes]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">28</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_transaction_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[open_tran_count]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">29</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[sql_command]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">30</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_outer_command</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[sql_text]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">31</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[query_plan]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">32</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_plans</font>&nbsp;<font color="#808080">></font><font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[blocking_session_id]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">33</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[blocked_session_count]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">34</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[percent_complete]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">35</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[host_name]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">36</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[login_name]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">37</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[database_name]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">38</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[program_name]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">39</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[additional_info]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">40</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_additional_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[start_time]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">41</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[login_time]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">42</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[request_id]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">43</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[collection_time]'</font><font color="#808080">,</font>&nbsp;<font color="#000000">44</font><br>&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">x</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">column_name</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#008080">token</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;<font color="#808080">)</font><br>&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">STUFF</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">','</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#008080">column_name</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#008080">[text()]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">ordered_columns</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">r</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">XML</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PATH</font><font color="#808080">(</font><font color="#ff0000">''</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">RTRIM</font><font color="#808080">(</font><font color="#008080">@output_column_list</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'No valid column matches found in @output_column_list or no columns remain due to selected options.'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@destination_table</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@destination_table</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008000">--database</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#ff00ff">PARSENAME</font><font color="#808080">(</font><font color="#008080">@destination_table</font><font color="#808080">,</font>&nbsp;<font color="#000000">3</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<font color="#008000">--schema</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#ff00ff">PARSENAME</font><font color="#808080">(</font><font color="#008080">@destination_table</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<font color="#008000">--table</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#ff00ff">PARSENAME</font><font color="#808080">(</font><font color="#008080">@destination_table</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">RTRIM</font><font color="#808080">(</font><font color="#008080">@destination_table</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">RAISERROR</font><font color="#808080">(</font><font color="#ff0000">'Destination table not properly formatted.'</font><font color="#808080">,</font>&nbsp;<font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">RETURN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">WITH</font><br>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font>&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">a4</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">n</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a</font><font color="#808080">,</font>&nbsp;<font color="#008080">a3</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">numbers</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@sort_order</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">a4</font><br>&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><br>&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">tokens</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#ff0000">'|['</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@sort_order</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">@sort_order</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#008080">number</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'|]'</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">token</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@sort_order</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">@sort_order</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'['</font><font color="#808080">,</font>&nbsp;<font color="#008080">@sort_order</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">@sort_order</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">@sort_order</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">']'</font><font color="#808080">,</font>&nbsp;<font color="#008080">@sort_order</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">next_chunk</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">numbers</font><br>&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">@sort_order</font><font color="#808080">,</font>&nbsp;<font color="#008080">number</font><font color="#808080">,</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'['</font><br>&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">ordered_columns</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">column_name</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tokens</font><font color="#808080">.</font><font color="#008080">next_chunk</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%asc%'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">' ASC'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tokens</font><font color="#808080">.</font><font color="#008080">next_chunk</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%desc%'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">' DESC'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">column_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PARTITION</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">column_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tokens</font><font color="#808080">.</font><font color="#008080">number</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">r</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">tokens</font><font color="#808080">.</font><font color="#008080">number</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">tokens</font><br>&nbsp;&nbsp;<font color="#808080">JOIN</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[session_id]'</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">column_name</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[physical_io]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[reads]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[physical_reads]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[writes]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tempdb_allocations]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tempdb_current]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[CPU]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[context_switches]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[used_memory]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[physical_io_delta]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[reads_delta]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[physical_reads_delta]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[writes_delta]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tempdb_allocations_delta]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tempdb_current_delta]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[CPU_delta]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[context_switches_delta]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[used_memory_delta]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tasks]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[tran_start_time]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[open_tran_count]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[blocking_session_id]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[blocked_session_count]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[percent_complete]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[host_name]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[login_name]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[database_name]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[start_time]'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff0000">'[login_time]'</font><br>&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">x</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">column_name</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#008080">token</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;<font color="#808080">)</font><br>&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;<font color="#008080">@sort_order</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">z</font><font color="#808080">.</font><font color="#008080">sort_order</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">STUFF</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">','</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#008080">column_name</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#008080">[text()]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">ordered_columns</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">r</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">number</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">XML</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PATH</font><font color="#808080">(</font><font color="#ff0000">''</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">sort_order</font><br>&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">z</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">TABLE</font>&nbsp;<font color="#008080">#sessions</font><br>&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;<font color="#008080">recursion</font>&nbsp;<font color="#0000ff">SMALLINT</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">session_id</font>&nbsp;<font color="#0000ff">SMALLINT</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">request_id</font>&nbsp;<font color="#0000ff">INT</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">session_number</font>&nbsp;<font color="#0000ff">INT</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">elapsed_time</font>&nbsp;<font color="#0000ff">INT</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">avg_elapsed_time</font>&nbsp;<font color="#0000ff">INT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">physical_io</font>&nbsp;<font color="#0000ff">BIGINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">reads</font>&nbsp;<font color="#0000ff">BIGINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">physical_reads</font>&nbsp;<font color="#0000ff">BIGINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">writes</font>&nbsp;<font color="#0000ff">BIGINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">tempdb_allocations</font>&nbsp;<font color="#0000ff">BIGINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">tempdb_current</font>&nbsp;<font color="#0000ff">BIGINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#0000ff">CPU</font>&nbsp;<font color="#0000ff">INT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">thread_CPU_snapshot</font>&nbsp;<font color="#0000ff">BIGINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">context_switches</font>&nbsp;<font color="#0000ff">BIGINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">used_memory</font>&nbsp;<font color="#0000ff">BIGINT</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;<font color="#008080">tasks</font>&nbsp;<font color="#0000ff">SMALLINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#0000ff">status</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">30</font><font color="#808080">)</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">wait_info</font>&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#000000">4000</font><font color="#808080">)</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">locks</font>&nbsp;<font color="#0000ff">XML</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">transaction_id</font>&nbsp;<font color="#0000ff">BIGINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">tran_start_time</font>&nbsp;<font color="#0000ff">DATETIME</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">tran_log_writes</font>&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#000000">4000</font><font color="#808080">)</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">open_tran_count</font>&nbsp;<font color="#0000ff">SMALLINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">sql_command</font>&nbsp;<font color="#0000ff">XML</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">sql_handle</font>&nbsp;<font color="#0000ff">VARBINARY</font><font color="#808080">(</font><font color="#000000">64</font><font color="#808080">)</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">statement_start_offset</font>&nbsp;<font color="#0000ff">INT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">statement_end_offset</font>&nbsp;<font color="#0000ff">INT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">sql_text</font>&nbsp;<font color="#0000ff">XML</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">plan_handle</font>&nbsp;<font color="#0000ff">VARBINARY</font><font color="#808080">(</font><font color="#000000">64</font><font color="#808080">)</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">query_plan</font>&nbsp;<font color="#0000ff">XML</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">blocking_session_id</font>&nbsp;<font color="#0000ff">SMALLINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">blocked_session_count</font>&nbsp;<font color="#0000ff">SMALLINT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">percent_complete</font>&nbsp;<font color="#0000ff">REAL</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#ff00ff">host_name</font>&nbsp;<font color="#0000ff">sysname</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">login_name</font>&nbsp;<font color="#0000ff">sysname</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#0000ff">database_name</font>&nbsp;<font color="#0000ff">sysname</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">program_name</font>&nbsp;<font color="#0000ff">sysname</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">additional_info</font>&nbsp;<font color="#0000ff">XML</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">start_time</font>&nbsp;<font color="#0000ff">DATETIME</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">login_time</font>&nbsp;<font color="#0000ff">DATETIME</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">last_request_start_time</font>&nbsp;<font color="#0000ff">DATETIME</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#0000ff">PRIMARY</font>&nbsp;<font color="#0000ff">KEY</font>&nbsp;<font color="#0000ff">CLUSTERED</font>&nbsp;<font color="#808080">(</font><font color="#008080">session_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">recursion</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">IGNORE_DUP_KEY</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#0000ff">ON</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#0000ff">UNIQUE</font>&nbsp;<font color="#0000ff">NONCLUSTERED</font>&nbsp;<font color="#808080">(</font><font color="#008080">transaction_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">recursion</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">IGNORE_DUP_KEY</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#0000ff">ON</font><font color="#808080">)</font><br>&nbsp;<font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@return_schema</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#008000">--Disable unnecessary autostats on the table</font><br>&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_session_id</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#808080">(</font><font color="#008080">session_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_request_id</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#808080">(</font><font color="#008080">request_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_transaction_id</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#808080">(</font><font color="#008080">transaction_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_session_number</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#808080">(</font><font color="#008080">session_number</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_status</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">status</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_start_time</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#808080">(</font><font color="#008080">start_time</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_last_request_start_time</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#808080">(</font><font color="#008080">last_request_start_time</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_recursion</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#808080">(</font><font color="#008080">recursion</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#0000ff">SMALLINT</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@delta_interval</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">-</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@first_collection_ms_ticks</font>&nbsp;<font color="#0000ff">BIGINT</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@last_collection_start</font>&nbsp;<font color="#0000ff">DATETIME</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--Used for the delta pull</font><br>&nbsp;&nbsp;<font color="#0000ff">REDO:</font><font color="#808080">;</font><br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@get_locks</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[locks|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">resource_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#0000ff">database_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#ff00ff">object_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#ff00ff">file_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">page_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">hobt_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">allocation_unit_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">index_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#ff00ff">schema_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">principal_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">request_mode</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">request_status</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">request_count</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">start_time</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">sysname</font><font color="#808080">,</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#ff00ff">object_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">sysname</font><font color="#808080">,</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">index_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">sysname</font><font color="#808080">,</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#ff00ff">schema_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">sysname</font><font color="#808080">,</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">principal_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#000000">2048</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">query_error</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font>&nbsp;<font color="#008080">#locks</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">spid</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#0000ff">status</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'sleeping'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">INT</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#0000ff">status</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'sleeping'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">last_batch</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">req</font><font color="#808080">.</font><font color="#008080">start_time</font><font color="#808080">,</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">last_batch</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">start_time</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">dbid</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">sysprocesses</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">sp</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OUTER</font>&nbsp;<font color="#0000ff">APPLY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">hostprocess</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">r</font><font color="#808080">.</font><font color="#008080">total_elapsed_time</font>&nbsp;<font color="#808080"><</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">r</font><font color="#808080">.</font><font color="#008080">start_time</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">DATEADD</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">ms</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">1000</font>&nbsp;<font color="#808080">*</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">DATEPART</font><font color="#808080">(</font><font color="#008080">ms</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">DATEADD</font><font color="#808080">(</font><font color="#ff00ff">second</font><font color="#808080">,</font>&nbsp;<font color="#808080">-</font><font color="#808080">(</font><font color="#008080">r</font><font color="#808080">.</font><font color="#008080">total_elapsed_time</font>&nbsp;<font color="#808080">/</font>&nbsp;<font color="#000000">1000</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">GETDATE</font><font color="#808080">(</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#808080">/</font>&nbsp;<font color="#000000">500</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#ff00ff">DATEPART</font><font color="#808080">(</font><font color="#008080">ms</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">DATEADD</font><font color="#808080">(</font><font color="#ff00ff">second</font><font color="#808080">,</font>&nbsp;<font color="#808080">-</font><font color="#808080">(</font><font color="#008080">r</font><font color="#808080">.</font><font color="#008080">total_elapsed_time</font>&nbsp;<font color="#808080">/</font>&nbsp;<font color="#000000">1000</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">GETDATE</font><font color="#808080">(</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">DATEADD</font><font color="#808080">(</font><font color="#ff00ff">second</font><font color="#808080">,</font>&nbsp;<font color="#808080">-</font><font color="#808080">(</font><font color="#008080">r</font><font color="#808080">.</font><font color="#008080">total_elapsed_time</font>&nbsp;<font color="#808080">/</font>&nbsp;<font color="#000000">1000</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">GETDATE</font><font color="#808080">(</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">start_time</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_requests</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">r</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">r</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">spid</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">r</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">req</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--Process inclusive filter</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">1</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@filter</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff0000">''</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@filter_type</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'session'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">SMALLINT</font><font color="#808080">,</font>&nbsp;<font color="#008080">@filter</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">spid</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">SMALLINT</font><font color="#808080">,</font>&nbsp;<font color="#008080">@filter</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'program'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">program_name</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#008080">@filter</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'login'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">loginame</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#008080">@filter</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'host'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">hostname</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#008080">@filter</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'database'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">DB_NAME</font><font color="#808080">(</font><font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">dbid</font><font color="#808080">)</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#008080">@filter</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--Process exclusive filter</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@not_filter</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff0000">''</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@not_filter_type</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'session'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">spid</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">SMALLINT</font><font color="#808080">,</font>&nbsp;<font color="#008080">@not_filter</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'program'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">program_name</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#008080">@not_filter</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'login'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">loginame</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#008080">@not_filter</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'host'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">hostname</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#008080">@not_filter</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'database'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">DB_NAME</font><font color="#808080">(</font><font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">dbid</font><font color="#808080">)</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#008080">@not_filter</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@show_own_spid</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">spid</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff00ff">@@SPID</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@show_system_spids</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">hostprocess</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">sp</font><font color="#808080">.</font><font color="#008080">ecid</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">INNER</font>&nbsp;<font color="#0000ff">HASH</font>&nbsp;<font color="#808080">JOIN</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">resource_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#0000ff">database_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">object_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">file_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">%</font>&nbsp;<font color="#000000">8088</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'PFS'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">%</font>&nbsp;<font color="#000000">511232</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'GAM'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">3</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#808080">(</font><font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">%</font>&nbsp;<font color="#000000">511232</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'SGAM'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">6</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#808080">(</font><font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">6</font><font color="#808080">)</font>&nbsp;<font color="#808080">%</font>&nbsp;<font color="#000000">511232</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'DCM'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">7</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#808080">(</font><font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">7</font><font color="#808080">)</font>&nbsp;<font color="#808080">%</font>&nbsp;<font color="#000000">511232</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'BCM'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'*'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">page_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">hobt_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">allocation_unit_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">index_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">schema_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">principal_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">request_mode</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">request_status</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">object_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">file_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">hobt_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">allocation_unit_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">index_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">schema_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">principal_id</font><font color="#808080">)</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">resource_description</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COUNT</font><font color="#808080">(</font><font color="#808080">*</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">request_count</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_subtype</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">''</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'.'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_subtype</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">resource_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">DB_NAME</font><font color="#808080">(</font><font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_database_id</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'(null)'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#0000ff">database_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'OBJECT'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_associated_entity_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%object_id = %'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'object_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">NULLIF</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">','</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'object_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">DATALENGTH</font><font color="#808080">(</font><font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'object_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">12</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#ff00ff">object_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'FILE'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">INT</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#ff0000">'PAGE'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'EXTENT'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'RID'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#0000ff">LEFT</font><font color="#808080">(</font><font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">':'</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font><font color="#808080">-</font><font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#ff00ff">file_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#ff0000">'PAGE'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'EXTENT'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'RID'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">':'</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">NULLIF</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">':'</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">':'</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">DATALENGTH</font><font color="#808080">(</font><font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">':'</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">page_no</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#ff0000">'PAGE'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'KEY'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'RID'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'HOBT'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_associated_entity_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">hobt_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'ALLOCATION_UNIT'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_associated_entity_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">allocation_unit_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">/*TODO: Deal with server principals*/</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_subtype</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff0000">'SERVER_PRINCIPAL'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%index_id or stats_id = %'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'index_id or stats_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">23</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">NULLIF</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">','</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'index_id or stats_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">23</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">DATALENGTH</font><font color="#808080">(</font><font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'index_id or stats_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">23</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">index_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%schema_id = %'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'schema_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">NULLIF</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">','</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'schema_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">DATALENGTH</font><font color="#808080">(</font><font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'schema_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">12</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#ff00ff">schema_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%principal_id = %'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'principal_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">15</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">NULLIF</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">','</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'principal_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">15</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">DATALENGTH</font><font color="#808080">(</font><font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">'principal_id = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">15</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">principal_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">request_mode</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">request_status</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">request_session_id</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">request_request_id</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">/*TODO: Applocks, other resource_descriptions*/</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">RTRIM</font><font color="#808080">(</font><font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">resource_description</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tl</font><font color="#808080">.</font><font color="#008080">resource_associated_entity_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">/*********************************************/</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">request_session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">120</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">resource_type</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">resource_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">120</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">resource_subtype</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">resource_subtype</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">resource_database_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">512</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">resource_description</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">resource_description</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">resource_associated_entity_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">120</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">request_mode</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">request_mode</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">120</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">request_status</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">request_status</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">request_request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_tran_locks</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">tl</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">x</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">resource_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#0000ff">database_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">object_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">file_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">%</font>&nbsp;<font color="#000000">8088</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'PFS'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">%</font>&nbsp;<font color="#000000">511232</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'GAM'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">3</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#808080">(</font><font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">%</font>&nbsp;<font color="#000000">511232</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'SGAM'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">6</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#808080">(</font><font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">6</font><font color="#808080">)</font>&nbsp;<font color="#808080">%</font>&nbsp;<font color="#000000">511232</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'DCM'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">7</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#808080">(</font><font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">7</font><font color="#808080">)</font>&nbsp;<font color="#808080">%</font>&nbsp;<font color="#000000">511232</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'BCM'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">page_no</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'*'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">hobt_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">allocation_unit_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">index_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">schema_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">principal_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">request_mode</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">request_status</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">object_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">file_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">hobt_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">allocation_unit_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">index_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#ff00ff">schema_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">principal_id</font><font color="#808080">)</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#008080">resource_description</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">y</font>&nbsp;<font color="#0000ff">ON</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">y</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">HASH</font>&nbsp;<font color="#0000ff">GROUP</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#008000">--Disable unnecessary autostats on the table</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_database_name</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">database_name</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_object_id</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">object_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_hobt_id</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">hobt_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_allocation_unit_id</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">allocation_unit_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_index_id</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">index_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_schema_id</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">schema_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_principal_id</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">principal_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_request_id</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">request_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_start_time</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">start_time</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_resource_type</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">resource_type</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_object_name</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">object_name</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_schema_name</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">schema_name</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_page_type</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">page_type</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_request_mode</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">request_mode</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_request_status</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">request_status</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_resource_description</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">resource_description</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_index_name</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">index_name</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_principal_name</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">principal_name</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@sql</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@sql_n</font>&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@sql</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'DECLARE @blocker BIT;
			SET @blocker = 0;
			DECLARE @i INT;
			SET @i = 2147483647;

			DECLARE @sessions TABLE
			(
				session_id SMALLINT NOT NULL,
				request_id INT NOT NULL,
				login_time DATETIME,
				last_request_end_time DATETIME,
				status VARCHAR(30),
				statement_start_offset INT,
				statement_end_offset INT,
				sql_handle BINARY(20),
				host_name NVARCHAR(128),
				login_name NVARCHAR(128),
				program_name NVARCHAR(128),
				database_id SMALLINT,
				memory_usage INT,
				open_tran_count SMALLINT, 
				'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">0</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'wait_type NVARCHAR(32),
						wait_resource NVARCHAR(256),
						wait_time BIGINT, 
						'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'blocked SMALLINT,
				is_user_process BIT,
				cmd VARCHAR(32),
				PRIMARY KEY CLUSTERED (session_id, request_id) WITH (IGNORE_DUP_KEY = ON)
			);

			DECLARE @blockers TABLE
			(
				session_id INT NOT NULL PRIMARY KEY WITH (IGNORE_DUP_KEY = ON)
			);

			BLOCKERS:;

			INSERT @sessions
			(
				session_id,
				request_id,
				login_time,
				last_request_end_time,
				status,
				statement_start_offset,
				statement_end_offset,
				sql_handle,
				host_name,
				login_name,
				program_name,
				database_id,
				memory_usage,
				open_tran_count, 
				'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'wait_type,
						wait_resource,
						wait_time, 
						'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'blocked,
				is_user_process,
				cmd 
			)
			SELECT TOP(@i)
				spy.session_id,
				spy.request_id,
				spy.login_time,
				spy.last_request_end_time,
				spy.status,
				spy.statement_start_offset,
				spy.statement_end_offset,
				spy.sql_handle,
				spy.host_name,
				spy.login_name,
				spy.program_name,
				spy.database_id,
				spy.memory_usage,
				spy.open_tran_count,
				'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">0</font>&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'spy.wait_type,
						CASE
							WHEN
								spy.wait_type LIKE N''PAGE%LATCH_%''
								OR spy.wait_type = N''CXPACKET''
								OR spy.wait_type LIKE N''LATCH[_]%''
								OR spy.wait_type = N''OLEDB'' THEN
									spy.wait_resource
							ELSE
								NULL
						END AS wait_resource,
						spy.wait_time, 
						'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'spy.blocked,
				spy.is_user_process,
				spy.cmd
			FROM
			(
				SELECT TOP(@i)
					spx.*, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">0</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'ROW_NUMBER() OVER
							(
								PARTITION BY
									spx.session_id,
									spx.request_id
								ORDER BY
									CASE
										WHEN spx.wait_type LIKE N''LCK[_]%'' THEN 
											1
										ELSE
											99
									END,
									spx.wait_time DESC,
									spx.blocked DESC
							) AS r 
							'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'1 AS r 
							'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'FROM
				(
					SELECT TOP(@i)
						sp0.session_id,
						sp0.request_id,
						sp0.login_time,
						sp0.last_request_end_time,
						LOWER(sp0.status) AS status,
						CASE
							WHEN sp0.cmd = ''CREATE INDEX'' THEN
								0
							ELSE
								sp0.stmt_start
						END AS statement_start_offset,
						CASE
							WHEN sp0.cmd = N''CREATE INDEX'' THEN
								-1
							ELSE
								COALESCE(NULLIF(sp0.stmt_end, 0), -1)
						END AS statement_end_offset,
						sp0.sql_handle,
						sp0.host_name,
						sp0.login_name,
						sp0.program_name,
						sp0.database_id,
						sp0.memory_usage,
						sp0.open_tran_count, 
						'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">0</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'CASE
									WHEN sp0.wait_time > 0 AND sp0.wait_type <> N''CXPACKET'' THEN
										sp0.wait_type
									ELSE
										NULL
								END AS wait_type,
								CASE
									WHEN sp0.wait_time > 0 AND sp0.wait_type <> N''CXPACKET'' THEN 
										sp0.wait_resource
									ELSE
										NULL
								END AS wait_resource,
								CASE
									WHEN sp0.wait_type <> N''CXPACKET'' THEN
										sp0.wait_time
									ELSE
										0
								END AS wait_time, 
								'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'sp0.blocked,
						sp0.is_user_process,
						sp0.cmd
					FROM
					(
						SELECT TOP(@i)
							sp1.session_id,
							sp1.request_id,
							sp1.login_time,
							sp1.last_request_end_time,
							sp1.status,
							sp1.cmd,
							sp1.stmt_start,
							sp1.stmt_end,
							MAX(NULLIF(sp1.sql_handle, 0x00)) OVER (PARTITION BY sp1.session_id, sp1.request_id) AS sql_handle,
							sp1.host_name,
							MAX(sp1.login_name) OVER (PARTITION BY sp1.session_id, sp1.request_id) AS login_name,
							sp1.program_name,
							sp1.database_id,
							MAX(sp1.memory_usage)  OVER (PARTITION BY sp1.session_id, sp1.request_id) AS memory_usage,
							MAX(sp1.open_tran_count)  OVER (PARTITION BY sp1.session_id, sp1.request_id) AS open_tran_count,
							sp1.wait_type,
							sp1.wait_resource,
							sp1.wait_time,
							sp1.blocked,
							sp1.hostprocess,
							sp1.is_user_process
						FROM
						(
							SELECT TOP(@i)
								sp2.spid AS session_id,
								CASE sp2.status
									WHEN ''sleeping'' THEN
										CONVERT(INT, 0)
									ELSE
										sp2.request_id
								END AS request_id,
								MAX(sp2.login_time) AS login_time,
								MAX(sp2.last_batch) AS last_request_end_time,
								MAX(CONVERT(VARCHAR(30), RTRIM(sp2.status)) COLLATE Latin1_General_Bin2) AS status,
								MAX(CONVERT(VARCHAR(32), RTRIM(sp2.cmd)) COLLATE Latin1_General_Bin2) AS cmd,
								MAX(sp2.stmt_start) AS stmt_start,
								MAX(sp2.stmt_end) AS stmt_end,
								MAX(sp2.sql_handle) AS sql_handle,
								MAX(CONVERT(sysname, RTRIM(sp2.hostname)) COLLATE SQL_Latin1_General_CP1_CI_AS) AS host_name,
								MAX(CONVERT(sysname, RTRIM(sp2.loginame)) COLLATE SQL_Latin1_General_CP1_CI_AS) AS login_name,
								MAX
								(
									CASE
										WHEN blk.queue_id IS NOT NULL THEN
											N''Service Broker
												database_id: '' + CONVERT(NVARCHAR, blk.database_id) +
												N'' queue_id: '' + CONVERT(NVARCHAR, blk.queue_id)
										ELSE
											CONVERT
											(
												sysname,
												RTRIM(sp2.program_name)
											)
									END COLLATE SQL_Latin1_General_CP1_CI_AS
								) AS program_name,
								MAX(sp2.dbid) AS database_id,
								MAX(sp2.memusage) AS memory_usage,
								MAX(sp2.open_tran) AS open_tran_count,
								RTRIM(sp2.lastwaittype) AS wait_type,
								RTRIM(sp2.waitresource) AS wait_resource,
								MAX(sp2.waittime) AS wait_time,
								COALESCE(NULLIF(sp2.blocked, sp2.spid), 0) AS blocked,
								MAX
								(
									CASE
										WHEN blk.session_id = sp2.spid THEN
											''blocker''
										ELSE
											RTRIM(sp2.hostprocess)
									END
								) AS hostprocess,
								CONVERT
								(
									BIT,
									MAX
									(
										CASE
											WHEN sp2.hostprocess > '''' THEN
												1
											ELSE
												0
										END
									)
								) AS is_user_process
							FROM
							(
								SELECT TOP(@i)
									session_id,
									CONVERT(INT, NULL) AS queue_id,
									CONVERT(INT, NULL) AS database_id
								FROM @blockers

								UNION ALL

								SELECT TOP(@i)
									CONVERT(SMALLINT, 0),
									CONVERT(INT, NULL) AS queue_id,
									CONVERT(INT, NULL) AS database_id
								WHERE
									@blocker = 0

								UNION ALL

								SELECT TOP(@i)
									CONVERT(SMALLINT, spid),
									queue_id,
									database_id
								FROM sys.dm_broker_activated_tasks
								WHERE
									@blocker = 0
							) AS blk
							INNER JOIN sys.sysprocesses AS sp2 ON
								sp2.spid = blk.session_id
								OR
								(
									blk.session_id = 0
									AND @blocker = 0
								)
							'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'WHERE
										sp2.ecid = 0 
									'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'GROUP BY
								sp2.spid,
								CASE sp2.status
									WHEN ''sleeping'' THEN
										CONVERT(INT, 0)
									ELSE
										sp2.request_id
								END,
								RTRIM(sp2.lastwaittype),
								RTRIM(sp2.waitresource),
								COALESCE(NULLIF(sp2.blocked, sp2.spid), 0)
						) AS sp1
					) AS sp0
					WHERE
						@blocker = 1
						OR
						(1=1 
						'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--inclusive filter</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@filter</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff0000">''</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@filter_type</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'session'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">SMALLINT</font><font color="#808080">,</font>&nbsp;<font color="#008080">@filter</font><font color="#808080">)</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.session_id = CONVERT(SMALLINT, @filter) 
													'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'program'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.program_name LIKE @filter 
											'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'login'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.login_name LIKE @filter 
											'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'host'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.host_name LIKE @filter 
											'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'database'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND DB_NAME(sp0.database_id) LIKE @filter 
											'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--exclusive filter</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@not_filter</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff0000">''</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@not_filter_type</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'session'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">SMALLINT</font><font color="#808080">,</font>&nbsp;<font color="#008080">@not_filter</font><font color="#808080">)</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.session_id <> CONVERT(SMALLINT, @not_filter) 
													'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'program'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.program_name NOT LIKE @not_filter 
											'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'login'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.login_name NOT LIKE @not_filter 
											'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'host'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.host_name NOT LIKE @not_filter 
											'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff0000">'database'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND DB_NAME(sp0.database_id) NOT LIKE @not_filter 
											'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@show_own_spid</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.session_id <> @@spid 
									'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@show_system_spids</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.hostprocess > '''' 
									'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@show_sleeping_spids</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND sp0.status <> ''sleeping'' 
									'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AND
									(
										sp0.status <> ''sleeping''
										OR sp0.open_tran_count > 0
									)
									'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">')
				) AS spx
			) AS spy
			WHERE
				spy.r = 1; 
			'</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@recursion</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'IF @@ROWCOUNT > 0
					BEGIN;
						INSERT @blockers
						(
							session_id
						)
						SELECT TOP(@i)
							blocked
						FROM @sessions
						WHERE
							NULLIF(blocked, 0) IS NOT NULL

						EXCEPT

						SELECT TOP(@i)
							session_id
						FROM @sessions; 
						'</font>&nbsp;<font color="#808080">+</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'IF @@ROWCOUNT > 0
								BEGIN;
									SET @blocker = 1;
									GOTO BLOCKERS;
								END; 
								'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'END; 
					'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'SELECT TOP(@i)
				@recursion AS recursion,
				x.session_id,
				x.request_id,
				DENSE_RANK() OVER
				(
					ORDER BY
						x.session_id
				) AS session_number,
				'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[dd hh:mm:ss.mss|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.elapsed_time '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'0 '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS elapsed_time, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[dd hh:mm:ss.mss (avg)|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<font color="#808080">OR</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[avg_elapsed_time|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.avg_elapsed_time / 1000 '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS avg_elapsed_time, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[physical_io|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[physical_io_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.physical_io '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS physical_io, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[reads|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[reads_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.reads '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'0 '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS reads, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[physical_reads|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[physical_reads_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.physical_reads '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'0 '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS physical_reads, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[writes|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[writes_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.writes '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'0 '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS writes, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[tempdb_allocations|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[tempdb_allocations_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.tempdb_allocations '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'0 '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS tempdb_allocations, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[tempdb_current|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[tempdb_current_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.tempdb_current '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'0 '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS tempdb_current, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[CPU|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[CPU_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.CPU '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'0 '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS CPU, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[CPU_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.thread_CPU_snapshot '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'0 '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS thread_CPU_snapshot, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[context_switches|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[context_switches_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.context_switches '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS context_switches, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[used_memory|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[used_memory_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.used_memory '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'0 '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS used_memory, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[tasks|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.tasks '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS tasks, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[status|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[sql_command|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.status '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''''' '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS status, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[wait_info|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@get_task_info</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'COALESCE(x.task_wait_info, x.sys_wait_info) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.sys_wait_info '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS wait_info, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[tran_start_time|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[tran_log_writes|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.transaction_id '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS transaction_id, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[open_tran_count|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.open_tran_count '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS open_tran_count, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[sql_text|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.sql_handle '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS sql_handle, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[sql_text|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[query_plan|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.statement_start_offset '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS statement_start_offset, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[sql_text|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[query_plan|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.statement_end_offset '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS statement_end_offset, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'NULL AS sql_text, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[query_plan|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.plan_handle '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS plan_handle, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[blocking_session_id|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULLIF(x.blocking_session_id, 0) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS blocking_session_id, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[percent_complete|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.percent_complete '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS percent_complete, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[host_name|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.host_name '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''''' '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS host_name, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[login_name|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.login_name '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''''' '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS login_name, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[database_name|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'DB_NAME(x.database_id) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS database_name, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[program_name|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.program_name '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''''' '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS program_name, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[additional_info|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'(
									SELECT TOP(@i)
										x.text_size,
										x.language,
										x.date_format,
										x.date_first,
										CASE x.quoted_identifier
											WHEN 0 THEN ''OFF''
											WHEN 1 THEN ''ON''
										END AS quoted_identifier,
										CASE x.arithabort
											WHEN 0 THEN ''OFF''
											WHEN 1 THEN ''ON''
										END AS arithabort,
										CASE x.ansi_null_dflt_on
											WHEN 0 THEN ''OFF''
											WHEN 1 THEN ''ON''
										END AS ansi_null_dflt_on,
										CASE x.ansi_defaults
											WHEN 0 THEN ''OFF''
											WHEN 1 THEN ''ON''
										END AS ansi_defaults,
										CASE x.ansi_warnings
											WHEN 0 THEN ''OFF''
											WHEN 1 THEN ''ON''
										END AS ansi_warnings,
										CASE x.ansi_padding
											WHEN 0 THEN ''OFF''
											WHEN 1 THEN ''ON''
										END AS ansi_padding,
										CASE ansi_nulls
											WHEN 0 THEN ''OFF''
											WHEN 1 THEN ''ON''
										END AS ansi_nulls,
										CASE x.concat_null_yields_null
											WHEN 0 THEN ''OFF''
											WHEN 1 THEN ''ON''
										END AS concat_null_yields_null,
										CASE x.transaction_isolation_level
											WHEN 0 THEN ''Unspecified''
											WHEN 1 THEN ''ReadUncomitted''
											WHEN 2 THEN ''ReadCommitted''
											WHEN 3 THEN ''Repeatable''
											WHEN 4 THEN ''Serializable''
											WHEN 5 THEN ''Snapshot''
										END AS transaction_isolation_level,
										x.lock_timeout,
										x.deadlock_priority,
										x.row_count,
										x.command_type, 
										master.dbo.fn_varbintohexstr(x.sql_handle) AS sql_handle,
										master.dbo.fn_varbintohexstr(x.plan_handle) AS plan_handle,
										'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[program_name|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'(
													SELECT TOP(1)
														CONVERT(uniqueidentifier, CONVERT(XML, '''').value(''xs:hexBinary( substring(sql:column("agent_info.job_id_string"), 0) )'', ''binary(16)'')) AS job_id,
														agent_info.step_id,
														(
															SELECT TOP(1)
																NULL
															FOR XML
																PATH(''job_name''),
																TYPE
														),
														(
															SELECT TOP(1)
																NULL
															FOR XML
																PATH(''step_name''),
																TYPE
														)
													FROM
													(
														SELECT TOP(1)
															SUBSTRING(x.program_name, CHARINDEX(''0x'', x.program_name) + 2, 32) AS job_id_string,
															SUBSTRING(x.program_name, CHARINDEX('': Step '', x.program_name) + 7, CHARINDEX('')'', x.program_name, CHARINDEX('': Step '', x.program_name)) - (CHARINDEX('': Step '', x.program_name) + 7)) AS step_id
														WHERE
															x.program_name LIKE N''SQLAgent - TSQL JobStep (Job 0x%''
													) AS agent_info
													FOR XML
														PATH(''agent_job_info''),
														TYPE
												),
												'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'CONVERT(XML, x.block_info) AS block_info, 
												'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'x.host_process_id 
									FOR XML
										PATH(''additional_info''),
										TYPE
								) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS additional_info, 
				x.start_time, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[login_time|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'x.login_time '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS login_time, 
				x.last_request_start_time
			FROM
			(
				SELECT TOP(@i)
					y.*,
					CASE
						WHEN DATEDIFF(hour, y.start_time, GETDATE()) > 576 THEN
							DATEDIFF(second, GETDATE(), y.start_time)
						ELSE DATEDIFF(ms, y.start_time, GETDATE())
					END AS elapsed_time,
					COALESCE(tempdb_info.tempdb_allocations, 0) AS tempdb_allocations,
					COALESCE
					(
						CASE
							WHEN tempdb_info.tempdb_current < 0 THEN 0
							ELSE tempdb_info.tempdb_current
						END,
						0
					) AS tempdb_current, 
					'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'N''('' + CONVERT(NVARCHAR, y.wait_duration_ms) + N''ms)'' +
									y.wait_type +
										CASE
											WHEN y.wait_type LIKE N''PAGE%LATCH_%'' THEN
												N'':'' +
												COALESCE(DB_NAME(CONVERT(INT, LEFT(y.resource_description, CHARINDEX(N'':'', y.resource_description) - 1))), N''(null)'') +
												N'':'' +
												SUBSTRING(y.resource_description, CHARINDEX(N'':'', y.resource_description) + 1, LEN(y.resource_description) - CHARINDEX(N'':'', REVERSE(y.resource_description)) - CHARINDEX(N'':'', y.resource_description)) +
												N''('' +
													CASE
														WHEN
															CONVERT(INT, RIGHT(y.resource_description, CHARINDEX(N'':'', REVERSE(y.resource_description)) - 1)) = 1 OR
															CONVERT(INT, RIGHT(y.resource_description, CHARINDEX(N'':'', REVERSE(y.resource_description)) - 1)) % 8088 = 0
																THEN 
																	N''PFS''
														WHEN
															CONVERT(INT, RIGHT(y.resource_description, CHARINDEX(N'':'', REVERSE(y.resource_description)) - 1)) = 2 OR
															CONVERT(INT, RIGHT(y.resource_description, CHARINDEX(N'':'', REVERSE(y.resource_description)) - 1)) % 511232 = 0
																THEN 
																	N''GAM''
														WHEN
															CONVERT(INT, RIGHT(y.resource_description, CHARINDEX(N'':'', REVERSE(y.resource_description)) - 1)) = 3 OR
															(CONVERT(INT, RIGHT(y.resource_description, CHARINDEX(N'':'', REVERSE(y.resource_description)) - 1)) - 1) % 511232 = 0
																THEN
																	N''SGAM''
														WHEN
															CONVERT(INT, RIGHT(y.resource_description, CHARINDEX(N'':'', REVERSE(y.resource_description)) - 1)) = 6 OR
															(CONVERT(INT, RIGHT(y.resource_description, CHARINDEX(N'':'', REVERSE(y.resource_description)) - 1)) - 6) % 511232 = 0 
																THEN 
																	N''DCM''
														WHEN
															CONVERT(INT, RIGHT(y.resource_description, CHARINDEX(N'':'', REVERSE(y.resource_description)) - 1)) = 7 OR
															(CONVERT(INT, RIGHT(y.resource_description, CHARINDEX(N'':'', REVERSE(y.resource_description)) - 1)) - 7) % 511232 = 0 
																THEN 
																	N''BCM''
														ELSE 
															N''*''
													END +
												N'')''
											WHEN y.wait_type = N''CXPACKET'' THEN
												N'':'' + SUBSTRING(y.resource_description, CHARINDEX(N''nodeId'', y.resource_description) + 7, 4)
											WHEN y.wait_type LIKE N''LATCH[_]%'' THEN
												N'' ['' + LEFT(y.resource_description, COALESCE(NULLIF(CHARINDEX(N'' '', y.resource_description), 0), LEN(y.resource_description) + 1) - 1) + N'']''
											WHEN
												y.wait_type = N''OLEDB''
												AND y.resource_description LIKE N''%(SPID=%)'' THEN
													N''['' + LEFT(y.resource_description, CHARINDEX(N''(SPID='', y.resource_description) - 2) +
														N'':'' + SUBSTRING(y.resource_description, CHARINDEX(N''(SPID='', y.resource_description) + 6, CHARINDEX(N'')'', y.resource_description, (CHARINDEX(N''(SPID='', y.resource_description) + 6)) - (CHARINDEX(N''(SPID='', y.resource_description) + 6)) + '']''
											ELSE
												N''''
										END COLLATE Latin1_General_Bin2 AS sys_wait_info, 
										'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'tasks.physical_io,
								tasks.context_switches,
								tasks.tasks,
								tasks.block_info,
								tasks.wait_info AS task_wait_info,
								tasks.thread_CPU_snapshot,
								'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">(</font><font color="#008080">@get_avg_time</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CONVERT(INT, NULL) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'qs.total_elapsed_time / qs.execution_count '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'AS avg_elapsed_time 
				FROM
				(
					SELECT TOP(@i)
						sp.session_id,
						sp.request_id,
						COALESCE(r.logical_reads, s.logical_reads) AS reads,
						COALESCE(r.reads, s.reads) AS physical_reads,
						COALESCE(r.writes, s.writes) AS writes,
						COALESCE(r.CPU_time, s.CPU_time) AS CPU,
						sp.memory_usage + COALESCE(r.granted_query_memory, 0) AS used_memory,
						LOWER(sp.status) AS status,
						COALESCE(r.sql_handle, sp.sql_handle) AS sql_handle,
						COALESCE(r.statement_start_offset, sp.statement_start_offset) AS statement_start_offset,
						COALESCE(r.statement_end_offset, sp.statement_end_offset) AS statement_end_offset,
						'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'sp.wait_type COLLATE Latin1_General_Bin2 AS wait_type,
								sp.wait_resource COLLATE Latin1_General_Bin2 AS resource_description,
								sp.wait_time AS wait_duration_ms, 
								'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'NULLIF(sp.blocked, 0) AS blocking_session_id,
						r.plan_handle,
						NULLIF(r.percent_complete, 0) AS percent_complete,
						sp.host_name,
						sp.login_name,
						sp.program_name,
						s.host_process_id,
						COALESCE(r.text_size, s.text_size) AS text_size,
						COALESCE(r.language, s.language) AS language,
						COALESCE(r.date_format, s.date_format) AS date_format,
						COALESCE(r.date_first, s.date_first) AS date_first,
						COALESCE(r.quoted_identifier, s.quoted_identifier) AS quoted_identifier,
						COALESCE(r.arithabort, s.arithabort) AS arithabort,
						COALESCE(r.ansi_null_dflt_on, s.ansi_null_dflt_on) AS ansi_null_dflt_on,
						COALESCE(r.ansi_defaults, s.ansi_defaults) AS ansi_defaults,
						COALESCE(r.ansi_warnings, s.ansi_warnings) AS ansi_warnings,
						COALESCE(r.ansi_padding, s.ansi_padding) AS ansi_padding,
						COALESCE(r.ansi_nulls, s.ansi_nulls) AS ansi_nulls,
						COALESCE(r.concat_null_yields_null, s.concat_null_yields_null) AS concat_null_yields_null,
						COALESCE(r.transaction_isolation_level, s.transaction_isolation_level) AS transaction_isolation_level,
						COALESCE(r.lock_timeout, s.lock_timeout) AS lock_timeout,
						COALESCE(r.deadlock_priority, s.deadlock_priority) AS deadlock_priority,
						COALESCE(r.row_count, s.row_count) AS row_count,
						COALESCE(r.command, sp.cmd) AS command_type,
						COALESCE
						(
							CASE
								WHEN
								(
									s.is_user_process = 0
									AND r.total_elapsed_time >= 0
								) THEN
									DATEADD
									(
										ms,
										1000 * (DATEPART(ms, DATEADD(second, -(r.total_elapsed_time / 1000), GETDATE())) / 500) - DATEPART(ms, DATEADD(second, -(r.total_elapsed_time / 1000), GETDATE())),
										DATEADD(second, -(r.total_elapsed_time / 1000), GETDATE())
									)
							END,
							NULLIF(COALESCE(r.start_time, sp.last_request_end_time), CONVERT(DATETIME, ''19000101'', 112)),
							(
								SELECT TOP(1)
									DATEADD(second, -(ms_ticks / 1000), GETDATE())
								FROM sys.dm_os_sys_info
							)
						) AS start_time,
						sp.login_time,
						CASE
							WHEN s.is_user_process = 1 THEN
								s.last_request_start_time
							ELSE
								COALESCE
								(
									DATEADD
									(
										ms,
										1000 * (DATEPART(ms, DATEADD(second, -(r.total_elapsed_time / 1000), GETDATE())) / 500) - DATEPART(ms, DATEADD(second, -(r.total_elapsed_time / 1000), GETDATE())),
										DATEADD(second, -(r.total_elapsed_time / 1000), GETDATE())
									),
									s.last_request_start_time
								)
						END AS last_request_start_time,
						r.transaction_id,
						sp.database_id,
						sp.open_tran_count
					FROM @sessions AS sp
					LEFT OUTER LOOP JOIN sys.dm_exec_sessions AS s ON
						s.session_id = sp.session_id
						AND s.login_time = sp.login_time
					LEFT OUTER LOOP JOIN sys.dm_exec_requests AS r ON
						sp.status <> ''sleeping''
						AND r.session_id = sp.session_id
						AND r.request_id = sp.request_id
						AND
						(
							(
								s.is_user_process = 0
								AND sp.is_user_process = 0
							)
							OR
							(
								r.start_time = s.last_request_start_time
								AND s.last_request_end_time <= sp.last_request_end_time
							)
						)
				) AS y
				'</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'LEFT OUTER HASH JOIN
						(
							SELECT TOP(@i)
								task_nodes.task_node.value(''(session_id/text())[1]'', ''SMALLINT'') AS session_id,
								task_nodes.task_node.value(''(request_id/text())[1]'', ''INT'') AS request_id,
								task_nodes.task_node.value(''(physical_io/text())[1]'', ''BIGINT'') AS physical_io,
								task_nodes.task_node.value(''(context_switches/text())[1]'', ''BIGINT'') AS context_switches,
								task_nodes.task_node.value(''(tasks/text())[1]'', ''INT'') AS tasks,
								task_nodes.task_node.value(''(block_info/text())[1]'', ''NVARCHAR(4000)'') AS block_info,
								task_nodes.task_node.value(''(waits/text())[1]'', ''NVARCHAR(4000)'') AS wait_info,
								task_nodes.task_node.value(''(thread_CPU_snapshot/text())[1]'', ''BIGINT'') AS thread_CPU_snapshot
							FROM
							(
								SELECT TOP(@i)
									CONVERT
									(
										XML,
										REPLACE
										(
											CONVERT(NVARCHAR(MAX), tasks_raw.task_xml_raw) COLLATE Latin1_General_Bin2,
											N''</waits></tasks><tasks><waits>'',
											N'', ''
										)
									) AS task_xml
								FROM
								(
									SELECT TOP(@i)
										CASE waits.r
											WHEN 1 THEN
												waits.session_id
											ELSE
												NULL
										END AS [session_id],
										CASE waits.r
											WHEN 1 THEN
												waits.request_id
											ELSE
												NULL
										END AS [request_id],											
										CASE waits.r
											WHEN 1 THEN
												waits.physical_io
											ELSE
												NULL
										END AS [physical_io],
										CASE waits.r
											WHEN 1 THEN
												waits.context_switches
											ELSE
												NULL
										END AS [context_switches],
										CASE waits.r
											WHEN 1 THEN
												waits.thread_CPU_snapshot
											ELSE
												NULL
										END AS [thread_CPU_snapshot],
										CASE waits.r
											WHEN 1 THEN
												waits.tasks
											ELSE
												NULL
										END AS [tasks],
										CASE waits.r
											WHEN 1 THEN
												waits.block_info
											ELSE
												NULL
										END AS [block_info],
										REPLACE
										(
											REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
											REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
											REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
												CONVERT
												(
													NVARCHAR(MAX),
													N''('' +
														CONVERT(NVARCHAR, num_waits) + N''x: '' +
														CASE num_waits
															WHEN 1 THEN
																CONVERT(NVARCHAR, min_wait_time) + N''ms''
															WHEN 2 THEN
																CASE
																	WHEN min_wait_time <> max_wait_time THEN
																		CONVERT(NVARCHAR, min_wait_time) + N''/'' + CONVERT(NVARCHAR, max_wait_time) + N''ms''
																	ELSE
																		CONVERT(NVARCHAR, max_wait_time) + N''ms''
																END
															ELSE
																CASE
																	WHEN min_wait_time <> max_wait_time THEN
																		CONVERT(NVARCHAR, min_wait_time) + N''/'' + CONVERT(NVARCHAR, avg_wait_time) + N''/'' + CONVERT(NVARCHAR, max_wait_time) + N''ms''
																	ELSE 
																		CONVERT(NVARCHAR, max_wait_time) + N''ms''
																END
														END +
													N'')'' + wait_type COLLATE Latin1_General_Bin2
												),
												NCHAR(31),N''?''),NCHAR(30),N''?''),NCHAR(29),N''?''),NCHAR(28),N''?''),NCHAR(27),N''?''),NCHAR(26),N''?''),NCHAR(25),N''?''),NCHAR(24),N''?''),NCHAR(23),N''?''),NCHAR(22),N''?''),
												NCHAR(21),N''?''),NCHAR(20),N''?''),NCHAR(19),N''?''),NCHAR(18),N''?''),NCHAR(17),N''?''),NCHAR(16),N''?''),NCHAR(15),N''?''),NCHAR(14),N''?''),NCHAR(12),N''?''),
												NCHAR(11),N''?''),NCHAR(8),N''?''),NCHAR(7),N''?''),NCHAR(6),N''?''),NCHAR(5),N''?''),NCHAR(4),N''?''),NCHAR(3),N''?''),NCHAR(2),N''?''),NCHAR(1),N''?''),
											NCHAR(0),
											N''''
										) AS [waits]
									FROM
									(
										SELECT TOP(@i)
											w1.*,
											ROW_NUMBER() OVER
											(
												PARTITION BY
													w1.session_id,
													w1.request_id
												ORDER BY
													w1.block_info DESC,
													w1.num_waits DESC,
													w1.wait_type
											) AS r
										FROM
										(
											SELECT TOP(@i)
												task_info.session_id,
												task_info.request_id,
												task_info.physical_io,
												task_info.context_switches,
												task_info.thread_CPU_snapshot,
												task_info.num_tasks AS tasks,
												CASE
													WHEN task_info.runnable_time IS NOT NULL THEN
														''RUNNABLE''
													ELSE
														wt2.wait_type
												END AS wait_type,
												NULLIF(COUNT(COALESCE(task_info.runnable_time, wt2.waiting_task_address)), 0) AS num_waits,
												MIN(COALESCE(task_info.runnable_time, wt2.wait_duration_ms)) AS min_wait_time,
												AVG(COALESCE(task_info.runnable_time, wt2.wait_duration_ms)) AS avg_wait_time,
												MAX(COALESCE(task_info.runnable_time, wt2.wait_duration_ms)) AS max_wait_time,
												MAX(wt2.block_info) AS block_info
											FROM
											(
												SELECT TOP(@i)
													t.session_id,
													t.request_id,
													SUM(CONVERT(BIGINT, t.pending_io_count)) OVER (PARTITION BY t.session_id, t.request_id) AS physical_io,
													SUM(CONVERT(BIGINT, t.context_switches_count)) OVER (PARTITION BY t.session_id, t.request_id) AS context_switches, 
													'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[CPU_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'SUM(tr.usermode_time + tr.kernel_time) OVER (PARTITION BY t.session_id, t.request_id) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CONVERT(BIGINT, NULL) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">' AS thread_CPU_snapshot, 
													COUNT(*) OVER (PARTITION BY t.session_id, t.request_id) AS num_tasks,
													t.task_address,
													t.task_state,
													CASE
														WHEN
															t.task_state = ''RUNNABLE''
															AND w.runnable_time > 0 THEN
																w.runnable_time
														ELSE
															NULL
													END AS runnable_time
												FROM sys.dm_os_tasks AS t
												CROSS APPLY
												(
													SELECT TOP(1)
														sp2.session_id
													FROM @sessions AS sp2
													WHERE
														sp2.session_id = t.session_id
														AND sp2.request_id = t.request_id
														AND sp2.status <> ''sleeping''
												) AS sp20
												LEFT OUTER HASH JOIN
												(
													SELECT TOP(@i)
														(
															SELECT TOP(@i)
																ms_ticks
															FROM sys.dm_os_sys_info
														) -
															w0.wait_resumed_ms_ticks AS runnable_time,
														w0.worker_address,
														w0.thread_address,
														w0.task_bound_ms_ticks
													FROM sys.dm_os_workers AS w0
													WHERE
														w0.state = ''RUNNABLE''
														OR @first_collection_ms_ticks >= w0.task_bound_ms_ticks
												) AS w ON
													w.worker_address = t.worker_address 
												'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[CPU_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'LEFT OUTER HASH JOIN sys.dm_os_threads AS tr ON
																tr.thread_address = w.thread_address
																AND @first_collection_ms_ticks >= w.task_bound_ms_ticks
															'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">') AS task_info
											LEFT OUTER HASH JOIN
											(
												SELECT TOP(@i)
													wt1.wait_type,
													wt1.waiting_task_address,
													MAX(wt1.wait_duration_ms) AS wait_duration_ms,
													MAX(wt1.block_info) AS block_info
												FROM
												(
													SELECT DISTINCT TOP(@i)
														wt.wait_type +
															CASE
																WHEN wt.wait_type LIKE N''PAGE%LATCH_%'' THEN
																	'':'' +
																	COALESCE(DB_NAME(CONVERT(INT, LEFT(wt.resource_description, CHARINDEX(N'':'', wt.resource_description) - 1))), N''(null)'') +
																	N'':'' +
																	SUBSTRING(wt.resource_description, CHARINDEX(N'':'', wt.resource_description) + 1, LEN(wt.resource_description) - CHARINDEX(N'':'', REVERSE(wt.resource_description)) - CHARINDEX(N'':'', wt.resource_description)) +
																	N''('' +
																		CASE
																			WHEN
																				CONVERT(INT, RIGHT(wt.resource_description, CHARINDEX(N'':'', REVERSE(wt.resource_description)) - 1)) = 1 OR
																				CONVERT(INT, RIGHT(wt.resource_description, CHARINDEX(N'':'', REVERSE(wt.resource_description)) - 1)) % 8088 = 0
																					THEN 
																						N''PFS''
																			WHEN
																				CONVERT(INT, RIGHT(wt.resource_description, CHARINDEX(N'':'', REVERSE(wt.resource_description)) - 1)) = 2 OR
																				CONVERT(INT, RIGHT(wt.resource_description, CHARINDEX(N'':'', REVERSE(wt.resource_description)) - 1)) % 511232 = 0 
																					THEN 
																						N''GAM''
																			WHEN
																				CONVERT(INT, RIGHT(wt.resource_description, CHARINDEX(N'':'', REVERSE(wt.resource_description)) - 1)) = 3 OR
																				(CONVERT(INT, RIGHT(wt.resource_description, CHARINDEX(N'':'', REVERSE(wt.resource_description)) - 1)) - 1) % 511232 = 0 
																					THEN 
																						N''SGAM''
																			WHEN
																				CONVERT(INT, RIGHT(wt.resource_description, CHARINDEX(N'':'', REVERSE(wt.resource_description)) - 1)) = 6 OR
																				(CONVERT(INT, RIGHT(wt.resource_description, CHARINDEX(N'':'', REVERSE(wt.resource_description)) - 1)) - 6) % 511232 = 0 
																					THEN 
																						N''DCM''
																			WHEN
																				CONVERT(INT, RIGHT(wt.resource_description, CHARINDEX(N'':'', REVERSE(wt.resource_description)) - 1)) = 7 OR
																				(CONVERT(INT, RIGHT(wt.resource_description, CHARINDEX(N'':'', REVERSE(wt.resource_description)) - 1)) - 7) % 511232 = 0
																					THEN 
																						N''BCM''
																			ELSE
																				N''*''
																		END +
																	N'')''
																WHEN wt.wait_type = N''CXPACKET'' THEN
																	N'':'' + SUBSTRING(wt.resource_description, CHARINDEX(N''nodeId'', wt.resource_description) + 7, 4)
																WHEN wt.wait_type LIKE N''LATCH[_]%'' THEN
																	N'' ['' + LEFT(wt.resource_description, COALESCE(NULLIF(CHARINDEX(N'' '', wt.resource_description), 0), LEN(wt.resource_description) + 1) - 1) + N'']''
																ELSE 
																	N''''
															END COLLATE Latin1_General_Bin2 AS wait_type,
														CASE
															WHEN
															(
																wt.blocking_session_id IS NOT NULL
																AND wt.wait_type LIKE N''LCK[_]%''
															) THEN
																(
																	SELECT TOP(@i)
																		x.lock_type,
																		REPLACE
																		(
																			REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
																			REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
																			REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
																				DB_NAME
																				(
																					CONVERT
																					(
																						INT,
																						SUBSTRING(wt.resource_description, NULLIF(CHARINDEX(N''dbid='', wt.resource_description), 0) + 5, COALESCE(NULLIF(CHARINDEX(N'' '', wt.resource_description, CHARINDEX(N''dbid='', wt.resource_description) + 5), 0), LEN(wt.resource_description) + 1) - CHARINDEX(N''dbid='', wt.resource_description) - 5)
																					)
																				),
																				NCHAR(31),N''?''),NCHAR(30),N''?''),NCHAR(29),N''?''),NCHAR(28),N''?''),NCHAR(27),N''?''),NCHAR(26),N''?''),NCHAR(25),N''?''),NCHAR(24),N''?''),NCHAR(23),N''?''),NCHAR(22),N''?''),
																				NCHAR(21),N''?''),NCHAR(20),N''?''),NCHAR(19),N''?''),NCHAR(18),N''?''),NCHAR(17),N''?''),NCHAR(16),N''?''),NCHAR(15),N''?''),NCHAR(14),N''?''),NCHAR(12),N''?''),
																				NCHAR(11),N''?''),NCHAR(8),N''?''),NCHAR(7),N''?''),NCHAR(6),N''?''),NCHAR(5),N''?''),NCHAR(4),N''?''),NCHAR(3),N''?''),NCHAR(2),N''?''),NCHAR(1),N''?''),
																			NCHAR(0),
																			N''''
																		) AS database_name,
																		CASE x.lock_type
																			WHEN N''objectlock'' THEN
																				SUBSTRING(wt.resource_description, NULLIF(CHARINDEX(N''objid='', wt.resource_description), 0) + 6, COALESCE(NULLIF(CHARINDEX(N'' '', wt.resource_description, CHARINDEX(N''objid='', wt.resource_description) + 6), 0), LEN(wt.resource_description) + 1) - CHARINDEX(N''objid='', wt.resource_description) - 6)
																			ELSE
																				NULL
																		END AS object_id,
																		CASE x.lock_type
																			WHEN N''filelock'' THEN
																				SUBSTRING(wt.resource_description, NULLIF(CHARINDEX(N''fileid='', wt.resource_description), 0) + 7, COALESCE(NULLIF(CHARINDEX(N'' '', wt.resource_description, CHARINDEX(N''fileid='', wt.resource_description) + 7), 0), LEN(wt.resource_description) + 1) - CHARINDEX(N''fileid='', wt.resource_description) - 7)
																			ELSE
																				NULL
																		END AS file_id,
																		CASE
																			WHEN x.lock_type in (N''pagelock'', N''extentlock'', N''ridlock'') THEN
																				SUBSTRING(wt.resource_description, NULLIF(CHARINDEX(N''associatedObjectId='', wt.resource_description), 0) + 19, COALESCE(NULLIF(CHARINDEX(N'' '', wt.resource_description, CHARINDEX(N''associatedObjectId='', wt.resource_description) + 19), 0), LEN(wt.resource_description) + 1) - CHARINDEX(N''associatedObjectId='', wt.resource_description) - 19)
																			WHEN x.lock_type in (N''keylock'', N''hobtlock'', N''allocunitlock'') THEN
																				SUBSTRING(wt.resource_description, NULLIF(CHARINDEX(N''hobtid='', wt.resource_description), 0) + 7, COALESCE(NULLIF(CHARINDEX(N'' '', wt.resource_description, CHARINDEX(N''hobtid='', wt.resource_description) + 7), 0), LEN(wt.resource_description) + 1) - CHARINDEX(N''hobtid='', wt.resource_description) - 7)
																			ELSE
																				NULL
																		END AS hobt_id,
																		CASE x.lock_type
																			WHEN N''applicationlock'' THEN
																				SUBSTRING(wt.resource_description, NULLIF(CHARINDEX(N''hash='', wt.resource_description), 0) + 5, COALESCE(NULLIF(CHARINDEX(N'' '', wt.resource_description, CHARINDEX(N''hash='', wt.resource_description) + 5), 0), LEN(wt.resource_description) + 1) - CHARINDEX(N''hash='', wt.resource_description) - 5)
																			ELSE
																				NULL
																		END AS applock_hash,
																		CASE x.lock_type
																			WHEN N''metadatalock'' THEN
																				SUBSTRING(wt.resource_description, NULLIF(CHARINDEX(N''subresource='', wt.resource_description), 0) + 12, COALESCE(NULLIF(CHARINDEX(N'' '', wt.resource_description, CHARINDEX(N''subresource='', wt.resource_description) + 12), 0), LEN(wt.resource_description) + 1) - CHARINDEX(N''subresource='', wt.resource_description) - 12)
																			ELSE
																				NULL
																		END AS metadata_resource,
																		CASE x.lock_type
																			WHEN N''metadatalock'' THEN
																				SUBSTRING(wt.resource_description, NULLIF(CHARINDEX(N''classid='', wt.resource_description), 0) + 8, COALESCE(NULLIF(CHARINDEX(N'' dbid='', wt.resource_description) - CHARINDEX(N''classid='', wt.resource_description), 0), LEN(wt.resource_description) + 1) - 8)
																			ELSE
																				NULL
																		END AS metadata_class_id
																	FROM
																	(
																		SELECT TOP(1)
																			LEFT(wt.resource_description, CHARINDEX(N'' '', wt.resource_description) - 1) COLLATE Latin1_General_Bin2 AS lock_type
																	) AS x
																	FOR XML
																		PATH('''')
																)
															ELSE NULL
														END AS block_info,
														wt.wait_duration_ms,
														wt.waiting_task_address
													FROM
													(
														SELECT TOP(@i)
															wt0.wait_type COLLATE Latin1_General_Bin2 AS wait_type,
															wt0.resource_description COLLATE Latin1_General_Bin2 AS resource_description,
															wt0.wait_duration_ms,
															wt0.waiting_task_address,
															CASE
																WHEN wt0.blocking_session_id = p.blocked THEN
																	wt0.blocking_session_id
																ELSE
																	NULL
															END AS blocking_session_id
														FROM sys.dm_os_waiting_tasks AS wt0
														CROSS APPLY
														(
															SELECT TOP(1)
																s0.blocked
															FROM @sessions AS s0
															WHERE
																s0.session_id = wt0.session_id
																AND COALESCE(s0.wait_type, N'''') <> N''OLEDB''
																AND wt0.wait_type <> N''OLEDB''
														) AS p
													) AS wt
												) AS wt1
												GROUP BY
													wt1.wait_type,
													wt1.waiting_task_address
											) AS wt2 ON
												wt2.waiting_task_address = task_info.task_address
												AND wt2.wait_duration_ms > 0
												AND task_info.runnable_time IS NULL
											GROUP BY
												task_info.session_id,
												task_info.request_id,
												task_info.physical_io,
												task_info.context_switches,
												task_info.thread_CPU_snapshot,
												task_info.num_tasks,
												CASE
													WHEN task_info.runnable_time IS NOT NULL THEN
														''RUNNABLE''
													ELSE
														wt2.wait_type
												END
										) AS w1
									) AS waits
									ORDER BY
										waits.session_id,
										waits.request_id,
										waits.r
									FOR XML
										PATH(N''tasks''),
										TYPE
								) AS tasks_raw (task_xml_raw)
							) AS tasks_final
							CROSS APPLY tasks_final.task_xml.nodes(N''/tasks'') AS task_nodes (task_node)
							WHERE
								task_nodes.task_node.exist(N''session_id'') = 1
						) AS tasks ON
							tasks.session_id = y.session_id
							AND tasks.request_id = y.request_id 
						'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'LEFT OUTER HASH JOIN
				(
					SELECT TOP(@i)
						t_info.session_id,
						COALESCE(t_info.request_id, -1) AS request_id,
						SUM(t_info.tempdb_allocations) AS tempdb_allocations,
						SUM(t_info.tempdb_current) AS tempdb_current
					FROM
					(
						SELECT TOP(@i)
							tsu.session_id,
							tsu.request_id,
							tsu.user_objects_alloc_page_count +
								tsu.internal_objects_alloc_page_count AS tempdb_allocations,
							tsu.user_objects_alloc_page_count +
								tsu.internal_objects_alloc_page_count -
								tsu.user_objects_dealloc_page_count -
								tsu.internal_objects_dealloc_page_count AS tempdb_current
						FROM sys.dm_db_task_space_usage AS tsu
						CROSS APPLY
						(
							SELECT TOP(1)
								s0.session_id
							FROM @sessions AS s0
							WHERE
								s0.session_id = tsu.session_id
						) AS p

						UNION ALL

						SELECT TOP(@i)
							ssu.session_id,
							NULL AS request_id,
							ssu.user_objects_alloc_page_count +
								ssu.internal_objects_alloc_page_count AS tempdb_allocations,
							ssu.user_objects_alloc_page_count +
								ssu.internal_objects_alloc_page_count -
								ssu.user_objects_dealloc_page_count -
								ssu.internal_objects_dealloc_page_count AS tempdb_current
						FROM sys.dm_db_session_space_usage AS ssu
						CROSS APPLY
						(
							SELECT TOP(1)
								s0.session_id
							FROM @sessions AS s0
							WHERE
								s0.session_id = ssu.session_id
						) AS p
					) AS t_info
					GROUP BY
						t_info.session_id,
						COALESCE(t_info.request_id, -1)
				) AS tempdb_info ON
					tempdb_info.session_id = y.session_id
					AND tempdb_info.request_id =
						CASE
							WHEN y.status = N''sleeping'' THEN
								-1
							ELSE
								y.request_id
						END
				'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">NOT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@get_avg_time</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">'LEFT OUTER HASH JOIN
						(
							SELECT TOP(@i)
								*
							FROM sys.dm_exec_query_stats
						) AS qs ON
							qs.sql_handle = y.sql_handle
							AND qs.plan_handle = y.plan_handle
							AND qs.statement_start_offset = y.statement_start_offset
							AND qs.statement_end_offset = y.statement_end_offset
						'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<br><font color="#ff0000">') AS x
			OPTION (KEEPFIXED PLAN, OPTIMIZE FOR (@i = 1)); '</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@sql_n</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@last_collection_start</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">GETDATE</font><font color="#808080">(</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#808080">-</font><font color="#000000">1</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@first_collection_ms_ticks</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">ms_ticks</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_os_sys_info</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">INSERT</font>&nbsp;<font color="#008080">#sessions</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">recursion</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">session_number</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">elapsed_time</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">avg_elapsed_time</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">physical_io</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">reads</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">physical_reads</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">writes</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">tempdb_allocations</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">tempdb_current</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CPU</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">thread_CPU_snapshot</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">context_switches</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">used_memory</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">tasks</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">status</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">wait_info</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">transaction_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">open_tran_count</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">sql_handle</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">statement_start_offset</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">statement_end_offset</font><font color="#808080">,</font>&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">sql_text</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">plan_handle</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">blocking_session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">percent_complete</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff00ff">host_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">login_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">database_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">program_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">additional_info</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">start_time</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">login_time</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">last_request_start_time</font><br>&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">EXEC</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@sql_n</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'@recursion SMALLINT, @filter sysname, @not_filter sysname, @first_collection_ms_ticks BIGINT'</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@recursion</font><font color="#808080">,</font>&nbsp;<font color="#008080">@filter</font><font color="#808080">,</font>&nbsp;<font color="#008080">@not_filter</font><font color="#808080">,</font>&nbsp;<font color="#008080">@first_collection_ms_ticks</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--Collect transaction information?</font><br>&nbsp;&nbsp;<font color="#0000ff">IF</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[tran_start_time|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[tran_log_writes|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@i</font>&nbsp;<font color="#0000ff">INT</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@i</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2147483647</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tran_start_time</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">DATETIME</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">LEFT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">trans_info</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">NULLIF</font><font color="#808080">(</font><font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">254</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">trans_info</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#808080">-</font><font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">121</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">tran_log_writes</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">RIGHT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">trans_info</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">x</font><font color="#808080">.</font><font color="#008080">trans_info</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">254</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">trans_info</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#008080">@i</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">trans_nodes</font><font color="#808080">.</font><font color="#008080">trans_node</font><font color="#808080">.</font><font color="#0000ff">value</font><font color="#808080">(</font><font color="#ff0000">'(session_id/text())[1]'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'SMALLINT'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">trans_nodes</font><font color="#808080">.</font><font color="#008080">trans_node</font><font color="#808080">.</font><font color="#0000ff">value</font><font color="#808080">(</font><font color="#ff0000">'(request_id/text())[1]'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'INT'</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">trans_nodes</font><font color="#808080">.</font><font color="#008080">trans_node</font><font color="#808080">.</font><font color="#0000ff">value</font><font color="#808080">(</font><font color="#ff0000">'(trans_info/text())[1]'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'NVARCHAR(4000)'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">trans_info</font>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#008080">@i</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">XML</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">trans_raw</font><font color="#808080">.</font><font color="#008080">trans_xml_raw</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'</trans_info></trans><trans><trans_info>'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#008080">@i</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">u_trans</font><font color="#808080">.</font><font color="#008080">r</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">u_trans</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[session_id]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">u_trans</font><font color="#808080">.</font><font color="#008080">r</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">u_trans</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[request_id]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">u_trans</font><font color="#808080">.</font><font color="#008080">database_id</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">u_trans</font><font color="#808080">.</font><font color="#008080">r</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">NVARCHAR</font><font color="#808080">,</font>&nbsp;<font color="#008080">u_trans</font><font color="#808080">.</font><font color="#008080">transaction_start_time</font><font color="#808080">,</font>&nbsp;<font color="#000000">121</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">254</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N''</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">128</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">DB_NAME</font><font color="#808080">(</font><font color="#008080">u_trans</font><font color="#808080">.</font><font color="#008080">database_id</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'(null)'</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">31</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">30</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">29</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">28</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">27</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">26</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">25</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">24</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">23</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">22</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">21</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">20</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">19</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">18</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">17</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">16</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">15</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">14</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">11</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">8</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">7</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">6</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">5</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">4</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'?'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N': '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">NVARCHAR</font><font color="#808080">,</font>&nbsp;<font color="#008080">u_trans</font><font color="#808080">.</font><font color="#008080">log_record_count</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">N' ('</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">NVARCHAR</font><font color="#808080">,</font>&nbsp;<font color="#008080">u_trans</font><font color="#808080">.</font><font color="#008080">log_kb_used</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">N' kB)'</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N','</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'N/A,'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[trans_info]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#008080">@i</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">trans</font><font color="#808080">.</font><font color="#808080">*</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PARTITION</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">trans</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">trans</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">trans</font><font color="#808080">.</font><font color="#008080">transaction_start_time</font>&nbsp;<font color="#0000ff">DESC</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">r</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#008080">@i</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_tran_map</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_tran_map</font><font color="#808080">.</font><font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s_tran</font><font color="#808080">.</font><font color="#008080">database_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">SUM</font><font color="#808080">(</font><font color="#008080">s_tran</font><font color="#808080">.</font><font color="#008080">database_transaction_log_record_count</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">log_record_count</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#ff00ff">SUM</font><font color="#808080">(</font><font color="#008080">s_tran</font><font color="#808080">.</font><font color="#008080">database_transaction_log_bytes_used</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font>&nbsp;<font color="#808080">/</font>&nbsp;<font color="#000000">1024</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">log_kb_used</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">MIN</font><font color="#808080">(</font><font color="#008080">s_tran</font><font color="#808080">.</font><font color="#008080">database_transaction_begin_time</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">transaction_start_time</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#008080">@i</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">*</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_tran_active_transactions</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">transaction_begin_time</font>&nbsp;<font color="#808080"><</font><font color="#808080">=</font>&nbsp;<font color="#008080">@last_collection_start</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">a_tran</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">INNER</font>&nbsp;<font color="#0000ff">HASH</font>&nbsp;<font color="#808080">JOIN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#008080">@i</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">*</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_tran_database_transactions</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">database_id</font>&nbsp;<font color="#808080"><</font>&nbsp;<font color="#000000">32767</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s_tran</font>&nbsp;<font color="#0000ff">ON</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s_tran</font><font color="#808080">.</font><font color="#008080">transaction_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">a_tran</font><font color="#808080">.</font><font color="#008080">transaction_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">LEFT</font>&nbsp;<font color="#808080">OUTER</font>&nbsp;<font color="#0000ff">HASH</font>&nbsp;<font color="#808080">JOIN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#008080">@i</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">*</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_tran_session_transactions</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">tst</font>&nbsp;<font color="#0000ff">ON</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s_tran</font><font color="#808080">.</font><font color="#008080">transaction_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">tst</font><font color="#808080">.</font><font color="#008080">transaction_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">CROSS</font>&nbsp;<font color="#0000ff">APPLY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s3</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s3</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s1</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s1</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s1</font><font color="#808080">.</font><font color="#008080">transaction_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s_tran</font><font color="#808080">.</font><font color="#008080">transaction_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s1</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s2</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s2</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s2</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">tst</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s2</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s3</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s3</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">session_tran_map</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_tran_map</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_tran_map</font><font color="#808080">.</font><font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s_tran</font><font color="#808080">.</font><font color="#008080">database_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">trans</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">u_trans</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">XML</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PATH</font><font color="#808080">(</font><font color="#ff0000">'trans'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">TYPE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">trans_raw</font>&nbsp;<font color="#808080">(</font><font color="#008080">trans_xml_raw</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">trans_final</font>&nbsp;<font color="#808080">(</font><font color="#008080">trans_xml</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">CROSS</font>&nbsp;<font color="#0000ff">APPLY</font>&nbsp;<font color="#008080">trans_final</font><font color="#808080">.</font><font color="#008080">trans_xml</font><font color="#808080">.</font><font color="#0000ff">nodes</font><font color="#808080">(</font><font color="#ff0000">'/trans'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">trans_nodes</font>&nbsp;<font color="#808080">(</font><font color="#008080">trans_node</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">x</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">INNER</font>&nbsp;<font color="#0000ff">HASH</font>&nbsp;<font color="#808080">JOIN</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font>&nbsp;<font color="#0000ff">ON</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">OPTIMIZE</font>&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#808080">(</font><font color="#008080">@i</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--Variables for text and plan collection</font><br>&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@session_id</font>&nbsp;<font color="#0000ff">SMALLINT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@request_id</font>&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@sql_handle</font>&nbsp;<font color="#0000ff">VARBINARY</font><font color="#808080">(</font><font color="#000000">64</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@plan_handle</font>&nbsp;<font color="#0000ff">VARBINARY</font><font color="#808080">(</font><font color="#000000">64</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_start_offset</font>&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_end_offset</font>&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@start_time</font>&nbsp;<font color="#0000ff">DATETIME</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@database_name</font>&nbsp;<font color="#0000ff">sysname</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[sql_text|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">sql_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CURSOR</font>&nbsp;<font color="#0000ff">LOCAL</font>&nbsp;<font color="#0000ff">FAST_FORWARD</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">sql_handle</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">statement_start_offset</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">statement_end_offset</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">sql_handle</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPEN</font>&nbsp;<font color="#008080">sql_cursor</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">sql_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@sql_handle</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_start_offset</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_end_offset</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#008000">--Wait up to 5 ms for the SQL text, then give up</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">LOCK_TIMEOUT</font>&nbsp;<font color="#000000">5</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHILE</font>&nbsp;<font color="#ff00ff">@@FETCH_STATUS</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">TRY</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">sql_text</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'--'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@get_full_inner_text</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080"><</font>&nbsp;<font color="#808080">(</font><font color="#008080">@statement_end_offset</font>&nbsp;<font color="#808080">/</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">,</font>&nbsp;<font color="#808080">(</font><font color="#008080">@statement_start_offset</font><font color="#808080">/</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">N'[a-zA-Z0-9][a-zA-Z0-9]'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@statement_start_offset</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUBSTRING</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><font color="#808080">(</font><font color="#008080">@statement_start_offset</font><font color="#808080">/</font><font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@statement_end_offset</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#808080">-</font><font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">2147483647</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">(</font><font color="#808080">(</font><font color="#008080">@statement_end_offset</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#008080">@statement_start_offset</font><font color="#808080">)</font><font color="#808080">/</font><font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff00ff">RTRIM</font><font color="#808080">(</font><font color="#ff00ff">LTRIM</font><font color="#808080">(</font><font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">N'--'</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">31</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">30</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">29</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">28</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">27</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">26</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">25</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">24</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">23</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">22</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">21</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">20</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">19</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">18</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">17</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">16</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">15</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">14</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">11</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">8</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">7</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">6</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">5</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">4</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[processing-instruction(query)]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">XML</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PATH</font><font color="#808080">(</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">TYPE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">statement_start_offset</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080"><</font>&nbsp;<font color="#808080">(</font><font color="#008080">@statement_end_offset</font>&nbsp;<font color="#808080">/</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#808080">(</font><font color="#008080">@statement_start_offset</font><font color="#808080">/</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'[a-zA-Z0-9][a-zA-Z0-9]'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#008080">@statement_start_offset</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">statement_end_offset</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font>&nbsp;<font color="#808080"><</font>&nbsp;<font color="#808080">(</font><font color="#008080">@statement_end_offset</font>&nbsp;<font color="#808080">/</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#808080">-</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">est</font><font color="#808080">.</font><font color="#0000ff">text</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#808080">(</font><font color="#008080">@statement_start_offset</font><font color="#808080">/</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'[a-zA-Z0-9][a-zA-Z0-9]'</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#808080">-</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#008080">@statement_end_offset</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">TOP</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">text</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">text</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">row_num</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_sql_text</font><font color="#808080">(</font><font color="#008080">@sql_handle</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">row_num</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">est0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">row_num</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">est</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">TRY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">sql_text</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#ff00ff">ERROR_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1222</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'<timeout_exceeded />'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'<error message="'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'" />'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">sql_cursor</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@sql_handle</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_start_offset</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_end_offset</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#008000">--Return this to the default</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">LOCK_TIMEOUT</font>&nbsp;<font color="#808080">-</font><font color="#000000">1</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CLOSE</font>&nbsp;<font color="#008080">sql_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DEALLOCATE</font>&nbsp;<font color="#008080">sql_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@get_outer_command</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[sql_command|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@buffer_results</font>&nbsp;<font color="#0000ff">TABLE</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">EventType</font>&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">30</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">Parameters</font>&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">EventInfo</font>&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#000000">4000</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">start_time</font>&nbsp;<font color="#0000ff">DATETIME</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_number</font>&nbsp;<font color="#0000ff">INT</font>&nbsp;<font color="#0000ff">IDENTITY</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">,</font><font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">PRIMARY</font>&nbsp;<font color="#0000ff">KEY</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">buffer_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CURSOR</font>&nbsp;<font color="#0000ff">LOCAL</font>&nbsp;<font color="#0000ff">FAST_FORWARD</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">MAX</font><font color="#808080">(</font><font color="#008080">start_time</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">start_time</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPEN</font>&nbsp;<font color="#008080">buffer_cursor</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">buffer_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@start_time</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHILE</font>&nbsp;<font color="#ff00ff">@@FETCH_STATUS</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">TRY</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--In SQL Server 2008, DBCC INPUTBUFFER will throw </font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--an exception if the session no longer exists</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INSERT</font>&nbsp;<font color="#008080">@buffer_results</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">EventType</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">Parameters</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">EventInfo</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">EXEC</font>&nbsp;<font color="#800000">sp_executesql</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'DBCC INPUTBUFFER(@session_id) WITH NO_INFOMSGS;'</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'@session_id SMALLINT'</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@session_id</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">br</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">br</font><font color="#808080">.</font><font color="#008080">start_time</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@start_time</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">@buffer_results</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">br</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">br</font><font color="#808080">.</font><font color="#008080">session_number</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#ff00ff">MAX</font><font color="#808080">(</font><font color="#008080">br2</font><font color="#808080">.</font><font color="#008080">session_number</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">@buffer_results</font>&nbsp;<font color="#008080">br2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">TRY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">CATCH</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">buffer_cursor</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@start_time</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">sql_command</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'--'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#008080">br</font><font color="#808080">.</font><font color="#008080">EventInfo</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">N'--'</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">31</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">30</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">29</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">28</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">27</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">26</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">25</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">24</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">23</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">22</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">21</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">20</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">19</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">18</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">17</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">16</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">15</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">14</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">11</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">8</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">7</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">6</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">5</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">4</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[processing-instruction(query)]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">@buffer_results</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">br</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">br</font><font color="#808080">.</font><font color="#008080">session_number</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_number</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">br</font><font color="#808080">.</font><font color="#008080">start_time</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">start_time</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">start_time</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">last_request_start_time</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#808080">EXISTS</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#808080">*</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_requests</font>&nbsp;<font color="#008080">r2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">r2</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">r2</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">r2</font><font color="#808080">.</font><font color="#008080">start_time</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">start_time</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#808080">EXISTS</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#808080">*</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_sessions</font>&nbsp;<font color="#008080">s2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s2</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s2</font><font color="#808080">.</font><font color="#008080">last_request_start_time</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">last_request_start_time</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">XML</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PATH</font><font color="#808080">(</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">TYPE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CLOSE</font>&nbsp;<font color="#008080">buffer_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DEALLOCATE</font>&nbsp;<font color="#008080">buffer_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@get_plans</font>&nbsp;<font color="#808080">></font><font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[query_plan|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">plan_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CURSOR</font>&nbsp;<font color="#0000ff">LOCAL</font>&nbsp;<font color="#0000ff">FAST_FORWARD</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">plan_handle</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">statement_start_offset</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">statement_end_offset</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">plan_handle</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPEN</font>&nbsp;<font color="#008080">plan_cursor</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">plan_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@plan_handle</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_start_offset</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_end_offset</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#008000">--Wait up to 5 ms for a query plan, then give up</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">LOCK_TIMEOUT</font>&nbsp;<font color="#000000">5</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHILE</font>&nbsp;<font color="#ff00ff">@@FETCH_STATUS</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">TRY</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">query_plan</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">xml</font><font color="#808080">,</font>&nbsp;<font color="#008080">query_plan</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_text_query_plan</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@plan_handle</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@get_plans</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_start_offset</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@get_plans</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_end_offset</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">-</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">TRY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#ff00ff">ERROR_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">6335</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">query_plan</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'--'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'-- Could not render showplan due to XML data type limitations. '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'-- To see the graphical plan save the XML below as a .SQLPLAN file and re-open in SSMS.'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'--'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#008080">qp</font><font color="#808080">.</font><font color="#008080">query_plan</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'<RelOp'</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font><font color="#808080">+</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font><font color="#808080">+</font><font color="#ff0000">N'<RelOp'</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">13</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">10</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">N'--'</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[processing-instruction(query_plan)]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_text_query_plan</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@plan_handle</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@get_plans</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_start_offset</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@get_plans</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_end_offset</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">-</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">qp</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">XML</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PATH</font><font color="#808080">(</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">TYPE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">query_plan</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#ff00ff">ERROR_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1222</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'<timeout_exceeded />'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'<error message="'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'" />'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">plan_cursor</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@plan_handle</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_start_offset</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@statement_end_offset</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#008000">--Return this to the default</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">LOCK_TIMEOUT</font>&nbsp;<font color="#808080">-</font><font color="#000000">1</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CLOSE</font>&nbsp;<font color="#008080">plan_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DEALLOCATE</font>&nbsp;<font color="#008080">plan_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@get_locks</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[locks|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">locks_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CURSOR</font>&nbsp;<font color="#0000ff">LOCAL</font>&nbsp;<font color="#0000ff">FAST_FORWARD</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">DISTINCT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">database_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#locks</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">EXISTS</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#808080">*</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">#locks</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#0000ff">database_name</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff0000">'(null)'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPEN</font>&nbsp;<font color="#008080">locks_cursor</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">locks_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@database_name</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHILE</font>&nbsp;<font color="#ff00ff">@@FETCH_STATUS</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">TRY</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@sql_n</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'UPDATE l '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'SET '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'object_name = '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'o.name COLLATE Latin1_General_Bin2, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(31),N''?''),NCHAR(30),N''?''),NCHAR(29),N''?''),NCHAR(28),N''?''),NCHAR(27),N''?''),NCHAR(26),N''?''),NCHAR(25),N''?''),NCHAR(24),N''?''),NCHAR(23),N''?''),NCHAR(22),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(21),N''?''),NCHAR(20),N''?''),NCHAR(19),N''?''),NCHAR(18),N''?''),NCHAR(17),N''?''),NCHAR(16),N''?''),NCHAR(15),N''?''),NCHAR(14),N''?''),NCHAR(12),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(11),N''?''),NCHAR(8),N''?''),NCHAR(7),N''?''),NCHAR(6),N''?''),NCHAR(5),N''?''),NCHAR(4),N''?''),NCHAR(3),N''?''),NCHAR(2),N''?''),NCHAR(1),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(0), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''''' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'index_name = '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'i.name COLLATE Latin1_General_Bin2, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(31),N''?''),NCHAR(30),N''?''),NCHAR(29),N''?''),NCHAR(28),N''?''),NCHAR(27),N''?''),NCHAR(26),N''?''),NCHAR(25),N''?''),NCHAR(24),N''?''),NCHAR(23),N''?''),NCHAR(22),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(21),N''?''),NCHAR(20),N''?''),NCHAR(19),N''?''),NCHAR(18),N''?''),NCHAR(17),N''?''),NCHAR(16),N''?''),NCHAR(15),N''?''),NCHAR(14),N''?''),NCHAR(12),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(11),N''?''),NCHAR(8),N''?''),NCHAR(7),N''?''),NCHAR(6),N''?''),NCHAR(5),N''?''),NCHAR(4),N''?''),NCHAR(3),N''?''),NCHAR(2),N''?''),NCHAR(1),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(0), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''''' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'schema_name = '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'s.name COLLATE Latin1_General_Bin2, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(31),N''?''),NCHAR(30),N''?''),NCHAR(29),N''?''),NCHAR(28),N''?''),NCHAR(27),N''?''),NCHAR(26),N''?''),NCHAR(25),N''?''),NCHAR(24),N''?''),NCHAR(23),N''?''),NCHAR(22),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(21),N''?''),NCHAR(20),N''?''),NCHAR(19),N''?''),NCHAR(18),N''?''),NCHAR(17),N''?''),NCHAR(16),N''?''),NCHAR(15),N''?''),NCHAR(14),N''?''),NCHAR(12),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(11),N''?''),NCHAR(8),N''?''),NCHAR(7),N''?''),NCHAR(6),N''?''),NCHAR(5),N''?''),NCHAR(4),N''?''),NCHAR(3),N''?''),NCHAR(2),N''?''),NCHAR(1),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(0), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''''' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'principal_name = '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'dp.name COLLATE Latin1_General_Bin2, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(31),N''?''),NCHAR(30),N''?''),NCHAR(29),N''?''),NCHAR(28),N''?''),NCHAR(27),N''?''),NCHAR(26),N''?''),NCHAR(25),N''?''),NCHAR(24),N''?''),NCHAR(23),N''?''),NCHAR(22),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(21),N''?''),NCHAR(20),N''?''),NCHAR(19),N''?''),NCHAR(18),N''?''),NCHAR(17),N''?''),NCHAR(16),N''?''),NCHAR(15),N''?''),NCHAR(14),N''?''),NCHAR(12),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(11),N''?''),NCHAR(8),N''?''),NCHAR(7),N''?''),NCHAR(6),N''?''),NCHAR(5),N''?''),NCHAR(4),N''?''),NCHAR(3),N''?''),NCHAR(2),N''?''),NCHAR(1),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(0), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''''' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'FROM #locks AS l '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT OUTER JOIN '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#008080">@database_name</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.sys.allocation_units AS au ON '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'au.allocation_unit_id = l.allocation_unit_id '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT OUTER JOIN '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#008080">@database_name</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.sys.partitions AS p ON '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'p.hobt_id = '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'COALESCE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'l.hobt_id, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN au.type IN (1, 3) THEN au.container_id '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT OUTER JOIN '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#008080">@database_name</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.sys.partitions AS p1 ON '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'l.hobt_id IS NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND au.type = 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND p1.partition_id = au.container_id '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT OUTER JOIN '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#008080">@database_name</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.sys.objects AS o ON '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'o.object_id = COALESCE(l.object_id, p.object_id, p1.object_id) '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT OUTER JOIN '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#008080">@database_name</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.sys.indexes AS i ON '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'i.object_id = COALESCE(l.object_id, p.object_id, p1.object_id) '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND i.index_id = COALESCE(l.index_id, p.index_id, p1.index_id) '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT OUTER JOIN '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#008080">@database_name</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.sys.schemas AS s ON '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'s.schema_id = COALESCE(l.schema_id, o.schema_id) '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT OUTER JOIN '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#008080">@database_name</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.sys.database_principals AS dp ON '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'dp.principal_id = l.principal_id '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHERE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'l.database_name = @database_name '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'OPTION (KEEPFIXED PLAN); '</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">EXEC</font>&nbsp;<font color="#800000">sp_executesql</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@sql_n</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'@database_name sysname'</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@database_name</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">TRY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">#locks</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">query_error</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">31</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">30</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">29</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">28</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">27</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">26</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">25</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">24</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">23</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">22</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">21</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">20</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">19</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">18</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">17</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">16</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">15</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">14</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">11</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">8</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">7</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">6</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">5</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">4</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">database_name</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@database_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">locks_cursor</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@database_name</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CLOSE</font>&nbsp;<font color="#008080">locks_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DEALLOCATE</font>&nbsp;<font color="#008080">locks_cursor</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">CLUSTERED</font>&nbsp;<font color="#0000ff">INDEX</font>&nbsp;<font color="#008080">IX_SRD</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#808080">(</font><font color="#008080">session_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">database_name</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">locks</font>&nbsp;<font color="#808080">=</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#0000ff">database_name</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">31</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">30</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">29</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">28</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">27</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">26</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">25</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">24</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">23</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">22</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">21</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">20</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">19</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">18</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">17</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">16</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">15</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">14</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">11</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">8</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">7</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">6</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">5</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">4</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Database/@name]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">MIN</font><font color="#808080">(</font><font color="#008080">l1</font><font color="#808080">.</font><font color="#008080">query_error</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Database/@query_error]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l2</font><font color="#808080">.</font><font color="#008080">request_mode</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@request_mode]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l2</font><font color="#808080">.</font><font color="#008080">request_status</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@request_status]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COUNT</font><font color="#808080">(</font><font color="#808080">*</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@request_count]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">l2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">l2</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">l2</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l2</font><font color="#808080">.</font><font color="#0000ff">database_name</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#0000ff">database_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l2</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">'DATABASE'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l2</font><font color="#808080">.</font><font color="#008080">request_mode</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l2</font><font color="#808080">.</font><font color="#008080">request_status</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">XML</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PATH</font><font color="#808080">(</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">TYPE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Database/Locks]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">l3</font><font color="#808080">.</font><font color="#ff00ff">object_name</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'(null)'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Object/@name]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#ff00ff">schema_name</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Object/@schema_name]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@resource_type]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">page_type</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@page_type]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">index_name</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@index_name]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#ff00ff">object_name</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#ff00ff">schema_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@schema_name]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">principal_name</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@principal_name]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">resource_description</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@resource_description]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">request_mode</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@request_mode]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">request_status</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@request_status]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">SUM</font><font color="#808080">(</font><font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">request_count</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Lock/@request_count]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">l4</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#0000ff">database_name</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#0000ff">database_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">l3</font><font color="#808080">.</font><font color="#ff00ff">object_name</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'(null)'</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">l4</font><font color="#808080">.</font><font color="#ff00ff">object_name</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'(null)'</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">l3</font><font color="#808080">.</font><font color="#ff00ff">schema_name</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">l4</font><font color="#808080">.</font><font color="#ff00ff">schema_name</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff0000">'DATABASE'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">resource_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">page_type</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">index_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#ff00ff">object_name</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#ff00ff">schema_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">principal_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">resource_description</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">request_mode</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l4</font><font color="#808080">.</font><font color="#008080">request_status</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">XML</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PATH</font><font color="#808080">(</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">TYPE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Object/Locks]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">l3</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#0000ff">database_name</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#0000ff">database_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#008080">resource_type</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff0000">'DATABASE'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#0000ff">database_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COALESCE</font><font color="#808080">(</font><font color="#008080">l3</font><font color="#808080">.</font><font color="#ff00ff">object_name</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'(null)'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l3</font><font color="#808080">.</font><font color="#ff00ff">schema_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">XML</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PATH</font><font color="#808080">(</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">TYPE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Database/Objects]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#locks</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">l1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#008080">start_time</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#008080">s</font><font color="#808080">.</font><font color="#008080">start_time</font><font color="#808080">,</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">last_request_start_time</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">l1</font><font color="#808080">.</font><font color="#0000ff">database_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">XML</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PATH</font><font color="#808080">(</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">TYPE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@find_block_leaders</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[blocked_session_count|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">blockers</font>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">top_level_session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">8000</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'.'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">8000</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">session_id</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">the_path</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font>&nbsp;<font color="#808080">ALL</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">top_level_session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">8000</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">the_path</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">8000</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">the_path</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#0000ff">blockers</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">JOIN</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font>&nbsp;<font color="#0000ff">ON</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">blocking_session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">the_path</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%.'</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#000000">8000</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.%'</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">blocked_session_count</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">blocked_session_count</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">JOIN</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">top_level_session_id</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">COUNT</font><font color="#808080">(</font><font color="#808080">*</font><font color="#808080">)</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">blocked_session_count</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#0000ff">blockers</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">top_level_session_id</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#008080">x</font>&nbsp;<font color="#0000ff">ON</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">x</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">IF</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@get_task_info</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">2</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[additional_info|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">TABLE</font>&nbsp;<font color="#008080">#blocked_requests</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font>&nbsp;<font color="#0000ff">SMALLINT</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">request_id</font>&nbsp;<font color="#0000ff">INT</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">database_name</font>&nbsp;<font color="#0000ff">sysname</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">object_id</font>&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">hobt_id</font>&nbsp;<font color="#0000ff">BIGINT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">schema_id</font>&nbsp;<font color="#0000ff">INT</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">schema_name</font>&nbsp;<font color="#0000ff">sysname</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">object_name</font>&nbsp;<font color="#0000ff">sysname</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">query_error</font>&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#000000">2048</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PRIMARY</font>&nbsp;<font color="#0000ff">KEY</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">database_name</font><font color="#808080">,</font>&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font>&nbsp;<font color="#008080">request_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_database_name</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#blocked_requests</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">database_name</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_schema_name</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#blocked_requests</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">schema_name</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_object_name</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#blocked_requests</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">object_name</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#0000ff">STATISTICS</font>&nbsp;<font color="#008080">s_query_error</font>&nbsp;<font color="#0000ff">ON</font>&nbsp;<font color="#008080">#blocked_requests</font>&nbsp;<font color="#808080">(</font><font color="#008080">query_error</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#0000ff">SAMPLE</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">ROWS</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">NORECOMPUTE</font><font color="#808080">;</font><br>&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">INSERT</font>&nbsp;<font color="#008080">#blocked_requests</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">database_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">object_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">hobt_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">schema_id</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">database_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">object_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">hobt_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">INT</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">schema_node</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">CHARINDEX</font><font color="#808080">(</font><font color="#ff0000">' = '</font><font color="#808080">,</font>&nbsp;<font color="#008080">schema_node</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#000000">3</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">LEN</font><font color="#808080">(</font><font color="#008080">schema_node</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#ff00ff">schema_id</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">request_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">agent_nodes</font><font color="#808080">.</font><font color="#008080">agent_node</font><font color="#808080">.</font><font color="#0000ff">value</font><font color="#808080">(</font><font color="#ff0000">'(database_name/text())[1]'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'sysname'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#0000ff">database_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">agent_nodes</font><font color="#808080">.</font><font color="#008080">agent_node</font><font color="#808080">.</font><font color="#0000ff">value</font><font color="#808080">(</font><font color="#ff0000">'(object_id/text())[1]'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'int'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#ff00ff">object_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">agent_nodes</font><font color="#808080">.</font><font color="#008080">agent_node</font><font color="#808080">.</font><font color="#0000ff">value</font><font color="#808080">(</font><font color="#ff0000">'(hobt_id/text())[1]'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'bigint'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">hobt_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">agent_nodes</font><font color="#808080">.</font><font color="#008080">agent_node</font><font color="#808080">.</font><font color="#0000ff">value</font><font color="#808080">(</font><font color="#ff0000">'(metadata_resource/text()[.="SCHEMA"]/../../metadata_class_id/text())[1]'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'varchar(100)'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">schema_node</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">CROSS</font>&nbsp;<font color="#0000ff">APPLY</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">additional_info</font><font color="#808080">.</font><font color="#0000ff">nodes</font><font color="#808080">(</font><font color="#ff0000">'//block_info'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">agent_nodes</font>&nbsp;<font color="#808080">(</font><font color="#008080">agent_node</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#0000ff">t</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#0000ff">database_name</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#ff00ff">object_id</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#008080">hobt_id</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#0000ff">t</font><font color="#808080">.</font><font color="#008080">schema_node</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">blocks_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CURSOR</font>&nbsp;<font color="#0000ff">LOCAL</font>&nbsp;<font color="#0000ff">FAST_FORWARD</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#0000ff">DISTINCT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">database_name</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#blocked_requests</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPEN</font>&nbsp;<font color="#008080">blocks_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">blocks_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@database_name</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHILE</font>&nbsp;<font color="#ff00ff">@@FETCH_STATUS</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">TRY</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@sql_n</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'UPDATE b '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'SET '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'b.schema_name = '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'s.name COLLATE Latin1_General_Bin2, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(31),N''?''),NCHAR(30),N''?''),NCHAR(29),N''?''),NCHAR(28),N''?''),NCHAR(27),N''?''),NCHAR(26),N''?''),NCHAR(25),N''?''),NCHAR(24),N''?''),NCHAR(23),N''?''),NCHAR(22),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(21),N''?''),NCHAR(20),N''?''),NCHAR(19),N''?''),NCHAR(18),N''?''),NCHAR(17),N''?''),NCHAR(16),N''?''),NCHAR(15),N''?''),NCHAR(14),N''?''),NCHAR(12),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(11),N''?''),NCHAR(8),N''?''),NCHAR(7),N''?''),NCHAR(6),N''?''),NCHAR(5),N''?''),NCHAR(4),N''?''),NCHAR(3),N''?''),NCHAR(2),N''?''),NCHAR(1),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(0), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''''' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'b.object_name = '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'o.name COLLATE Latin1_General_Bin2, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(31),N''?''),NCHAR(30),N''?''),NCHAR(29),N''?''),NCHAR(28),N''?''),NCHAR(27),N''?''),NCHAR(26),N''?''),NCHAR(25),N''?''),NCHAR(24),N''?''),NCHAR(23),N''?''),NCHAR(22),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(21),N''?''),NCHAR(20),N''?''),NCHAR(19),N''?''),NCHAR(18),N''?''),NCHAR(17),N''?''),NCHAR(16),N''?''),NCHAR(15),N''?''),NCHAR(14),N''?''),NCHAR(12),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(11),N''?''),NCHAR(8),N''?''),NCHAR(7),N''?''),NCHAR(6),N''?''),NCHAR(5),N''?''),NCHAR(4),N''?''),NCHAR(3),N''?''),NCHAR(2),N''?''),NCHAR(1),N''?''), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NCHAR(0), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''''' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'FROM #blocked_requests AS b '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT OUTER JOIN '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#008080">@database_name</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.sys.partitions AS p ON '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'p.hobt_id = b.hobt_id '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT OUTER JOIN '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#008080">@database_name</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.sys.objects AS o ON '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'o.object_id = COALESCE(p.object_id, b.object_id) '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT OUTER JOIN '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff00ff">QUOTENAME</font><font color="#808080">(</font><font color="#008080">@database_name</font><font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'.sys.schemas AS s ON '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'s.schema_id = COALESCE(o.schema_id, b.schema_id) '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHERE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'b.database_name = @database_name; '</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">EXEC</font>&nbsp;<font color="#800000">sp_executesql</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@sql_n</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'@database_name sysname'</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@database_name</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">TRY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">#blocked_requests</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">query_error</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">COLLATE</font>&nbsp;<font color="#008080">Latin1_General_Bin2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">31</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">30</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">29</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">28</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">27</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">26</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">25</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">24</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">23</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">22</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">21</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">20</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">19</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">18</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">17</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">16</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">15</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">14</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">11</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">8</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">7</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">6</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">5</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">4</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">database_name</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@database_name</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">blocks_cursor</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@database_name</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CLOSE</font>&nbsp;<font color="#008080">blocks_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DEALLOCATE</font>&nbsp;<font color="#008080">blocks_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">additional_info</font><font color="#808080">.</font><font color="#0000ff">modify</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br><font color="#ff0000">'
					insert <schema_name>{sql:column("b.schema_name")}</schema_name>
					as last
					into (/additional_info/block_info)[1]
				'</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">INNER</font>&nbsp;<font color="#808080">JOIN</font>&nbsp;<font color="#008080">#blocked_requests</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font>&nbsp;<font color="#0000ff">ON</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#ff00ff">schema_name</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">additional_info</font><font color="#808080">.</font><font color="#0000ff">modify</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br><font color="#ff0000">'
					insert <object_name>{sql:column("b.object_name")}</object_name>
					as last
					into (/additional_info/block_info)[1]
				'</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">INNER</font>&nbsp;<font color="#808080">JOIN</font>&nbsp;<font color="#008080">#blocked_requests</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font>&nbsp;<font color="#0000ff">ON</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#ff00ff">object_name</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">additional_info</font><font color="#808080">.</font><font color="#0000ff">modify</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br><font color="#ff0000">'
					insert <query_error>{sql:column("b.query_error")}</query_error>
					as last
					into (/additional_info/block_info)[1]
				'</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">INNER</font>&nbsp;<font color="#808080">JOIN</font>&nbsp;<font color="#008080">#blocked_requests</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">b</font>&nbsp;<font color="#0000ff">ON</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">request_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">request_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#008080">query_error</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">IF</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[program_name|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|[additional_info|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@job_id</font>&nbsp;<font color="#0000ff">UNIQUEIDENTIFIER</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@step_id</font>&nbsp;<font color="#0000ff">INT</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">agent_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CURSOR</font>&nbsp;<font color="#0000ff">LOCAL</font>&nbsp;<font color="#0000ff">FAST_FORWARD</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FOR</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">agent_nodes</font><font color="#808080">.</font><font color="#008080">agent_node</font><font color="#808080">.</font><font color="#0000ff">value</font><font color="#808080">(</font><font color="#ff0000">'(job_id/text())[1]'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'uniqueidentifier'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">job_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">agent_nodes</font><font color="#808080">.</font><font color="#008080">agent_node</font><font color="#808080">.</font><font color="#0000ff">value</font><font color="#808080">(</font><font color="#ff0000">'(step_id/text())[1]'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'int'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">step_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">CROSS</font>&nbsp;<font color="#0000ff">APPLY</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">additional_info</font><font color="#808080">.</font><font color="#0000ff">nodes</font><font color="#808080">(</font><font color="#ff0000">'//agent_job_info'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">agent_nodes</font>&nbsp;<font color="#808080">(</font><font color="#008080">agent_node</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPEN</font>&nbsp;<font color="#008080">agent_cursor</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">agent_cursor</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@job_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@step_id</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHILE</font>&nbsp;<font color="#ff00ff">@@FETCH_STATUS</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">TRY</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@job_name</font>&nbsp;<font color="#0000ff">sysname</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@job_name</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@step_name</font>&nbsp;<font color="#0000ff">sysname</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@step_name</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@job_name</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">j</font><font color="#808080">.</font><font color="#0000ff">name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">31</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">30</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">29</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">28</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">27</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">26</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">25</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">24</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">23</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">22</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">21</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">20</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">19</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">18</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">17</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">16</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">15</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">14</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">11</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">8</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">7</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">6</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">5</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">4</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'?'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@step_name</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><font color="#ff00ff">REPLACE</font><font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">step_name</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">31</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">30</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">29</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">28</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">27</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">26</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">25</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">24</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">23</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">22</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">21</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">20</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">19</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">18</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">17</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">16</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">15</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">14</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">11</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">8</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">7</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">6</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">5</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">4</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">N'?'</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">NCHAR</font><font color="#808080">(</font><font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">N'?'</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">msdb</font><font color="#808080">.</font><font color="#008000">dbo</font><font color="#808080">.</font><font color="#008080">sysjobs</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">j</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">INNER</font>&nbsp;<font color="#808080">JOIN</font>&nbsp;<font color="#008080">msdb</font><font color="#808080">.</font><font color="#808080">.</font><font color="#008080">sysjobsteps</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font>&nbsp;<font color="#0000ff">ON</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">j</font><font color="#808080">.</font><font color="#008080">job_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">job_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">j</font><font color="#808080">.</font><font color="#008080">job_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@job_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">step_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@step_id</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#008080">@job_name</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">additional_info</font><font color="#808080">.</font><font color="#0000ff">modify</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br><font color="#ff0000">'
								insert text{sql:variable("@job_name")}
								into (/additional_info/agent_job_info/job_name)[1]
							'</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">additional_info</font><font color="#808080">.</font><font color="#0000ff">modify</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br><font color="#ff0000">'
								insert text{sql:variable("@step_name")}
								into (/additional_info/agent_job_info/step_name)[1]
							'</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">TRY</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">BEGIN</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@msdb_error_message</font>&nbsp;<font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#000000">256</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@msdb_error_message</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font><font color="#808080">(</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">UPDATE</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">additional_info</font><font color="#808080">.</font><font color="#0000ff">modify</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><br><font color="#ff0000">'
							insert <msdb_query_error>{sql:variable("@msdb_error_message")}</msdb_query_error>
							as last
							into (/additional_info/agent_job_info)[1]
						'</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">#sessions</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">s</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">session_id</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#008080">@session_id</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">s</font><font color="#808080">.</font><font color="#008080">recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">KEEPFIXED</font>&nbsp;<font color="#0000ff">PLAN</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">CATCH</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">agent_cursor</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">INTO</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@session_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@job_id</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@step_id</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CLOSE</font>&nbsp;<font color="#008080">agent_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DEALLOCATE</font>&nbsp;<font color="#008080">agent_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font>&nbsp;<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@delta_interval</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">1</font><br>&nbsp;&nbsp;<font color="#0000ff">BEGIN</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@recursion</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">1</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@delay_time</font>&nbsp;<font color="#0000ff">CHAR</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@delay_time</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">VARCHAR</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">DATEADD</font><font color="#808080">(</font><font color="#ff00ff">second</font><font color="#808080">,</font>&nbsp;<font color="#008080">@delta_interval</font><font color="#808080">,</font>&nbsp;<font color="#000000">0</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#000000">114</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WAITFOR</font>&nbsp;<font color="#0000ff">DELAY</font>&nbsp;<font color="#008080">@delay_time</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">GOTO</font>&nbsp;<font color="#008080">REDO</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@sql</font>&nbsp;<font color="#808080">=</font>&nbsp;<br>&nbsp;&nbsp;<font color="#008000">--Outer column list</font><br>&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@destination_table</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#ff0000">''</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">@return_schema</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'INSERT '</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#008080">@destination_table</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">' '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff0000">'SELECT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@return_schema</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'INTO #session_schema '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;<font color="#008000">--End outer column list</font><br>&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;<font color="#008000">--Inner column list</font><br>&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff0000">'FROM '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'SELECT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'session_id, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--[dd hh:mm:ss.mss]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@format_output</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN elapsed_time < 0 THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'RIGHT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLICATE(''0'', max_elapsed_length) + CONVERT(VARCHAR, (-1 * elapsed_time) / 86400), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'max_elapsed_length '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'RIGHT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, DATEADD(second, (-1 * elapsed_time), 0), 120), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'9 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'''.000'' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'RIGHT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'REPLICATE(''0'', max_elapsed_length) + CONVERT(VARCHAR, elapsed_time / 86400000), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'max_elapsed_length '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'RIGHT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, DATEADD(second, elapsed_time / 1000, 0), 120), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'9 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'''.'' + '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'RIGHT(''000'' + CONVERT(VARCHAR, elapsed_time % 1000), 3) '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS [dd hh:mm:ss.mss], '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--[dd hh:mm:ss.mss (avg)] / avg_elapsed_time</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;&nbsp;<font color="#008080">@format_output</font>&nbsp;<font color="#808080">IN</font>&nbsp;<font color="#808080">(</font><font color="#000000">1</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'RIGHT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'''00'' + CONVERT(VARCHAR, avg_elapsed_time / 86400000), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'RIGHT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, DATEADD(second, avg_elapsed_time / 1000, 0), 120), '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'9 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'''.'' + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'RIGHT(''000'' + CONVERT(VARCHAR, avg_elapsed_time % 1000), 3) AS [dd hh:mm:ss.mss (avg)], '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'avg_elapsed_time, '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--physical_io</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, physical_io))) OVER() - LEN(CONVERT(VARCHAR, physical_io))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, physical_io), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, physical_io), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'physical_io, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--reads</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, reads))) OVER() - LEN(CONVERT(VARCHAR, reads))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, reads), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, reads), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'reads, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--physical_reads</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, physical_reads))) OVER() - LEN(CONVERT(VARCHAR, physical_reads))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, physical_reads), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, physical_reads), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'physical_reads, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--writes</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, writes))) OVER() - LEN(CONVERT(VARCHAR, writes))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, writes), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, writes), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'writes, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--tempdb_allocations</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, tempdb_allocations))) OVER() - LEN(CONVERT(VARCHAR, tempdb_allocations))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, tempdb_allocations), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, tempdb_allocations), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'tempdb_allocations, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--tempdb_current</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, tempdb_current))) OVER() - LEN(CONVERT(VARCHAR, tempdb_current))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, tempdb_current), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, tempdb_current), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'tempdb_current, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--CPU</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, CPU))) OVER() - LEN(CONVERT(VARCHAR, CPU))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, CPU), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, CPU), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'CPU, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--context_switches</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, context_switches))) OVER() - LEN(CONVERT(VARCHAR, context_switches))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, context_switches), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, context_switches), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'context_switches, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--used_memory</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, used_memory))) OVER() - LEN(CONVERT(VARCHAR, used_memory))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, used_memory), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, used_memory), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'used_memory, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--physical_io_delta			</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'first_request_start_time = last_request_start_time '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND num_events = 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND physical_io_delta >= 0 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, physical_io_delta))) OVER() - LEN(CONVERT(VARCHAR, physical_io_delta))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, physical_io_delta), 1), 19)) '</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, physical_io_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'physical_io_delta '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS physical_io_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--reads_delta</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'first_request_start_time = last_request_start_time '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND num_events = 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND reads_delta >= 0 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, reads_delta))) OVER() - LEN(CONVERT(VARCHAR, reads_delta))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, reads_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, reads_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'reads_delta '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS reads_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--physical_reads_delta</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'first_request_start_time = last_request_start_time '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND num_events = 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND physical_reads_delta >= 0 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, physical_reads_delta))) OVER() - LEN(CONVERT(VARCHAR, physical_reads_delta))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, physical_reads_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, physical_reads_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'physical_reads_delta '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS physical_reads_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--writes_delta</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'first_request_start_time = last_request_start_time '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND num_events = 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND writes_delta >= 0 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, writes_delta))) OVER() - LEN(CONVERT(VARCHAR, writes_delta))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, writes_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, writes_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'writes_delta '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS writes_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--tempdb_allocations_delta</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'first_request_start_time = last_request_start_time '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND num_events = 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND tempdb_allocations_delta >= 0 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, tempdb_allocations_delta))) OVER() - LEN(CONVERT(VARCHAR, tempdb_allocations_delta))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, tempdb_allocations_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, tempdb_allocations_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'tempdb_allocations_delta '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS tempdb_allocations_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--tempdb_current_delta</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--this is the only one that can (legitimately) go negative </font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'first_request_start_time = last_request_start_time '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND num_events = 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, tempdb_current_delta))) OVER() - LEN(CONVERT(VARCHAR, tempdb_current_delta))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, tempdb_current_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, tempdb_current_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'tempdb_current_delta '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS tempdb_current_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--CPU_delta</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'first_request_start_time = last_request_start_time '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND num_events = 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'thread_CPU_delta > CPU_delta '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND thread_CPU_delta > 0 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, thread_CPU_delta + CPU_delta))) OVER() - LEN(CONVERT(VARCHAR, thread_CPU_delta))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, thread_CPU_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, thread_CPU_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'thread_CPU_delta '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN CPU_delta >= 0 THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, thread_CPU_delta + CPU_delta))) OVER() - LEN(CONVERT(VARCHAR, CPU_delta))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, CPU_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, CPU_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'CPU_delta '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS CPU_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--context_switches_delta</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'first_request_start_time = last_request_start_time '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND num_events = 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND context_switches_delta >= 0 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, context_switches_delta))) OVER() - LEN(CONVERT(VARCHAR, context_switches_delta))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, context_switches_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, context_switches_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'context_switches_delta '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS context_switches_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--used_memory_delta</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'first_request_start_time = last_request_start_time '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND num_events = 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'AND used_memory_delta >= 0 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, used_memory_delta))) OVER() - LEN(CONVERT(VARCHAR, used_memory_delta))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, used_memory_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, used_memory_delta), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">'used_memory_delta '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS used_memory_delta, '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--tasks</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, tasks))) OVER() - LEN(CONVERT(VARCHAR, tasks))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, tasks), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, tasks), 1), 19)) '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'tasks, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'status, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'wait_info, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'locks, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'tran_start_time, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEFT(tran_log_writes, LEN(tran_log_writes) - 1) AS tran_log_writes, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--open_tran_count</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, open_tran_count))) OVER() - LEN(CONVERT(VARCHAR, open_tran_count))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, open_tran_count), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, open_tran_count), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'open_tran_count, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--sql_command</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'REPLACE(REPLACE(CONVERT(NVARCHAR(MAX), sql_command), ''<?query --''+CHAR(13)+CHAR(10), ''''), CHAR(13)+CHAR(10)+''--?>'', '''') AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'sql_command, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--sql_text</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'REPLACE(REPLACE(CONVERT(NVARCHAR(MAX), sql_text), ''<?query --''+CHAR(13)+CHAR(10), ''''), CHAR(13)+CHAR(10)+''--?>'', '''') AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'sql_text, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'query_plan, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'blocking_session_id, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--blocked_session_count</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, blocked_session_count))) OVER() - LEN(CONVERT(VARCHAR, blocked_session_count))) + LEFT(CONVERT(CHAR(22), CONVERT(MONEY, blocked_session_count), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, LEFT(CONVERT(CHAR(22), CONVERT(MONEY, blocked_session_count), 1), 19)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'blocked_session_count, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--percent_complete</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@format_output</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, SPACE(MAX(LEN(CONVERT(VARCHAR, CONVERT(MONEY, percent_complete), 2))) OVER() - LEN(CONVERT(VARCHAR, CONVERT(MONEY, percent_complete), 2))) + CONVERT(CHAR(22), CONVERT(MONEY, percent_complete), 2)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">2</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'CONVERT(VARCHAR, CONVERT(CHAR(22), CONVERT(MONEY, blocked_session_count), 1)) AS '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font>&nbsp;<font color="#ff0000">'percent_complete, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'host_name, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'login_name, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'database_name, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'program_name, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'additional_info, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'start_time, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'login_time, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN status = N''sleeping'' THEN NULL '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE request_id '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS request_id, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'GETDATE() AS collection_time '</font><br>&nbsp;&nbsp;<font color="#008000">--End inner column list</font><br>&nbsp;&nbsp;<font color="#808080">)</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;<font color="#008000">--Derived table and INSERT specification</font><br>&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><br>&nbsp;&nbsp;<font color="#808080">(</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">VARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'FROM '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'SELECT TOP(2147483647) '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'*, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CONVERT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'VARCHAR, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN elapsed_time < 0 THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'(-1 * elapsed_time) / 86400 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'elapsed_time / 86400000 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') OVER () '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN 1 THEN 2 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'LEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CONVERT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'VARCHAR, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN elapsed_time < 0 THEN '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'(-1 * elapsed_time) / 86400 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'elapsed_time / 86400000 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') OVER () '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END AS max_elapsed_length, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@output_column_list</font>&nbsp;<font color="#808080">LIKE</font>&nbsp;<font color="#ff0000">'%|_delta|]%'</font>&nbsp;<font color="#0000ff">ESCAPE</font>&nbsp;<font color="#ff0000">'|'</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX(physical_io * recursion) OVER (PARTITION BY session_id, request_id) + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(physical_io * recursion) OVER (PARTITION BY session_id, request_id) AS physical_io_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX(reads * recursion) OVER (PARTITION BY session_id, request_id) + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(reads * recursion) OVER (PARTITION BY session_id, request_id) AS reads_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX(physical_reads * recursion) OVER (PARTITION BY session_id, request_id) + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(physical_reads * recursion) OVER (PARTITION BY session_id, request_id) AS physical_reads_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX(writes * recursion) OVER (PARTITION BY session_id, request_id) + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(writes * recursion) OVER (PARTITION BY session_id, request_id) AS writes_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX(tempdb_allocations * recursion) OVER (PARTITION BY session_id, request_id) + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(tempdb_allocations * recursion) OVER (PARTITION BY session_id, request_id) AS tempdb_allocations_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX(tempdb_current * recursion) OVER (PARTITION BY session_id, request_id) + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(tempdb_current * recursion) OVER (PARTITION BY session_id, request_id) AS tempdb_current_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX(CPU * recursion) OVER (PARTITION BY session_id, request_id) + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(CPU * recursion) OVER (PARTITION BY session_id, request_id) AS CPU_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX(thread_CPU_snapshot * recursion) OVER (PARTITION BY session_id, request_id) + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(thread_CPU_snapshot * recursion) OVER (PARTITION BY session_id, request_id) AS thread_CPU_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX(context_switches * recursion) OVER (PARTITION BY session_id, request_id) + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(context_switches * recursion) OVER (PARTITION BY session_id, request_id) AS context_switches_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MAX(used_memory * recursion) OVER (PARTITION BY session_id, request_id) + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(used_memory * recursion) OVER (PARTITION BY session_id, request_id) AS used_memory_delta, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'MIN(last_request_start_time) OVER (PARTITION BY session_id, request_id) AS first_request_start_time, '</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'COUNT(*) OVER (PARTITION BY session_id, request_id) AS num_events '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'FROM #sessions AS s1 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#008080">@sort_order</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">''</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ORDER BY '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">@sort_order</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') AS s '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHERE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'s.recursion = 1 '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff0000">') x '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff0000">'OPTION (KEEPFIXED PLAN); '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<font color="#ff0000">''</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">CASE</font>&nbsp;<font color="#008080">@return_schema</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'SET @schema = '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'''CREATE TABLE <table_name> ( '' + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'STUFF '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'( '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'SELECT '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''','' + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'QUOTENAME(COLUMN_NAME) + '' '' + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'DATA_TYPE + '</font>&nbsp;<font color="#808080">+</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN DATA_TYPE LIKE ''%char'' THEN ''('' + COALESCE(NULLIF(CONVERT(VARCHAR, CHARACTER_MAXIMUM_LENGTH), ''-1''), ''max'') + '') '' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE '' '' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'CASE IS_NULLABLE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHEN ''NO'' THEN ''NOT '' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ELSE '''' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'END + ''NULL'' AS [text()] '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'FROM tempdb.INFORMATION_SCHEMA.COLUMNS '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'WHERE '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'TABLE_NAME = (SELECT name FROM tempdb.sys.objects WHERE object_id = OBJECT_ID(''tempdb..#session_schema'')) '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ORDER BY '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'ORDINAL_POSITION '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'FOR XML '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'PATH('''') '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'), + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'1, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">'1, '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''''' '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">') + '</font>&nbsp;<font color="#808080">+</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff0000">''')''; '</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;<font color="#008000">--End derived table and INSERT specification</font><br>&nbsp;&nbsp;<font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#008080">@sql_n</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">NVARCHAR</font><font color="#808080">(</font><font color="#ff00ff">MAX</font><font color="#808080">)</font><font color="#808080">,</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">EXEC</font>&nbsp;<font color="#800000">sp_executesql</font><br>&nbsp;&nbsp;<font color="#008080">@sql_n</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#ff0000">N'@schema VARCHAR(MAX) OUTPUT'</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#008080">@schema</font>&nbsp;<font color="#0000ff">OUTPUT</font><font color="#808080">;</font><br><font color="#0000ff">END</font><font color="#808080">;</font><br><font color="#000000"></font><br><font color="#0000ff">GO</font><br><font color="#000000"></font><br><font color="#0000ff">EXEC</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#800000">sp_addextendedproperty</font>&nbsp;<font color="#ff0000">N'MS_Description'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'Устаревшее (описание внутри, использовалось до MS SQL Server 2012)'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'SCHEMA'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'inf'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'PROCEDURE'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'sp_WhoIsActive'</font><br><font color="#0000ff">GO</font></div>
          </div>
        </div>
      </div>
      <div id="DependsOn" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Depends On</h2>
          <span class="badge inline-middle">1</span>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <ul class="items-list">
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Security\Schemas\inf.html" data-mapping-enabled="true"><span>inf</span></a></li>
            </ul>
          </div>
        </div>
      </div>
      <div id="UsedBy" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Used By</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <span class="text-muted">No items found</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    <div class="col-xs-4">Author:&nbsp;</div>
    <div class="col-xs-4 align-center">Copyright &#169; All Rights Reserved</div>
    <div class="col-xs-4 align-right">Created:&nbsp;26.12.2019</div>
  </div>
</body>
</html>