<!DOCTYPE HTML>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<title>srv.GetScalling_monitor_db</title>
<script src="../../../../../../scripts/jquery-1.12.0.min.js" type="text/javascript"></script>
<script src="../../../../../../scripts/bootstrap.min.js" type="text/javascript"></script>
<script src="../../../../../../scripts/clipboard.min.js" type="text/javascript"></script>
<script src="../../../../../../scripts/main.js" type="text/javascript"></script>
<link rel="stylesheet" href="../../../../../../styles/bootstrap/Default.css" type="text/css">
<link rel="stylesheet" href="../../../../../../styles/main.css" type="text/css">
</head>
<body>
  <div class="page-wrap">
    <div class="header">
      <div class="row">
        <div class="col-xs-12">
          <ol class="breadcrumb">
            <li><a href="../../../../../../startpage.html" data-mapping-enabled="true">Project</a></li>
            <li><a href="../../../../../../Servers\Servers.html" data-mapping-enabled="true">Servers</a></li>
            <li><a href="../../../../../../Servers\SRV\SRV.html" data-mapping-enabled="true">SRV</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\UserDatabases.html" data-mapping-enabled="true">User databases</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\SRV.html" data-mapping-enabled="true">SRV</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Programmability.html" data-mapping-enabled="true">Programmability</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\Procedures.html" data-mapping-enabled="true">Stored Procedures</a></li>
            <li class="active">srv.GetScalling_monitor_db</li>
          </ol>
        </div>
      </div>
      <div class="row">
        <div class="title col-xs-12">
          <div><img class="inline-middle image-large" src="../../../../../../images/procedure.svg" title="srv.GetScalling_monitor_db" />
            <h1 class="inline-middle">srv.GetScalling_monitor_db</h1>
            <div class="dropdown actions-btn-wrap">
              <button type="button" class="btn btn-default actions-btn" data-toggle="dropdown"><span class="icon-actions icon-small actions-btn-span"></span></button>
              <ul class="dropdown-menu dropdown-menu-right">
                <li><a id="CollapseAll" href="#">Collapse All</a></li>
                <li><a id="ExpandAll" href="#">Expand All</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="content">
      <div id="Description" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Description</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <span>Общая процедура мониторинга SQL Server</span>
          </div>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Properties</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <table class="table table-hover table-bordered">
              <tbody>
                <tr>
                  <th>Name</th>
                  <th>Value</th>
                </tr>
                <tr>
                  <td>ANSI Nulls ON</td>
                  <td><p class="value-true">True</p></td>
                </tr>
                <tr>
                  <td>Quoted Identifier ON</td>
                  <td><p class="value-true">True</p></td>
                </tr>
                <tr>
                  <td>Encrypted</td>
                  <td><p class="value-false">False</p></td>
                </tr>
                <tr>
                  <td>Execute As</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Assembly</td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="Parameters" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Parameters</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <table class="table table-hover table-bordered table-100">
              <tbody>
                <tr>
                  <th>Name</th>
                  <th>Data Type</th>
                  <th>Length</th>
                  <th class="column-description-35">Description</th>
                </tr>
                <tr>
                  <td>@t</td>
                  <td>int</td>
                  <td>4</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@DATABASE</td>
                  <td>nvarchar</td>
                  <td>255</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@DATABASE_Unloading</td>
                  <td>nvarchar</td>
                  <td>255</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@DATE1</td>
                  <td>datetime</td>
                  <td>8</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@DATE2</td>
                  <td>datetime</td>
                  <td>8</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@SERVER</td>
                  <td>nvarchar</td>
                  <td>255</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@TABLE</td>
                  <td>nvarchar</td>
                  <td>255</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@ON_ALL_DATABASE</td>
                  <td>int</td>
                  <td>4</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@status_session</td>
                  <td>nvarchar</td>
                  <td>50</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@type_desc_object</td>
                  <td>nvarchar</td>
                  <td>50</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@Unloading</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@Index_Is_Detailed</td>
                  <td>bit</td>
                  <td>1</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@job</td>
                  <td>int</td>
                  <td>4</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
                <tr>
                  <td>@like</td>
                  <td>int</td>
                  <td>4</td>
                  <td>
                    <span></span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="SqlScript" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">SQL Script</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <div class="sqlscript panel-default">
              <font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">QUOTED_IDENTIFIER</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">ANSI_NULLS</font>&nbsp;<font color="#0000ff">ON</font><br><font color="#0000ff">GO</font><br><font color="#000000"></font><br><font color="#000000"></font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--Назначение: Производительность MS SQL.Вывод мониторинга. Масштабируемые данные по времени</font><br>&nbsp;&nbsp;<font color="#008000">--Автор: Прилепа Б.А. - АБД</font><br>&nbsp;&nbsp;<font color="#008000">--Создано: 12.01.2017. Изменено 28.05.2019</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=1						--RAM - HDD (СТАТИСТИКА DESC)</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=2						--(БД) Размеры баз данных, mdf и ldf файла</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=22						--(БД) Свободное место в файлах mdf, ldf</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=3						--(БД) RAM под БД</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=5						--(БД) Затраты процессорного времени по базам данных (CPUtime)</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=6,@DATABASE='Trucks',@status_session='running'			--(БД) Сессии на БД (можно и по имени хоста) --status: 'running','sleeping'</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=7						--(БД) Текущие запросы выполняемые на сервере (sp_Locks)</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=8			--(БД) Мониторинг блокировок и повисающих запросов, job-ов (sp_Locks 3)</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=19                       --(БД) Кто активен и потребление ресурсов ([dbo].[sp_WhoIsActive_Admin])</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=20,@DATABASE='',@tbl='transportmodel1cs'	--(БД) Статистика по запросам</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=18,@DATABASE='MonopolySunTemp',@type_desc_object='FN',@Unloading=0 ,@TABLE='CustomCheckOrderSave'  --(БД) Статистика по запросам БД (хранимки)</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=9,@DATABASE='MonopolySun',@DATE1='2019-05-28'			--(БЭКАПЫ PRD-SQL-SRV01-02) Мониторинг бэкапов (запросом)</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=4,@DATABASE='MonopolySun',@ON_ALL_DATABASE=0,@TABLE='msTruckInOrder_OnOff_ToAgreement'	--(TABLES) Размеры таблиц (+ обращения), данные в них и индексы (Если БД нет, то ничего не выведет)</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=21,@TABLE='msTruckInOrder_OnOff_ToAgreement',@like=1 --(иногда возвращает пусто или не полный набор, особенности отображения в sys) --ПОИСК ИСПОЛЬЗОВАНИЯ ОБЪЕКТА ПО ВСЕМ БАЗАМ</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=21,@TABLE='Order',@DATABASE='Trucks',@like=0 --(иногда возвращает пусто или не полный набор, особенности отображения в sys) --ПОИСК ИСПОЛЬЗОВАНИЯ ОБЪЕКТА ПО ВСЕМ БАЗАМ</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=21,@DATABASE='MonopolySun',@like=0 --использование БД в хранимых объектах</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=21,@DATABASE='MonopolySun',@job=1 --И джобы рассматриваем</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=10,@DATABASE='WialonBuffer',@TABLE='booking_histories' 		--(TABLES) Суммарная cтатистика чтений и записей по таблицам</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=17,@DATABASE='SRV'				--(БД) индексы! Последние чтения из таблиц, по всем таблицам БД</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=17,@DATABASE='MonopolySun',@TABLE='msOrder_ToAgreement'			--(БД) индексы! Последние чтения из таблиц, без указания таблицы выводится по всем таблицам</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=10						--(БД) Суммарная cтатистика по базам данных чтение/запись (индексы)</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=16						--(БД) Суммарная cтатистика по базам данных чтение/запись (системные счетчики)</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=11		--(JOBS) Данные по выполнению заданий на сервере (job-ов) msdb.dbo.GetStatisticJobs</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=12		--(WAITS) Мониторинг статистики по ожиданиям /*Очистить статистику DBCC SQLPERF ('sys.dm_os_wait_stats', CLEAR);*/</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=13,@DATABASE='MonopolyDataMigration',@TABLE='Order'		--(INDEXES) Используемость индексов в БД, какие индексы можно убрать</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=14,@DATABASE='MonopolySunTemp',@TABLE='transfer_Order'		--(INDEXES) Фрагментированность индексов</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=14,@DATABASE='MonopolySunTemp',@TABLE='Order',@Index_Is_Detailed=1		--(INDEXES) Фрагментированность индексов</font><br>&nbsp;&nbsp;<font color="#008000">--exec srv.GetScalling_monitor_db @t=15,@DATABASE='Trucks'			--(INDEXES) Перечень всех индексов</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">CREATE</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#0000ff">ALTER</font>&nbsp;<font color="#0000ff">procedure</font>&nbsp;<font color="#008080">srv</font><font color="#808080">.</font><font color="#008080">GetScalling_monitor_db</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#008080">@t</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">int</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#008000">/* См. выше* режимы просмотра*/</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@DATABASE</font>&nbsp;&nbsp;&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@DATABASE_Unloading</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@DATE1</font>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">datetime</font>&nbsp;&nbsp;&nbsp;<font color="#808080">=</font>&nbsp;<font color="#808080">null</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@DATE2</font>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">datetime</font>&nbsp;&nbsp;&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@SERVER</font>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@TABLE</font>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@ON_ALL_DATABASE</font>&nbsp;&nbsp;<font color="#0000ff">int</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@status_session</font>&nbsp;&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">50</font><font color="#808080">)</font>&nbsp;&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@type_desc_object</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">50</font><font color="#808080">)</font>&nbsp;&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">N''</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@Unloading</font>&nbsp;&nbsp;&nbsp;<font color="#0000ff">bit</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#008000">--выгрузка</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@Index_Is_Detailed</font>&nbsp;<font color="#0000ff">bit</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#008000">--'Detailed данные по уровням индексов', =1 просмотр нижних уровней может привести к высокой нагрузке на диск по чтениям</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@job</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">int</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">@like</font>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">int</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#008000">--Поиск в тексте stored objects по шаблону</font><br>&nbsp;&nbsp;<font color="#0000ff">as</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#0000ff">xact_abort</font>&nbsp;<font color="#0000ff">on</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#0000ff">nocount</font>&nbsp;<font color="#0000ff">on</font><font color="#808080">;</font><br>&nbsp;&nbsp;<font color="#008000">--Общая процедура мониторинга SQL Server</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@servername</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">=</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">SERVERPROPERTY</font><font color="#808080">(</font><font color="#ff0000">N'MachineName'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@SERVER</font><font color="#808080">=</font><font color="#000000">0</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#008080">@SERVER</font><font color="#808080">=</font><font color="#008080">@servername</font>&nbsp;<br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">/*@t=1 Чтения запись по БД - раз в 2 секунды, RAM - раз в минуту, HDD - раз в полчаса*/</font><br>&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@DATE1</font><font color="#808080">></font><font color="#008080">@DATE2</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@DATE3</font>&nbsp;<font color="#0000ff">datetime</font><br>&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@DATE3</font><font color="#808080">=</font><font color="#008080">@DATE2</font><br>&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@DATE2</font><font color="#808080">=</font><font color="#008080">@DATE1</font><br>&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@DATE1</font><font color="#808080">=</font><font color="#008080">@DATE3</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">1</font>&nbsp;<font color="#008000">--Анализ свободного места на дисках и используемости RAM</font><br>&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">srv</font><font color="#808080">.</font><font color="#008080">Disk_RAM</font><font color="#008000">--проверка на текущий момент</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">2</font>&nbsp;<font color="#008000">--Размеры баз данных</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#008080">db</font><font color="#808080">,</font><font color="#008080">[file_name]</font><font color="#808080">,</font><font color="#008080">[Size(Mb)]</font><font color="#808080">,</font><font color="#008080">[SizeDB(Mb)]</font><font color="#808080">,</font>&nbsp;<font color="#008080">[All DBs Size(Mb)]</font><font color="#808080">=</font><font color="#808080">(</font><font color="#0000ff">case</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#008080">id</font><font color="#808080">=</font><font color="#000000">1</font>&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#008080">[All DBs Size(Mb)]</font>&nbsp;<font color="#0000ff">else</font>&nbsp;<font color="#808080">null</font>&nbsp;<font color="#0000ff">end</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[SizeData(Mb)]</font><font color="#808080">=</font><font color="#808080">(</font><font color="#0000ff">case</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#008080">id</font><font color="#808080">=</font><font color="#000000">1</font>&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#008080">[SizeData(Mb)]</font>&nbsp;<font color="#0000ff">else</font>&nbsp;<font color="#808080">null</font>&nbsp;<font color="#0000ff">end</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[SizeLog(Mb)]</font><font color="#808080">=</font><font color="#808080">(</font><font color="#0000ff">case</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#008080">id</font><font color="#808080">=</font><font color="#000000">1</font>&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#008080">[SizeLog(Mb)]</font>&nbsp;<font color="#0000ff">else</font>&nbsp;<font color="#808080">null</font>&nbsp;<font color="#0000ff">end</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">from</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#008080">db</font><font color="#808080">,</font><font color="#008080">[file_name]</font><font color="#808080">,</font><font color="#008080">[Size(Mb)]</font><font color="#808080">,</font><font color="#008080">[SizeDB(Mb)]</font><font color="#808080">,</font><font color="#008080">[All DBs Size(Mb)]</font><font color="#808080">,</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#0000ff">case</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#008080">[type]</font><font color="#808080">=</font><font color="#000000">1</font>&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#008080">[Size(Mb)]</font>&nbsp;<font color="#0000ff">else</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">end</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#008080">[SizeLog(Mb)]</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#0000ff">case</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#008080">[type]</font><font color="#808080">=</font><font color="#000000">0</font>&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#008080">[Size(Mb)]</font>&nbsp;<font color="#0000ff">else</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#0000ff">end</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#008080">[SizeData(Mb)]</font><font color="#808080">,</font><font color="#ff00ff">row_number</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">order</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#008080">[SizeDB(Mb)]</font>&nbsp;<font color="#0000ff">desc</font><font color="#808080">)</font>&nbsp;<font color="#008080">id</font><br>&nbsp;&nbsp;<font color="#0000ff">from</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#0000ff">name</font>&nbsp;<font color="#008080">db</font><font color="#808080">,</font><font color="#008080">c</font><font color="#808080">.</font><font color="#0000ff">name</font>&nbsp;<font color="#008080">[file_name]</font><font color="#808080">,</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">BytesOnDisk</font><font color="#808080">)</font><font color="#808080">/</font><font color="#000000">1024.0</font><font color="#808080">/</font><font color="#000000">1024.0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#008080">[Size(Mb)]</font><font color="#808080">,</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">BytesOnDisk</font><font color="#808080">/</font><font color="#000000">1024.0</font><font color="#808080">/</font><font color="#000000">1024.0</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#0000ff">name</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#008080">[SizeDB(Mb)]</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">BytesOnDisk</font><font color="#808080">/</font><font color="#000000">1024.0</font><font color="#808080">/</font><font color="#000000">1024.0</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#008080">[All DBs Size(Mb)]</font><font color="#808080">,</font><font color="#008080">c</font><font color="#808080">.</font><font color="#008080">[type]</font><br>&nbsp;&nbsp;<font color="#0000ff">from</font>&nbsp;<font color="#808080">::</font><font color="#008080">fn_virtualfilestats</font><font color="#808080">(</font><font color="#808080">NULL</font><font color="#808080">,</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font>&nbsp;<font color="#008080">a</font>&nbsp;<font color="#808080">inner</font>&nbsp;<font color="#808080">join</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#808080">*</font>&nbsp;<font color="#0000ff">from</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">databases</font>&nbsp;<font color="#0000ff">where</font>&nbsp;<font color="#008080">database_id</font><font color="#808080">></font><font color="#000000">4</font><font color="#808080">)</font>&nbsp;<font color="#008080">b</font>&nbsp;<font color="#0000ff">on</font><font color="#808080">(</font><font color="#008080">a</font><font color="#808080">.</font><font color="#008080">DbId</font><font color="#808080">=</font><font color="#008080">b</font><font color="#808080">.</font><font color="#008080">database_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#808080">inner</font>&nbsp;<font color="#808080">join</font>&nbsp;&nbsp;<font color="#0000ff">master</font><font color="#808080">.</font><font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">master_files</font>&nbsp;<font color="#008080">c</font>&nbsp;<font color="#0000ff">on</font><font color="#808080">(</font><font color="#008080">a</font><font color="#808080">.</font><font color="#008080">DbId</font><font color="#808080">=</font><font color="#008080">c</font><font color="#808080">.</font><font color="#008080">database_id</font>&nbsp;<font color="#808080">and</font>&nbsp;&nbsp;<font color="#008080">a</font><font color="#808080">.</font><font color="#008080">FileId</font><font color="#808080">=</font><font color="#008080">c</font><font color="#808080">.</font><font color="#008080">[file_id]</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">where</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#0000ff">name</font><font color="#808080">=</font><font color="#008080">@DATABASE</font>&nbsp;<font color="#808080">or</font>&nbsp;<font color="#008080">@DATABASE</font><font color="#808080">=</font><font color="#ff0000">''</font><br>&nbsp;&nbsp;<font color="#0000ff">group</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#0000ff">name</font><font color="#808080">,</font><font color="#008080">c</font><font color="#808080">.</font><font color="#0000ff">name</font><font color="#808080">,</font><font color="#008080">BytesOnDisk</font><font color="#808080">,</font><font color="#008080">c</font><font color="#808080">.</font><font color="#008080">[type]</font><font color="#808080">)</font>&nbsp;<font color="#008080">a</font><font color="#808080">)</font>&nbsp;<font color="#008080">a</font><br>&nbsp;&nbsp;<font color="#0000ff">order</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">4</font>&nbsp;<font color="#0000ff">desc</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--Объем RAM выделенного под разные базы данных</font><br>&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">3</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#ff00ff">object_id</font><font color="#808080">(</font><font color="#ff0000">'tempdb..#SUMMA'</font><font color="#808080">,</font><font color="#ff0000">'U'</font><font color="#808080">)</font>&nbsp;<font color="#808080">is</font>&nbsp;<font color="#808080">not</font>&nbsp;<font color="#808080">null</font><br>&nbsp;<font color="#0000ff">drop</font>&nbsp;<font color="#0000ff">table</font>&nbsp;<font color="#008080">#SUMMA</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#ff00ff">count</font><font color="#808080">(</font><font color="#808080">*</font><font color="#808080">)</font><font color="#0000ff">AS</font>&nbsp;<font color="#008080">cached_pages_count</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">count</font><font color="#808080">(</font><font color="#808080">*</font><font color="#808080">)</font><font color="#808080">/</font><font color="#000000">128</font>&nbsp;&nbsp;<font color="#008080">[Size (Mb)]</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#0000ff">CASE</font>&nbsp;<font color="#008080">database_id</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#000000">32767</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff0000">'ResourceDb'</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#ff00ff">db_name</font><font color="#808080">(</font><font color="#008080">database_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#0000ff">Database_name</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">into</font>&nbsp;<font color="#008080">#SUMMA</font><br>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_os_buffer_descriptors</font><br>&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#ff00ff">db_name</font><font color="#808080">(</font><font color="#008080">database_id</font><font color="#808080">)</font>&nbsp;<font color="#808080">,</font><font color="#008080">database_id</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#0000ff">Database_name</font><font color="#808080">,</font><font color="#008080">[Size (Mb)]</font><font color="#808080">,</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">round</font><font color="#808080">(</font><font color="#808080">(</font><font color="#008080">[Size (Mb)]</font><font color="#808080">/</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">[Size (Mb)]</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">float</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">*</font><font color="#000000">100</font><font color="#808080">,</font><font color="#000000">2</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#008080">[RAM (%)]</font><br>&nbsp;<font color="#0000ff">from</font>&nbsp;<font color="#008080">#SUMMA</font><br>&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#008080">[Size (Mb)]</font>&nbsp;<font color="#0000ff">DESC</font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#ff00ff">object_id</font><font color="#808080">(</font><font color="#ff0000">'tempdb..#SUMMA'</font><font color="#808080">,</font><font color="#ff0000">'U'</font><font color="#808080">)</font>&nbsp;<font color="#808080">is</font>&nbsp;<font color="#808080">not</font>&nbsp;<font color="#808080">null</font><br>&nbsp;<font color="#0000ff">drop</font>&nbsp;<font color="#0000ff">table</font>&nbsp;<font color="#008080">#SUMMA</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">4</font>&nbsp;<font color="#808080">and</font>&nbsp;<font color="#ff00ff">DB_ID</font><font color="#808080">(</font><font color="#008080">@DATABASE</font><font color="#808080">)</font>&nbsp;<font color="#808080">is</font>&nbsp;<font color="#808080">not</font>&nbsp;<font color="#808080">null</font>&nbsp;<font color="#008000">--Размеры таблиц, данные в них и индексы</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@SS</font>&nbsp;<font color="#0000ff">varchar</font><font color="#808080">(</font><font color="#ff00ff">max</font><font color="#808080">)</font><br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@ON_ALL_DATABASE</font><font color="#808080">=</font><font color="#000000">1</font><br>&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@SS</font><font color="#808080">=</font><font color="#ff0000">'USE ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">']
  declare @id	int,@pages	bigint,@reservedpages  bigint,@usedpages  bigint
	SELECT  @reservedpages = sum(a.total_pages),
		@usedpages = sum(a.used_pages),
		@pages = sum(CASE
					When it.internal_type IN (202,204,207,211,212,213,214,215,216,221,222,236) Then 0
					When a.type <> 1 and p.index_id < 2 Then a.used_pages
					When p.index_id < 2 Then a.data_pages
					Else 0 END)
	from sys.partitions p join sys.allocation_units a on p.partition_id = a.container_id
		left join sys.internal_tables it on p.object_id = it.object_id
SELECT  @reservedpages = @reservedpages + sum(isnull(reserved_page_count,0)),@usedpages = @usedpages + sum(isnull(used_page_count,0))
		FROM sys.dm_db_partition_stats p, sys.internal_tables it
		WHERE p.object_id = it.object_id;
	select [reserved(Mb)] = cast((@reservedpages * 8192) / (1024.0*1024.0) as numeric(12,2)),[data(Mb)] = cast((@pages * 8192) / (1024.0*1024.0) as numeric(12,2)),[index_size(Mb)] = cast(((@usedpages - @pages) * 8192) / (1024.0*1024.0) as numeric(12,2)),[unused(Mb)] = cast(((@reservedpages - @usedpages) * 8192) / (1024.0*1024.0) as numeric(12,2))'</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">try</font>&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">print</font>&nbsp;<font color="#008080">@SS</font><br>&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#808080">(</font><font color="#008080">@SS</font><font color="#808080">)</font>&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#008080">ERR_MSG</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">catch</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@sql</font>&nbsp;<font color="#0000ff">varchar</font><font color="#808080">(</font><font color="#ff00ff">max</font><font color="#808080">)</font><font color="#808080">=</font><font color="#ff0000">''</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">'
		USE ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">']
		declare @table table(
		name nvarchar(255),
		[rows] bigint,
		reserved nvarchar(255),
		data nvarchar(255),
		index_size nvarchar(255),
		unused nvarchar(255),id int identity)
		DECLARE @name nvarchar(255)
		DECLARE SysCur CURSOR LOCAL FOR SELECT  ''[''+b.name+''].[''+a.name+'']'' as name 
		FROM sys.objects a inner join sys.schemas b on(a.schema_id=b.schema_id)
		WHERE type=''U'' and (a.name='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">''' or '''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><br><font color="#ff0000">'''='''')
		OPEN SysCur
		FETCH NEXT FROM SysCur INTO @name
		WHILE @@FETCH_STATUS=0 
		BEGIN
			insert into @table(name,[rows],reserved,data,index_size,unused)
			exec sp_spaceused @name 
			update @table
			set name=@name
			where id=(select top 1 id from @table order by id desc)
		FETCH NEXT FROM SysCur INTO @name
		END
		CLOSE SysCur
		DEALLOCATE SysCur
		declare @clean_table table(
		name nvarchar(255),
		[rows] int,
		[reserved(Kb)] int,
		[data(Kb)] int,
		[index_size(Kb)] int,
		[unused(Kb)] int)
		insert into @clean_table([name],[rows],[reserved(Kb)],[data(Kb)],[index_size(Kb)],[unused(Kb)])
		SELECT  cast(name as nvarchar(255)),cast([rows] as bigint),cast(replace(reserved,'' KB'','''') as bigint),cast(replace(data,'' KB'','''') as bigint),
		cast(replace(index_size,'' KB'','''') as bigint),cast(replace(unused,'' KB'','''') as bigint) from @table
		declare @TB table(srv nvarchar(255),DBName nvarchar(255),tbl nvarchar(255),Reads bigint,Writes bigint, [Reads@Writes] bigint,SampleDays numeric(20,5),SampleSecons bigint)
		insert into @TB(srv,DBName,tbl,Reads,Writes,[Reads@Writes],SampleDays,SampleSecons)
			SELECT   cast(SERVERPROPERTY(N''MachineName'') as nvarchar(255)) AS ServerName,
				DB_NAME() AS DBName,
				''[''+s.name+''].[''+ob.name+'']'' AS TableName ,
				SUM(ddius.user_seeks + ddius.user_scans+ddius.user_lookups) AS Reads ,
				SUM(ddius.user_updates) AS Writes,
				SUM(ddius.user_seeks + ddius.user_scans+ddius.user_lookups
					+ ddius.user_updates) AS [Reads&Writes],(SELECT DATEDIFF(s,create_date,GETDATE())/86400.0
				  FROM master.sys.databases WHERE name = ''tempdb'') AS SampleDays,( SELECT DATEDIFF(s, create_date, GETDATE()) AS SecoundsRunnig FROM master.sys.databases WHERE name = ''tempdb'') AS SampleSeconds
		FROM    sys.dm_db_index_usage_stats ddius
				INNER JOIN sys.indexes i ON ddius.object_id=i.object_id AND i.index_id=ddius.index_id
				INNER JOIN sys.objects ob ON(ddius.object_id=ob.object_id) 
				INNER JOIN sys.schemas s ON(ob.schema_id=s.schema_id) 
		WHERE    OBJECTPROPERTY(ddius.object_id,''IsUserTable'') = 1 AND ddius.database_id = DB_ID() AND (''''='''' or OBJECT_NAME(ddius.object_id)='''')
		GROUP BY ''[''+s.name+''].[''+ob.name+'']''		
		SELECT  ca.name tbl, max([rows]) [rows],max([reserved(Kb)]) [reserved(Kb)],max([data(Kb)]) [data(Kb)],max([index_size(Kb)]) [index_size(Kb)]
		,max([unused(Kb)]) [unused(Kb)],max(cast([reserved(Kb)]/1024.0 as numeric(12,3))) as [data(Mb)],max(isnull(Reads,0)) Reads,max(isnull(Writes,0)) Writes
		,max(isnull([Reads@Writes],0)) [Reads@Writes],max(last_user_update) last_user_update,max(last_user_seek) last_user_seek,max(last_user_scan) last_user_scan,max(last_user_lookup) last_user_lookup,
		max(SampleDays) SampleDays,(SELECT  max(create_date) as start_statistic from sys.databases where name=''tempdb'') start_statistic
		from @clean_table ca LEFT OUTER JOIN @TB cb ON(ca.name=cb.tbl) LEFT OUTER JOIN (SELECT ''[''+sc.name+''].[''+b.name+'']'' tbl,last_user_update,last_user_seek,
		last_user_scan,last_user_lookup from sys.dm_db_index_usage_stats a inner join ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><font color="#ff0000">'].sys.objects b on(a.object_id=b.object_id and db_NAME(a.database_id)='''</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">''')
		inner join ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><font color="#ff0000">'].sys.schemas sc on(b.schema_id=sc.schema_id) left outer join ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">'].sys.indexes ind on(a.index_id=ind.index_id and a.object_id=ind.object_id)
	    where db_NAME(a.database_id)='''</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><font color="#ff0000">''') c ON(ca.name=c.tbl) group by ca.name order by 8,9'</font><br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">try</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">print</font>&nbsp;<font color="#008080">@sql</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#808080">(</font><font color="#008080">@sql</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#008080">ERR_MSG</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font><br>&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">5</font>&nbsp;<font color="#008000">--Затраты процессорного времени по базам данных</font><br>&nbsp;<font color="#0000ff">WITH</font>&nbsp;<font color="#008080">DB_CPU_Stats</font><br>&nbsp;<font color="#0000ff">AS</font><br>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#008080">DatabaseID</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">DB_Name</font><font color="#808080">(</font><font color="#008080">DatabaseID</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[DatabaseName]</font><font color="#808080">,</font>&nbsp;<font color="#ff00ff">SUM</font><font color="#808080">(</font><font color="#008080">total_worker_time</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[CPU_Time_Ms]</font><br>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_query_stats</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">qs</font><br>&nbsp;<font color="#808080">CROSS</font>&nbsp;<font color="#0000ff">APPLY</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#ff00ff">CONVERT</font><font color="#808080">(</font><font color="#0000ff">int</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">value</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[DatabaseID]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_plan_attributes</font><font color="#808080">(</font><font color="#008080">qs</font><font color="#808080">.</font><font color="#008080">plan_handle</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<font color="#008080">attribute</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#ff0000">N'dbid'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">F_DB</font><br>&nbsp;<font color="#0000ff">GROUP</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#008080">DatabaseID</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#ff00ff">ROW_NUMBER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><font color="#808080">(</font><font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#008080">[CPU_Time_Ms]</font>&nbsp;<font color="#0000ff">DESC</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[row_num]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">DatabaseName</font><font color="#808080">,</font>&nbsp;<font color="#008080">[CPU_Time_Ms]</font><font color="#808080">,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff00ff">CAST</font><font color="#808080">(</font><font color="#008080">[CPU_Time_Ms]</font>&nbsp;<font color="#808080">*</font>&nbsp;<font color="#000000">1.0</font>&nbsp;<font color="#808080">/</font>&nbsp;<font color="#ff00ff">SUM</font><font color="#808080">(</font><font color="#008080">[CPU_Time_Ms]</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">OVER</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#808080">*</font>&nbsp;<font color="#000000">100.0</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#0000ff">DECIMAL</font><font color="#808080">(</font><font color="#000000">5</font><font color="#808080">,</font>&nbsp;<font color="#000000">2</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[CPUPercent]</font><br>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">DB_CPU_Stats</font><br>&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<font color="#008080">DatabaseID</font>&nbsp;<font color="#808080">not</font>&nbsp;<font color="#808080">in</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">,</font><font color="#000000">3</font><font color="#808080">,</font><font color="#000000">4</font><font color="#808080">)</font>&nbsp;<font color="#008000">-- system databases</font><br>&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">DatabaseID</font>&nbsp;<font color="#808080"><</font><font color="#808080">></font>&nbsp;<font color="#000000">32767</font>&nbsp;<font color="#008000">-- ResourceDB</font><br>&nbsp;<font color="#808080">and</font>&nbsp;<font color="#008080">DatabaseName</font><font color="#808080"><</font><font color="#808080">></font><font color="#ff0000">'master'</font><br>&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#008080">row_num</font>&nbsp;<font color="#0000ff">OPTION</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">RECOMPILE</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">6</font>&nbsp;<font color="#008000">--Сессии на БД</font><br>&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;&nbsp;<font color="#0000ff">distinct</font>&nbsp;<font color="#008080">a</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><font color="#008080">[host_name]</font><font color="#808080">,</font><font color="#008080">p</font><font color="#808080">.</font><font color="#0000ff">cpu</font><font color="#808080">,</font><font color="#008080">p</font><font color="#808080">.</font><font color="#008080">waittime</font><font color="#808080">,</font><font color="#008080">p</font><font color="#808080">.</font><font color="#008080">lastwaittype</font><font color="#808080">,</font><font color="#008080">client_net_address</font><font color="#808080">,</font><font color="#008080">local_net_address</font><font color="#808080">,</font><font color="#008080">a</font><font color="#808080">.</font><font color="#008080">[program_name]</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">login_name</font><font color="#808080">,</font><font color="#008080">a</font><font color="#808080">.</font><font color="#008080">[status]</font><font color="#808080">,</font><font color="#008080">last_request_start_time</font><font color="#808080">,</font><br>&nbsp;<font color="#008080">last_request_end_time</font><font color="#808080">,</font><font color="#008000">--[lock_timeout],</font><br>&nbsp;<font color="#008080">original_login_name</font><font color="#808080">,</font><font color="#008000">--db_name(database_id) DB,</font><br>&nbsp;<font color="#008080">cpu_time</font><font color="#808080">,</font><font color="#008080">total_scheduled_time</font><font color="#808080">,</font><font color="#008080">total_elapsed_time</font><br>&nbsp;<font color="#0000ff">FROM</font>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_sessions</font>&nbsp;<font color="#008080">a</font>&nbsp;<font color="#0000ff">left</font>&nbsp;<font color="#808080">outer</font>&nbsp;<font color="#808080">join</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_connections</font>&nbsp;<font color="#008080">b</font>&nbsp;<font color="#0000ff">on</font><font color="#808080">(</font><font color="#008080">a</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">=</font><font color="#008080">b</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">left</font>&nbsp;<font color="#808080">outer</font>&nbsp;<font color="#808080">join</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">sysprocesses</font>&nbsp;<font color="#008080">p</font>&nbsp;<font color="#0000ff">on</font><font color="#808080">(</font><font color="#008080">a</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">=</font><font color="#008080">p</font><font color="#808080">.</font><font color="#008080">spid</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">WHERE</font>&nbsp;&nbsp;&nbsp;<font color="#008080">database_id</font>&nbsp;<font color="#808080">></font>&nbsp;<font color="#000000">0</font><br>&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#808080">(</font><font color="#808080">(</font><font color="#ff00ff">DB_NAME</font><font color="#808080">(</font><font color="#008080">dbid</font><font color="#808080">)</font><font color="#808080">=</font><font color="#008080">@DATABASE</font>&nbsp;<font color="#808080">or</font>&nbsp;<font color="#008080">@DATABASE</font><font color="#808080">=</font><font color="#ff0000">''</font>&nbsp;<font color="#808080">or</font>&nbsp;<font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">p</font><font color="#808080">.</font><font color="#008080">spid</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">5</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">=</font><font color="#008080">@DATABASE</font><font color="#808080">)</font>&nbsp;<font color="#808080">or</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">ltrim</font><font color="#808080">(</font><font color="#ff00ff">rtrim</font><font color="#808080">(</font><font color="#008080">[host_name]</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">=</font><font color="#008080">@DATABASE</font>&nbsp;<font color="#808080">or</font>&nbsp;<font color="#008080">@DATABASE</font><font color="#808080">=</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">)</font><br>&nbsp;<font color="#808080">and</font>&nbsp;<font color="#808080">(</font><font color="#008080">@status_session</font><font color="#808080">=</font><font color="#ff0000">''</font>&nbsp;<font color="#808080">or</font>&nbsp;<font color="#008080">a</font><font color="#808080">.</font><font color="#008080">[status]</font><font color="#808080">=</font><font color="#008080">@status_session</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">order</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#008080">[host_name]</font><font color="#808080">,</font><font color="#008080">a</font><font color="#808080">.</font><font color="#008080">session_id</font><font color="#808080">,</font><font color="#008080">p</font><font color="#808080">.</font><font color="#008080">waittime</font>&nbsp;<font color="#0000ff">desc</font><font color="#808080">,</font><font color="#0000ff">cpu</font>&nbsp;<font color="#0000ff">desc</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">7</font>&nbsp;<font color="#008000">--Текущие запросы</font><br>&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">srv</font><font color="#808080">.</font><font color="#008080">Locks</font>&nbsp;<font color="#000000">4</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">8</font>&nbsp;<font color="#008000">--Мониторинг блокировок</font><br>&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">srv</font><font color="#808080">.</font><font color="#008080">Locks</font>&nbsp;<font color="#000000">3</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">9</font>&nbsp;<font color="#008000">--ИНФА по бэкапам</font><br>&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@DATE1</font><font color="#808080">=</font><font color="#0000ff">case</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#008080">@DATE1</font><font color="#808080">=</font><font color="#ff0000">''</font>&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#808080">NULL</font>&nbsp;<font color="#0000ff">else</font>&nbsp;<font color="#008080">@DATE1</font>&nbsp;<font color="#0000ff">end</font><br>&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">srv</font><font color="#808080">.</font><font color="#008080">Backups_info</font>&nbsp;<font color="#008080">@DATE</font><font color="#808080">=</font><font color="#008080">@DATE1</font><font color="#808080">,</font><font color="#008080">@DATABASE</font><font color="#808080">=</font><font color="#008080">@DATABASE</font><br>&nbsp;<font color="#0000ff">end</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">10</font>&nbsp;<font color="#008000">--Статистика чтений и записей по таблицам</font><br>&nbsp;<font color="#0000ff">begin</font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@DATABASE</font><font color="#808080"><</font><font color="#808080">></font><font color="#ff0000">''</font><br>&nbsp;<font color="#0000ff">begin</font><br>&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@sql2</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#ff00ff">max</font><font color="#808080">)</font><font color="#808080">=</font><font color="#ff0000">''</font>&nbsp;<br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql2</font><font color="#808080">=</font><br><font color="#ff0000">'
	USE ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">']
	SELECT   cast(SERVERPROPERTY(N''MachineName'') as nvarchar(255)) AS ServerName ,
				DB_NAME() AS DBName ,
				s.name+''.''+ob.name AS TableName ,
				SUM(ddius.user_seeks + ddius.user_scans + ddius.user_lookups)
																	   AS  Reads ,
				SUM(ddius.user_updates) AS Writes ,
				SUM(ddius.user_seeks + ddius.user_scans + ddius.user_lookups
					+ ddius.user_updates) AS [Reads&Writes],
				( SELECT     DATEDIFF(s, create_date, GETDATE()) / 86400.0
				  FROM      master.sys.databases
				  WHERE     name = ''tempdb''
				) AS SampleDays ,
				( SELECT     DATEDIFF(s, create_date, GETDATE()) AS SecoundsRunnig
				  FROM      master.sys.databases
				  WHERE     name = ''tempdb''
				) AS SampleSeconds
		FROM    sys.dm_db_index_usage_stats ddius
				INNER JOIN sys.indexes i ON ddius.object_id = i.object_id
											 AND i.index_id = ddius.index_id
				INNER JOIN sys.objects ob ON(ddius.object_id=ob.object_id) 
				INNER JOIN sys.schemas s ON(ob.schema_id=s.schema_id) 
		WHERE    OBJECTPROPERTY(ddius.object_id, ''IsUserTable'') = 1
				AND ddius.database_id = DB_ID()
				AND ('''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">'''='''' or OBJECT_NAME(ddius.object_id)='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><br><font color="#ff0000">''')
		GROUP BY s.name+''.''+ob.name
		ORDER BY Reads,Writes'</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">try</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">print</font>&nbsp;<font color="#008080">@sql2</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql2</font>&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">print</font>&nbsp;<font color="#008080">@sql</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#008080">ERR_MSG</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">catch</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">end</font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@DATABASE</font><font color="#808080">=</font><font color="#ff0000">''</font><br>&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@TBL</font>&nbsp;<font color="#0000ff">TABLE</font><font color="#808080">(</font><font color="#008080">[server]</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">,</font><font color="#008080">db</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">,</font><font color="#008080">Reads</font>&nbsp;<font color="#0000ff">bigint</font><font color="#808080">,</font><font color="#008080">Writes</font>&nbsp;<font color="#0000ff">bigint</font><font color="#808080">,</font><font color="#008080">[Reads&Writes]</font>&nbsp;<font color="#0000ff">bigint</font><font color="#808080">,</font><font color="#008080">SampleDays</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">,</font><font color="#008080">SampleSeconds</font>&nbsp;<font color="#0000ff">int</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@name</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">=</font><font color="#ff0000">''</font><br>&nbsp;&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@sql_10</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#ff00ff">max</font><font color="#808080">)</font><font color="#808080">=</font><font color="#ff0000">''</font><br>&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">SysCur</font>&nbsp;<font color="#0000ff">CURSOR</font>&nbsp;<font color="#0000ff">LOCAL</font>&nbsp;<font color="#0000ff">FOR</font>&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#0000ff">name</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">databases</font><br>&nbsp;&nbsp;<font color="#0000ff">OPEN</font>&nbsp;<font color="#008080">SysCur</font><br>&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">SysCur</font>&nbsp;<font color="#0000ff">INTO</font>&nbsp;<font color="#008080">@name</font><br>&nbsp;&nbsp;<font color="#0000ff">WHILE</font>&nbsp;<font color="#ff00ff">@@FETCH_STATUS</font><font color="#808080">=</font><font color="#000000">0</font>&nbsp;<font color="#0000ff">BEGIN</font><br>&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql_10</font><font color="#808080">=</font><br><font color="#ff0000">'
			USE ['</font><font color="#808080">+</font><font color="#008080">@name</font><font color="#808080">+</font><br><font color="#ff0000">']
			SELECT   cast(SERVERPROPERTY(N''MachineName'') as nvarchar(255)) AS ServerName ,
					DB_NAME() AS DBName ,
					SUM(ddius.user_seeks + ddius.user_scans + ddius.user_lookups)
																		   AS  Reads ,
					SUM(ddius.user_updates) AS Writes ,
					SUM(ddius.user_seeks + ddius.user_scans + ddius.user_lookups
						+ ddius.user_updates) AS [Reads&Writes] ,
					( SELECT     DATEDIFF(s, create_date, GETDATE()) / 86400.0
					  FROM      master.sys.databases
					  WHERE     name = ''tempdb''
					) AS SampleDays ,
					( SELECT     DATEDIFF(s, create_date, GETDATE()) AS SecoundsRunnig
					  FROM      master.sys.databases
					  WHERE     name = ''tempdb''
					) AS SampleSeconds
			FROM    sys.dm_db_index_usage_stats ddius
					INNER JOIN sys.indexes i ON ddius.object_id = i.object_id
												 AND i.index_id = ddius.index_id
			WHERE    OBJECTPROPERTY(ddius.object_id, ''IsUserTable'') = 1
					AND ddius.database_id = DB_ID()'</font><br>&nbsp;&nbsp;<font color="#0000ff">insert</font>&nbsp;<font color="#0000ff">into</font>&nbsp;<font color="#008080">@TBL</font><font color="#808080">(</font><font color="#008080">[server]</font><font color="#808080">,</font><font color="#008080">db</font><font color="#808080">,</font><font color="#008080">Reads</font><font color="#808080">,</font><font color="#008080">Writes</font><font color="#808080">,</font><font color="#008080">[Reads&Writes]</font><font color="#808080">,</font><font color="#008080">SampleDays</font><font color="#808080">,</font><font color="#008080">SampleSeconds</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql_10</font><br>&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">SysCur</font>&nbsp;<font color="#0000ff">INTO</font>&nbsp;<font color="#008080">@name</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font><br>&nbsp;&nbsp;<font color="#0000ff">CLOSE</font>&nbsp;<font color="#008080">SysCur</font><br>&nbsp;&nbsp;<font color="#0000ff">DEALLOCATE</font>&nbsp;<font color="#008080">SysCur</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#008000">--Вывод данных Reads/Writes по индексам</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#008080">[server]</font><font color="#808080">,</font><font color="#008080">db</font><font color="#808080">,</font><font color="#008080">Reads</font><font color="#808080">,</font><font color="#008080">Writes</font><font color="#808080">,</font><font color="#008080">[Reads&Writes]</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#808080">(</font><font color="#008080">Reads</font><font color="#808080">/</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">Reads</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">float</font><font color="#808080">)</font><font color="#808080">*</font><font color="#000000">100</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#008080">[Reads(%)]</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#808080">(</font><font color="#008080">Writes</font><font color="#808080">/</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">Writes</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">float</font><font color="#808080">)</font><font color="#808080">*</font><font color="#000000">100</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#008080">[Writes(%)]</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#808080">(</font><font color="#008080">[Reads&Writes]</font><font color="#808080">/</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">[Reads&Writes]</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">float</font><font color="#808080">)</font><font color="#808080">*</font><font color="#000000">100</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#008080">[Reads&Writes(%)]</font><br>&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">SampleDays</font><font color="#808080">,</font><font color="#008080">SampleSeconds</font>&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">@TBL</font>&nbsp;<font color="#0000ff">order</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#008080">[Reads&Writes]</font>&nbsp;<font color="#0000ff">desc</font><font color="#808080">,</font><font color="#008080">Writes</font>&nbsp;<font color="#0000ff">desc</font><font color="#808080">,</font><font color="#008080">Reads</font>&nbsp;<font color="#0000ff">desc</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">end</font><br>&nbsp;<font color="#0000ff">end</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">11</font><br>&nbsp;<font color="#008000">--Данные по выполнению заданий на сервере (job-ов)</font><br>&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">srv</font><font color="#808080">.</font><font color="#008080">GetStatisticJobs</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">12</font><br>&nbsp;<font color="#008000">--Мониторинг статистики по sql ожиданиям</font><br>&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">srv</font><font color="#808080">.</font><font color="#008080">Get_Statistic_Waits</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">13</font>&nbsp;<font color="#008000">--используемость индексов в БД, какие индексы можно убрать</font><br>&nbsp;<font color="#0000ff">begin</font><br>&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@INDEX</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#ff00ff">max</font><font color="#808080">)</font><br>&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@INDEX</font><font color="#808080">=</font><br><font color="#ff0000">'
	USE ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">']
	SELECT  DB_NAME() БД,
	 o.name AS ObjectName
	 , i.name AS IndexName
	 , i.index_id AS IndexID
	 , dm_ius.user_seeks AS UserSeek
	 , dm_ius.user_scans AS UserScans
	 , dm_ius.user_lookups AS UserLookups
	 , dm_ius.user_updates AS UserUpdates
	 ,last_user_seek
	 ,last_user_scan
	 ,last_user_lookup
	 ,last_user_update
	 , p.TableRows
	 , ''DROP INDEX '' + QUOTENAME(i.name)
	 + '' ON '' + QUOTENAME(s.name) + ''.'' + QUOTENAME(OBJECT_NAME(dm_ius.OBJECT_ID)) AS ''drop statement''
	 FROM sys.dm_db_index_usage_stats dm_ius
	 INNER JOIN sys.indexes i ON i.index_id = dm_ius.index_id AND dm_ius.OBJECT_ID = i.OBJECT_ID
	 INNER JOIN sys.objects o ON dm_ius.OBJECT_ID = o.OBJECT_ID
	 INNER JOIN sys.schemas s ON o.schema_id = s.schema_id
	 INNER JOIN (SELECT  SUM(p.rows) TableRows, p.index_id, p.OBJECT_ID
	 FROM sys.partitions p GROUP BY p.index_id, p.OBJECT_ID) p
	 ON p.index_id = dm_ius.index_id AND dm_ius.OBJECT_ID = p.OBJECT_ID
	 WHERE OBJECTPROPERTY(dm_ius.OBJECT_ID,''IsUserTable'') = 1
	 AND dm_ius.database_id = DB_ID()
	 AND i.type_desc in(''clustered'', ''nonclustered'')
	 AND i.is_unique_constraint = 0
	 AND (o.name='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">''' or '''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><br><font color="#ff0000">'''='''')
	 ORDER BY (dm_ius.user_seeks + dm_ius.user_scans + dm_ius.user_lookups) ASC'</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">try</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@INDEX</font>&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">print</font>&nbsp;<font color="#008080">@INDEX</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#008080">ERR_MSG</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">14</font>&nbsp;<font color="#008000">--Фрагментированность индексов для БД</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;<font color="#008000">--Контэйнер сбора фрагментированности по индексу</font><br>&nbsp;&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">@FRAG</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#ff00ff">max</font><font color="#808080">)</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@FRAG</font><font color="#808080">=</font><br><font color="#ff0000">'
		USE ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">']

	    SELECT  TOP  10000000000 DB_NAME() БД,b.object_id,c.name+''.''+b.name Таблица,
		s.[index],index_type_desc Тип_индекса,
		alloc_unit_type_desc Расположение,
		round(avg_fragmentation_in_percent,2) [Фрагментированность(%)],
		fragment_count Фрагментов,
		page_count Страниц_данных,
		avg_fragment_size_in_pages [Фрагменты/страницы]
		FROM sys.dm_db_index_physical_stats(DB_ID(), '</font><font color="#808080">+</font><font color="#0000ff">case</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#ff00ff">len</font><font color="#808080">(</font><font color="#008080">@TABLE</font><font color="#808080">)</font><font color="#808080">></font><font color="#000000">0</font>&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#ff0000">'cast(object_id('''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">''',''U'') as varchar(50))'</font>&nbsp;<font color="#0000ff">else</font>&nbsp;<font color="#ff0000">'NULL'</font>&nbsp;<font color="#0000ff">end</font><font color="#808080">+</font><font color="#ff0000">', NULL, NULL, '</font><font color="#808080">+</font><font color="#0000ff">case</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#008080">@Index_Is_Detailed</font><font color="#808080">=</font><font color="#000000">0</font>&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#ff0000">'NULL'</font>&nbsp;<font color="#0000ff">else</font>&nbsp;<font color="#ff0000">'''DETAILED'''</font>&nbsp;<font color="#0000ff">end</font><font color="#808080">+</font><br><font color="#ff0000">') a inner join
		sys.objects b on(a.object_id=b.object_id)
		inner join sys.schemas c on(b.schema_id=c.schema_id)
		left join 
		(SELECT  index_id id,name [index],[object_id] from sys.indexes) s on(b.object_id=s.[object_id] and a.[index_id]=s.id)
		WHERE alloc_unit_type_desc=''IN_ROW_DATA'' and ('''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">'''='''' or b.name='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><br><font color="#ff0000">''')
		order by c.name+''.''+b.name'</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">print</font>&nbsp;<font color="#008080">@FRAG</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@FRAG</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font>&nbsp;<font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#008080">err_msg</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">end</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">15</font>&nbsp;<font color="#008000">--Все индексы в БД</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@IND</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">4000</font><font color="#808080">)</font><font color="#808080">=</font><font color="#ff0000">''</font><br>&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@IND</font><font color="#808080">=</font>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;<font color="#ff0000">'USE ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">']
	  declare @indexes table(ServerName nvarchar(255),[DB_Name] nvarchar(255),TableName nvarchar(255),IndexName nvarchar(255),type_desc nvarchar(255),[Индексов] int)
		insert into @indexes
		SELECT   cast(SERVERPROPERTY(N''MachineName'') as nvarchar(255)) AS ServerName ,
				DB_NAME() AS [DB_Name] ,
				o.Name AS TableName ,
				i.Name AS IndexName, i.type_desc,COUNT(*) OVER (PARTITION BY o.Name ) [Индексов]
		FROM    sys.objects o
				LEFT JOIN sys.indexes i ON o.object_id = i.object_id
		WHERE   o.Type = ''U'' 
				AND LEFT(i.Name, 1) <> ''_'' 

		SELECT  a.*,(case when b.TableName is not null then 1 else 0 end) [ExistsClustered] FROM @indexes a left join (SELECT  TableName from @indexes where type_desc=''CLUSTERED'') b 
		on(a.TableName=b.TableName)
		ORDER BY a.[Индексов] DESC,a.TableName '</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">print</font>&nbsp;<font color="#008080">@IND</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@IND</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font>&nbsp;<font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#008080">err_msg</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;<font color="#0000ff">end</font><br>&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">16</font><br>&nbsp;<font color="#008000">--Статистика чтений, записей по файлам</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#008080">db</font><font color="#808080">,</font><font color="#008080">NumberReads</font><font color="#808080">,</font><font color="#008080">NumberWrites</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">NumberReads</font><font color="#808080">/</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">NumberReads</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">float</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">*</font><font color="#000000">100</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#008080">[NumberReads(%)]</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">NumberWrites</font><font color="#808080">/</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">NumberWrites</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">float</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">*</font><font color="#000000">100</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">3</font><font color="#808080">)</font><font color="#808080">)</font>&nbsp;<font color="#008080">[NumberWrites(%)]</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">NumberReads</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">/</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">NumberWrites</font><font color="#808080">+</font><font color="#008080">NumberReads</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">float</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">4</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">*</font><font color="#000000">100</font>&nbsp;<font color="#008080">[% reads]</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">NumberWrites</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font><font color="#808080">/</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">NumberWrites</font><font color="#808080">+</font><font color="#008080">NumberReads</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">over</font>&nbsp;<font color="#808080">(</font><font color="#0000ff">partition</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">float</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">numeric</font><font color="#808080">(</font><font color="#000000">12</font><font color="#808080">,</font><font color="#000000">4</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">*</font><font color="#000000">100</font>&nbsp;<font color="#008080">[% writes]</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">from</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#0000ff">name</font>&nbsp;<font color="#008080">db</font><font color="#808080">,</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">NumberReads</font><font color="#808080">)</font>&nbsp;<font color="#008080">NumberReads</font><font color="#808080">,</font><font color="#ff00ff">sum</font><font color="#808080">(</font><font color="#008080">NumberWrites</font><font color="#808080">)</font>&nbsp;<font color="#008080">NumberWrites</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">from</font>&nbsp;<font color="#808080">::</font><font color="#008080">fn_virtualfilestats</font><font color="#808080">(</font><font color="#808080">NULL</font><font color="#808080">,</font>&nbsp;<font color="#808080">NULL</font><font color="#808080">)</font>&nbsp;<font color="#008080">a</font>&nbsp;<font color="#808080">inner</font>&nbsp;<font color="#808080">join</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">databases</font>&nbsp;<font color="#008080">b</font>&nbsp;<font color="#0000ff">on</font><font color="#808080">(</font><font color="#008080">a</font><font color="#808080">.</font><font color="#008080">DbId</font><font color="#808080">=</font><font color="#008080">b</font><font color="#808080">.</font><font color="#008080">database_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">inner</font>&nbsp;<font color="#808080">join</font>&nbsp;&nbsp;<font color="#0000ff">master</font><font color="#808080">.</font><font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">master_files</font>&nbsp;<font color="#008080">c</font>&nbsp;<font color="#0000ff">on</font><font color="#808080">(</font><font color="#008080">a</font><font color="#808080">.</font><font color="#008080">DbId</font><font color="#808080">=</font><font color="#008080">c</font><font color="#808080">.</font><font color="#008080">database_id</font>&nbsp;<font color="#808080">and</font>&nbsp;&nbsp;<font color="#008080">a</font><font color="#808080">.</font><font color="#008080">FileId</font><font color="#808080">=</font><font color="#008080">c</font><font color="#808080">.</font><font color="#008080">[file_id]</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">where</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#0000ff">name</font><font color="#808080">=</font><font color="#008080">@DATABASE</font>&nbsp;<font color="#808080">or</font>&nbsp;<font color="#008080">@DATABASE</font><font color="#808080">=</font><font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">group</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#008080">b</font><font color="#808080">.</font><font color="#0000ff">name</font><font color="#808080">)</font>&nbsp;<font color="#008080">a</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">order</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#000000">4</font>&nbsp;<font color="#0000ff">desc</font><font color="#808080">,</font><font color="#000000">5</font>&nbsp;<font color="#0000ff">desc</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">17</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@sql_17</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">4000</font><font color="#808080">)</font><font color="#808080">=</font><font color="#ff0000">''</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql_17</font><font color="#808080">=</font><br><font color="#ff0000">'
	  use ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">']
	  SELECT  db_NAME(a.database_id) db,b.name tbl,/*a.object_id,ind.name [index],*/sum(user_seeks) user_seeks,sum(user_scans) user_scans,sum(user_lookups) user_lookups,sum(user_updates) user_updates,max(last_user_update) last_user_update,max(last_user_seek) last_user_seek,max(last_user_scan) last_user_scan,max(last_user_lookup)  last_user_lookup
	  from sys.dm_db_index_usage_stats a inner join sys.objects b on(a.object_id=b.object_id)
	  left outer join sys.indexes ind on(a.index_id=ind.index_id and a.object_id=ind.object_id)
	  where db_NAME(a.database_id)='''</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><font color="#ff0000">''' and ('''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">'''='''' or b.name='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><br><font color="#ff0000">''')
	  group by db_NAME(a.database_id),b.name
	  order by 3,4,5,6'</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">print</font>&nbsp;<font color="#008080">@sql_17</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql_17</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font>&nbsp;<font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#008080">err_msg</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">end</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">18</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@V</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#ff00ff">max</font><font color="#808080">)</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@ON_ALL_DATABASE_sql</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">2000</font><font color="#808080">)</font><font color="#808080">=</font><font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@ON_ALL_DATABASE_sql</font><font color="#808080">=</font><font color="#0000ff">case</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#008080">@Unloading</font><font color="#808080">=</font><font color="#000000">0</font>&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#ff0000">''</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#008080">@Unloading</font><font color="#808080">=</font><font color="#000000">1</font>&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#ff0000">'into ['</font><font color="#808080">+</font><font color="#008080">@DATABASE_Unloading</font><font color="#808080">+</font><font color="#ff0000">'].[dbo].['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><font color="#ff0000">'_'</font><font color="#808080">+</font><font color="#008080">@type_desc_object</font><font color="#808080">+</font><font color="#ff0000">'_'</font><font color="#808080">+</font><font color="#ff00ff">replace</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">getdate</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">date</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">50</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">'-'</font><font color="#808080">,</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">+</font><font color="#ff0000">']'</font>&nbsp;<font color="#0000ff">end</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@ON_ALL_DATABASE_sql2</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">2000</font><font color="#808080">)</font><font color="#808080">=</font><font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@ON_ALL_DATABASE_sql2</font><font color="#808080">=</font><font color="#0000ff">case</font>&nbsp;<font color="#0000ff">when</font>&nbsp;<font color="#008080">@Unloading</font><font color="#808080">=</font><font color="#000000">1</font>&nbsp;<br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">then</font>&nbsp;<font color="#ff0000">'if object_id(''master.dbo.['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><font color="#ff0000">'_'</font><font color="#808080">+</font><font color="#008080">@type_desc_object</font><font color="#808080">+</font><font color="#ff0000">'_'</font><font color="#808080">+</font><font color="#ff00ff">replace</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">getdate</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">date</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">50</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">'-'</font><font color="#808080">,</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">']'',''U'') is not null
	  drop table ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><font color="#ff0000">'_'</font><font color="#808080">+</font><font color="#008080">@type_desc_object</font><font color="#808080">+</font><font color="#ff0000">'_'</font><font color="#808080">+</font><font color="#ff00ff">replace</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">getdate</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">date</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">50</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">,</font><font color="#ff0000">'-'</font><font color="#808080">,</font><font color="#ff0000">''</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">']
	  '</font>&nbsp;<font color="#0000ff">else</font>&nbsp;<br><font color="#ff0000">'
	  '</font>&nbsp;<font color="#0000ff">end</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@V</font><font color="#808080">=</font><font color="#008080">@ON_ALL_DATABASE_sql2</font><font color="#808080">+</font><br><font color="#ff0000">'
		WITH P AS (		SELECT  sum(qs.execution_count) execution_count,max(qs.last_execution_time) last_execution_time,
		cast(sum(qs.total_worker_time)/1000.0 as int) total_worker_time,sum(qs.total_rows) total_rows,sum(qs.total_physical_reads)+sum(qs.total_logical_reads) total_reads
		,obj.name obj,obj.type_desc,isnull(db.name,'''</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">''') DB
		,cast(datediff(ss,(SELECT  create_date from sys.databases where name=''tempdb''),getdate())/(60.0*60.0*24.0) as numeric(11,2))  [Days]
		'</font><font color="#808080">+</font><font color="#008080">@ON_ALL_DATABASE_sql</font><font color="#808080">+</font><br><font color="#ff0000">'		
		FROM sys.dm_exec_query_stats qs
		CROSS APPLY sys.dm_exec_sql_text (qs.sql_handle) t 
		INNER JOIN sys.databases db  (nolock) on(t.dbid=db.database_id and db.name=N'''</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">''')
		INNER JOIN ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">'].sys.objects obj  (nolock) on(t.objectid=obj.object_id)
		
		where ('''</font><font color="#808080">+</font><font color="#008080">@type_desc_object</font><font color="#808080">+</font><font color="#ff0000">'''='''' or obj.type_desc='''</font><font color="#808080">+</font><font color="#008080">@type_desc_object</font><font color="#808080">+</font><font color="#ff0000">''' or obj.type='''</font><font color="#808080">+</font><font color="#008080">@type_desc_object</font><font color="#808080">+</font><font color="#ff0000">''') and ('''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">'''='''' or obj.name='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><br><font color="#ff0000">''')
		and ('''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">'''='''' or obj.name='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">''' or obj.name='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><br><font color="#ff0000">''') and left(obj.name,7)<>''Obsolet''
		group by t.[text],db.name,obj.name,obj.type_desc)

		SELECT execution_count,last_execution_time,total_worker_time,total_rows,total_reads,
		obj,[type_desc],DB,[Days]
		FROM P
		UNION
		SELECT NULL,NULL,NULL,NULL,NULL,[name] COLLATE Cyrillic_General_CI_AS,obj2.type_desc COLLATE Cyrillic_General_CI_AS,null,null 
		from ['</font><font color="#808080">+</font><font color="#008080">@DATABASE</font><font color="#808080">+</font><br><font color="#ff0000">'].sys.objects obj2 where 
			('''</font><font color="#808080">+</font><font color="#008080">@type_desc_object</font><font color="#808080">+</font><font color="#ff0000">'''='''' or obj2.type_desc='''</font><font color="#808080">+</font><font color="#008080">@type_desc_object</font><font color="#808080">+</font><font color="#ff0000">''' or obj2.type='''</font><font color="#808080">+</font><font color="#008080">@type_desc_object</font><font color="#808080">+</font><font color="#ff0000">''') and ('''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">'''='''' or obj2.name='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><br><font color="#ff0000">''')
		and ('''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">'''='''' or obj2.name='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">''' or obj2.name='''</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><br><font color="#ff0000">''') and left(obj2.name,7)<>''Obsolet''
		order by 1 desc'</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@V</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">try</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font>&nbsp;<font color="#0000ff">catch</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#ff00ff">ERROR_MESSAGE</font><font color="#808080">(</font><font color="#808080">)</font>&nbsp;<font color="#008080">ERR_MSG</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font>&nbsp;<font color="#0000ff">catch</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">end</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">19</font>&nbsp;<font color="#008000">--Кто активен и потребление ресурсов</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">[srv]</font><font color="#808080">.</font><font color="#008080">[Used_resouces_by_sessions]</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">[dbo]</font><font color="#808080">.</font><font color="#008080">[sp_WhoIsActive_Admin]</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">end</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">20</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#ff00ff">OBJECT_ID</font><font color="#808080">(</font><font color="#ff0000">'tempdb..#temp_stat'</font><font color="#808080">,</font><font color="#ff0000">'U'</font><font color="#808080">)</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">drop</font>&nbsp;<font color="#0000ff">table</font>&nbsp;<font color="#008080">#temp_stat</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#0000ff">distinct</font>&nbsp;<font color="#0000ff">TOP</font>&nbsp;&nbsp;<font color="#000000">50</font>&nbsp;<font color="#008000">--top 2000</font><br>&nbsp;&nbsp;&nbsp;<font color="#008080">db</font><font color="#808080">.</font><font color="#0000ff">name</font>&nbsp;<font color="#008080">db</font><font color="#808080">,</font><font color="#ff00ff">SUBSTRING</font><font color="#808080">(</font><font color="#008080">qt</font><font color="#808080">.</font><font color="#0000ff">TEXT</font><font color="#808080">,</font>&nbsp;<font color="#808080">(</font><font color="#008080">qs</font><font color="#808080">.</font><font color="#008080">statement_start_offset</font><font color="#808080">/</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><font color="#808080">,</font><br>&nbsp;&nbsp;<font color="#808080">(</font><font color="#808080">(</font><font color="#0000ff">CASE</font>&nbsp;<font color="#008080">qs</font><font color="#808080">.</font><font color="#008080">statement_end_offset</font><br>&nbsp;&nbsp;<font color="#0000ff">WHEN</font>&nbsp;<font color="#808080">-</font><font color="#000000">1</font>&nbsp;<font color="#0000ff">THEN</font>&nbsp;<font color="#ff00ff">DATALENGTH</font><font color="#808080">(</font><font color="#008080">qt</font><font color="#808080">.</font><font color="#0000ff">TEXT</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">ELSE</font>&nbsp;<font color="#008080">qs</font><font color="#808080">.</font><font color="#008080">statement_end_offset</font><br>&nbsp;&nbsp;<font color="#0000ff">END</font>&nbsp;<font color="#808080">-</font>&nbsp;<font color="#008080">qs</font><font color="#808080">.</font><font color="#008080">statement_start_offset</font><font color="#808080">)</font><font color="#808080">/</font><font color="#000000">2</font><font color="#808080">)</font><font color="#808080">+</font><font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#008080">script</font><font color="#808080">,</font>&nbsp;<br>&nbsp;&nbsp;<font color="#008080">qs</font><font color="#808080">.</font><font color="#008080">execution_count</font><font color="#808080">,</font><font color="#008080">plan_handle</font><font color="#808080">,</font><font color="#008080">total_worker_time</font><br>&nbsp;&nbsp;<font color="#0000ff">into</font>&nbsp;<font color="#008080">#temp_stat</font><br>&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_query_stats</font>&nbsp;<font color="#008080">qs</font><br>&nbsp;&nbsp;<font color="#808080">CROSS</font>&nbsp;<font color="#0000ff">APPLY</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_sql_text</font><font color="#808080">(</font><font color="#008080">qs</font><font color="#808080">.</font><font color="#008080">sql_handle</font><font color="#808080">)</font>&nbsp;<font color="#008080">qt</font><br>&nbsp;&nbsp;<font color="#0000ff">LEFT</font>&nbsp;<font color="#808080">JOIN</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">databases</font>&nbsp;<font color="#008080">db</font>&nbsp;<font color="#0000ff">on</font><font color="#808080">(</font><font color="#008080">qt</font><font color="#808080">.</font><font color="#008080">dbid</font>&nbsp;<font color="#808080">=</font><font color="#008080">db</font><font color="#808080">.</font><font color="#008080">database_id</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">ORDER</font>&nbsp;<font color="#0000ff">BY</font>&nbsp;<font color="#008080">total_worker_time</font>&nbsp;<font color="#0000ff">DESC</font><font color="#808080">,</font>&nbsp;<font color="#008080">execution_count</font>&nbsp;<font color="#0000ff">DESC</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#0000ff">TOP</font>&nbsp;&nbsp;<font color="#000000">100</font>&nbsp;<font color="#008080">db</font><font color="#808080">,</font><font color="#008080">script</font><font color="#808080">,</font><font color="#008080">execution_count</font><font color="#808080">,</font><font color="#008080">total_worker_time</font><font color="#808080">,</font><font color="#008080">query_plan</font>&nbsp;<font color="#0000ff">from</font>&nbsp;<font color="#008080">#temp_stat</font>&nbsp;<font color="#008080">qs</font><br>&nbsp;&nbsp;<font color="#808080">CROSS</font>&nbsp;<font color="#0000ff">APPLY</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">dm_exec_query_plan</font><font color="#808080">(</font><font color="#008080">qs</font><font color="#808080">.</font><font color="#008080">plan_handle</font><font color="#808080">)</font>&nbsp;<font color="#008080">qp</font><br>&nbsp;&nbsp;<font color="#0000ff">where</font>&nbsp;<font color="#0000ff">left</font><font color="#808080">(</font><font color="#008080">script</font><font color="#808080">,</font><font color="#000000">40</font><font color="#808080">)</font>&nbsp;<font color="#808080">not</font>&nbsp;<font color="#808080">in</font><font color="#808080">(</font><font color="#ff0000">'SELECT  distinct referenced_database_name'</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#808080">and</font>&nbsp;<font color="#0000ff">left</font><font color="#808080">(</font><font color="#008080">script</font><font color="#808080">,</font><font color="#000000">19</font><font color="#808080">)</font>&nbsp;<font color="#808080">not</font>&nbsp;<font color="#808080">in</font><font color="#808080">(</font><font color="#ff0000">'SELECT  DB_NAME() DB'</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#808080">and</font>&nbsp;<font color="#808080">(</font><font color="#008080">db</font><font color="#808080">=</font><font color="#008080">@DATABASE</font>&nbsp;<font color="#808080">or</font>&nbsp;<font color="#008080">@DATABASE</font><font color="#808080">=</font><font color="#ff0000">''</font><font color="#808080">)</font>&nbsp;<font color="#808080">and</font>&nbsp;<font color="#808080">(</font><font color="#008080">script</font>&nbsp;<font color="#808080">like</font>&nbsp;<font color="#ff0000">''</font><font color="#808080">+</font><font color="#ff0000">'%'</font><font color="#808080">+</font><font color="#008080">@TABLE</font><font color="#808080">+</font><font color="#ff0000">'%'</font><font color="#808080">+</font><font color="#ff0000">''</font>&nbsp;<font color="#808080">or</font>&nbsp;<font color="#008080">@TABLE</font><font color="#808080">=</font><font color="#ff0000">''</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">order</font>&nbsp;<font color="#0000ff">by</font>&nbsp;<font color="#008080">execution_count</font>&nbsp;<font color="#0000ff">desc</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">IF</font>&nbsp;<font color="#ff00ff">OBJECT_ID</font><font color="#808080">(</font><font color="#ff0000">'tempdb..#temp_stat'</font><font color="#808080">,</font><font color="#ff0000">'U'</font><font color="#808080">)</font>&nbsp;<font color="#808080">IS</font>&nbsp;<font color="#808080">NOT</font>&nbsp;<font color="#808080">NULL</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">drop</font>&nbsp;<font color="#0000ff">table</font>&nbsp;<font color="#008080">#temp_stat</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">end</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">21</font>&nbsp;<font color="#808080">and</font>&nbsp;<font color="#008080">@like</font><font color="#808080">=</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#ff00ff">len</font><font color="#808080">(</font><font color="#008080">@t</font><font color="#808080">)</font><font color="#808080">></font><font color="#000000">0</font>&nbsp;<font color="#808080">and</font>&nbsp;<font color="#008080">@DATABASE</font><font color="#808080">=</font><font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">srv</font><font color="#808080">.</font><font color="#008080">FindObject</font>&nbsp;<font color="#008080">@name</font><font color="#808080">=</font><font color="#008080">@TABLE</font><font color="#808080">,</font><font color="#008080">@like</font><font color="#808080">=</font><font color="#008080">@like</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#ff00ff">len</font><font color="#808080">(</font><font color="#008080">@DATABASE</font><font color="#808080">)</font><font color="#808080">></font><font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">srv</font><font color="#808080">.</font><font color="#008080">All_Find_Ref_Other_DB</font>&nbsp;<font color="#008080">@DBB</font><font color="#808080">=</font><font color="#008080">@DATABASE</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">end</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">21</font>&nbsp;<font color="#808080">and</font>&nbsp;<font color="#008080">@like</font><font color="#808080">=</font><font color="#000000">0</font>&nbsp;<font color="#808080">and</font>&nbsp;<font color="#008080">@DATABASE</font><font color="#808080">=</font><font color="#ff0000">''</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">[srv]</font><font color="#808080">.</font><font color="#008080">[FindObj]</font>&nbsp;<font color="#008080">@find</font><font color="#808080">=</font><font color="#008080">@TABLE</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">end</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">21</font>&nbsp;<font color="#808080">and</font>&nbsp;<font color="#008080">@like</font><font color="#808080">=</font><font color="#000000">0</font>&nbsp;<font color="#808080">and</font>&nbsp;<font color="#000000">1</font><font color="#808080">=</font><font color="#808080">(</font><font color="#0000ff">SELECT</font>&nbsp;&nbsp;<font color="#ff00ff">count</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">from</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">databases</font>&nbsp;<font color="#0000ff">where</font>&nbsp;<font color="#0000ff">name</font><font color="#808080">=</font><font color="#008080">@DATABASE</font><font color="#808080">)</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">[srv]</font><font color="#808080">.</font><font color="#008080">[Depend_objects]</font>&nbsp;<font color="#008080">@DB</font><font color="#808080">=</font><font color="#008080">@DATABASE</font><font color="#808080">,</font><font color="#008080">@obj</font><font color="#808080">=</font><font color="#008080">@TABLE</font><font color="#808080">,</font><font color="#008080">@job</font><font color="#808080">=</font><font color="#008080">@job</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">end</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font>&nbsp;<font color="#008080">@t</font><font color="#808080">=</font><font color="#000000">22</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#008080">[srv]</font><font color="#808080">.</font><font color="#008080">[DB_USE_DATASPACE]</font>&nbsp;<font color="#008080">@DATABASE</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font><br><font color="#0000ff">GO</font><br><font color="#000000"></font><br><font color="#0000ff">EXEC</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#800000">sp_addextendedproperty</font>&nbsp;<font color="#ff0000">N'MS_Description'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'Общая процедура мониторинга SQL Server'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'SCHEMA'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'srv'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'PROCEDURE'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'GetScalling_monitor_db'</font><br><font color="#0000ff">GO</font></div>
          </div>
        </div>
      </div>
      <div id="DependsOn" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Depends On</h2>
          <span class="badge inline-middle">13</span>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <ul class="items-list">
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Security\Schemas\srv.html" data-mapping-enabled="true"><span>srv</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.Disk_RAM.html" data-mapping-enabled="true"><span>srv.Disk_RAM</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.Locks.html" data-mapping-enabled="true"><span>srv.Locks</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.Backups_info.html" data-mapping-enabled="true"><span>srv.Backups_info</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.GetStatisticJobs.html" data-mapping-enabled="true"><span>srv.GetStatisticJobs</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.Get_Statistic_Waits.html" data-mapping-enabled="true"><span>srv.Get_Statistic_Waits</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.Used_resouces_by_sessions.html" data-mapping-enabled="true"><span>srv.Used_resouces_by_sessions</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\dbo.sp_WhoIsActive_Admin.html" data-mapping-enabled="true"><span>dbo.sp_WhoIsActive_Admin</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.FindObject.html" data-mapping-enabled="true"><span>srv.FindObject</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.All_Find_Ref_Other_DB.html" data-mapping-enabled="true"><span>srv.All_Find_Ref_Other_DB</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.FindObj.html" data-mapping-enabled="true"><span>srv.FindObj</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.Depend_objects.html" data-mapping-enabled="true"><span>srv.Depend_objects</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\srv.DB_USE_DATASPACE.html" data-mapping-enabled="true"><span>srv.DB_USE_DATASPACE</span></a></li>
            </ul>
          </div>
        </div>
      </div>
      <div id="UsedBy" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Used By</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <span class="text-muted">No items found</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    <div class="col-xs-4">Author:&nbsp;</div>
    <div class="col-xs-4 align-center">Copyright &#169; All Rights Reserved</div>
    <div class="col-xs-4 align-right">Created:&nbsp;26.12.2019</div>
  </div>
</body>
</html>