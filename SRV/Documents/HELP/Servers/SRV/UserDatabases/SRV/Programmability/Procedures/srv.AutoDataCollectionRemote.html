<!DOCTYPE HTML>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<title>srv.AutoDataCollectionRemote</title>
<script src="../../../../../../scripts/jquery-1.12.0.min.js" type="text/javascript"></script>
<script src="../../../../../../scripts/bootstrap.min.js" type="text/javascript"></script>
<script src="../../../../../../scripts/clipboard.min.js" type="text/javascript"></script>
<script src="../../../../../../scripts/main.js" type="text/javascript"></script>
<link rel="stylesheet" href="../../../../../../styles/bootstrap/Default.css" type="text/css">
<link rel="stylesheet" href="../../../../../../styles/main.css" type="text/css">
</head>
<body>
  <div class="page-wrap">
    <div class="header">
      <div class="row">
        <div class="col-xs-12">
          <ol class="breadcrumb">
            <li><a href="../../../../../../startpage.html" data-mapping-enabled="true">Project</a></li>
            <li><a href="../../../../../../Servers\Servers.html" data-mapping-enabled="true">Servers</a></li>
            <li><a href="../../../../../../Servers\SRV\SRV.html" data-mapping-enabled="true">SRV</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\UserDatabases.html" data-mapping-enabled="true">User databases</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\SRV.html" data-mapping-enabled="true">SRV</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Programmability.html" data-mapping-enabled="true">Programmability</a></li>
            <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Programmability\Procedures\Procedures.html" data-mapping-enabled="true">Stored Procedures</a></li>
            <li class="active">srv.AutoDataCollectionRemote</li>
          </ol>
        </div>
      </div>
      <div class="row">
        <div class="title col-xs-12">
          <div><img class="inline-middle image-large" src="../../../../../../images/procedure.svg" title="srv.AutoDataCollectionRemote" />
            <h1 class="inline-middle">srv.AutoDataCollectionRemote</h1>
            <div class="dropdown actions-btn-wrap">
              <button type="button" class="btn btn-default actions-btn" data-toggle="dropdown"><span class="icon-actions icon-small actions-btn-span"></span></button>
              <ul class="dropdown-menu dropdown-menu-right">
                <li><a id="CollapseAll" href="#">Collapse All</a></li>
                <li><a id="ExpandAll" href="#">Expand All</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="content">
      <div id="Description" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Description</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <span>Сбор данных с удаленных серверов</span>
          </div>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Properties</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <table class="table table-hover table-bordered">
              <tbody>
                <tr>
                  <th>Name</th>
                  <th>Value</th>
                </tr>
                <tr>
                  <td>ANSI Nulls ON</td>
                  <td><p class="value-true">True</p></td>
                </tr>
                <tr>
                  <td>Quoted Identifier ON</td>
                  <td><p class="value-true">True</p></td>
                </tr>
                <tr>
                  <td>Encrypted</td>
                  <td><p class="value-false">False</p></td>
                </tr>
                <tr>
                  <td>Execute As</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Assembly</td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="SqlScript" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">SQL Script</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <div class="sqlscript panel-default">
              <font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">QUOTED_IDENTIFIER</font><font color="#808080">,</font>&nbsp;<font color="#0000ff">ANSI_NULLS</font>&nbsp;<font color="#0000ff">ON</font><br><font color="#0000ff">GO</font><br><font color="#000000"></font><br><font color="#000000"></font><br><font color="#000000"></font><br><font color="#008000">-- =============================================</font><br><font color="#008000">-- Author:		<Author,,Name></font><br><font color="#008000">-- Create date: <Create Date,,></font><br><font color="#008000">-- Description:	<Description,,></font><br><font color="#008000">-- =============================================</font><br><font color="#0000ff">CREATE</font>&nbsp;<font color="#808080">OR</font>&nbsp;<font color="#0000ff">ALTER</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">PROCEDURE</font>&nbsp;<font color="#008080">srv</font><font color="#808080">.</font><font color="#008080">AutoDataCollectionRemote</font><br><font color="#0000ff">AS</font><br><font color="#0000ff">BEGIN</font><br>&nbsp;<br><font color="#008000">/*
		Сбор данных с удаленных серверов
	*/</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">QUERY_GOVERNOR_COST_LIMIT</font>&nbsp;<font color="#000000">0</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">NOCOUNT</font>&nbsp;<font color="#0000ff">ON</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">SET</font>&nbsp;<font color="#0000ff">TRANSACTION</font>&nbsp;<font color="#0000ff">ISOLATION</font>&nbsp;<font color="#0000ff">LEVEL</font>&nbsp;<font color="#0000ff">READ</font>&nbsp;<font color="#0000ff">UNCOMMITTED</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@servername</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">=</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">SERVERPROPERTY</font><font color="#808080">(</font><font color="#ff0000">N'MachineName'</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@sql</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#ff00ff">max</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@server</font>&nbsp;<font color="#0000ff">sysname</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">datetime</font><font color="#808080">=</font><font color="#ff00ff">GetUTCDate</font><font color="#808080">(</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@dt</font>&nbsp;<font color="#0000ff">datetime</font><font color="#808080">=</font><font color="#ff00ff">DateAdd</font><font color="#808080">(</font><font color="#0000ff">hour</font><font color="#808080">,</font>&nbsp;<font color="#808080">-</font><font color="#000000">16</font><font color="#808080">,</font>&nbsp;<font color="#008080">@dt0</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@existsSRV</font>&nbsp;<font color="#0000ff">table</font><font color="#808080">(</font><font color="#008080">[IsExists]</font>&nbsp;<font color="#0000ff">bit</font><font color="#808080">)</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">declare</font>&nbsp;<font color="#008080">@IsSRV</font>&nbsp;<font color="#0000ff">bit</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#008080">[name]</font><br>&nbsp;<font color="#0000ff">into</font>&nbsp;<font color="#008080">#tbl</font><br>&nbsp;<font color="#0000ff">from</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#008080">servers</font><br>&nbsp;<font color="#0000ff">where</font>&nbsp;<font color="#008080">[is_system]</font><font color="#808080">=</font><font color="#000000">0</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">and</font>&nbsp;<font color="#008080">[is_linked]</font><font color="#808080">=</font><font color="#000000">1</font><br>&nbsp;&nbsp;&nbsp;<font color="#808080">and</font>&nbsp;<font color="#008080">[name]</font><font color="#808080"><</font><font color="#808080">></font><font color="#008080">@servername</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">DECLARE</font>&nbsp;<font color="#008080">sql_cursor</font>&nbsp;<font color="#0000ff">CURSOR</font>&nbsp;<font color="#0000ff">LOCAL</font>&nbsp;<font color="#0000ff">FOR</font><br>&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#008080">[name]</font><br>&nbsp;<font color="#0000ff">from</font>&nbsp;<font color="#008080">#tbl</font><font color="#808080">;</font><br>&nbsp;<br>&nbsp;<font color="#0000ff">OPEN</font>&nbsp;<font color="#008080">sql_cursor</font><font color="#808080">;</font><br>&nbsp;&nbsp;&nbsp;<br>&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">sql_cursor</font>&nbsp;&nbsp;&nbsp;<br>&nbsp;<font color="#0000ff">INTO</font>&nbsp;<font color="#008080">@server</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">while</font>&nbsp;<font color="#808080">(</font><font color="#ff00ff">@@FETCH_STATUS</font>&nbsp;<font color="#808080">=</font>&nbsp;<font color="#000000">0</font>&nbsp;<font color="#808080">)</font><br>&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;<font color="#0000ff">delete</font>&nbsp;<font color="#0000ff">from</font>&nbsp;<font color="#008080">@existsSRV</font><font color="#808080">;</font><br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
		if(exists(select top(1) 1 from ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].master.sys.databases where [name]=''FortisAdmin''))
		begin
			select 1;
		end
		else select 0;'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">insert</font>&nbsp;<font color="#0000ff">into</font>&nbsp;<font color="#008080">@existsSRV</font>&nbsp;<font color="#808080">(</font><font color="#008080">[IsExists]</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">select</font>&nbsp;<font color="#0000ff">top</font><font color="#808080">(</font><font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#008080">@IsSRV</font><font color="#808080">=</font><font color="#008080">[IsExists]</font><br>&nbsp;&nbsp;<font color="#0000ff">from</font>&nbsp;<font color="#008080">@existsSRV</font><font color="#808080">;</font><br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<font color="#0000ff">if</font><font color="#808080">(</font><font color="#008080">@IsSRV</font><font color="#808080">=</font><font color="#000000">1</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">begin</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[WaitsStatistics]
					   ([Server]
					   ,[WaitType]
					   ,[Wait_S]
					   ,[Resource_S]
					   ,[Signal_S]
					   ,[WaitCount]
					   ,[Percentage]
					   ,[AvgWait_S]
					   ,[AvgRes_S]
					   ,[AvgSig_S]
					   ,[InsertUTCDate])
				SELECT  [Server]
					   ,[WaitType]
					   ,[Wait_S]
					   ,[Resource_S]
					   ,[Signal_S]
					   ,[WaitCount]
					   ,[Percentage]
					   ,[AvgWait_S]
					   ,[AvgRes_S]
					   ,[AvgSig_S]
					   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[WaitsStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';

				INSERT INTO [srv].[ReadWriteTablesStatistics]
				   ([ServerName]
				   ,[DBName]
				   ,[SchemaTableName]
				   ,[TableName]
				   ,[Reads]
				   ,[Writes]
				   ,[Reads&Writes]
				   ,[SampleDays]
				   ,[SampleSeconds]
				   ,[InsertUTCDate])
				SELECT [ServerName]
				   ,[DBName]
				   ,[SchemaTableName]
				   ,[TableName]
				   ,[Reads]
				   ,[Writes]
				   ,[Reads&Writes]
				   ,[SampleDays]
				   ,[SampleSeconds]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[ReadWriteTablesStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';

				INSERT INTO [srv].[OldStatisticsStateStatistics]
				   ([Server]
				   ,[DataBase]
				   ,[object_id]
				   ,[SchemaName]
				   ,[ObjectName]
				   ,[stats_id]
				   ,[StatName]
				   ,[row_count]
				   ,[ProcModified]
				   ,[ObjectSizeMB]
				   ,[type_desc]
				   ,[create_date]
				   ,[last_updated]
				   ,[ModificationCounter]
				   ,[ProcSampled]
				   ,[Func]
				   ,[IsScanned]
				   ,[ColumnType]
				   ,[auto_created]
				   ,[IndexName]
				   ,[has_filter]
				   ,[InsertUTCDate])
				SELECT [Server]
				   ,[DataBase]
				   ,[object_id]
				   ,[SchemaName]
				   ,[ObjectName]
				   ,[stats_id]
				   ,[StatName]
				   ,[row_count]
				   ,[ProcModified]
				   ,[ObjectSizeMB]
				   ,[type_desc]
				   ,[create_date]
				   ,[last_updated]
				   ,[ModificationCounter]
				   ,[ProcSampled]
				   ,[Func]
				   ,[IsScanned]
				   ,[ColumnType]
				   ,[auto_created]
				   ,[IndexName]
				   ,[has_filter]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[OldStatisticsStateStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[NewIndexOptimizeStatistics]
				   ([ServerName]
				   ,[DBName]
				   ,[Schema]
				   ,[Name]
				   ,[index_advantage]
				   ,[group_handle]
				   ,[unique_compiles]
				   ,[last_user_seek]
				   ,[last_user_scan]
				   ,[avg_total_user_cost]
				   ,[avg_user_impact]
				   ,[system_seeks]
				   ,[last_system_scan]
				   ,[last_system_seek]
				   ,[avg_total_system_cost]
				   ,[avg_system_impact]
				   ,[index_group_handle]
				   ,[index_handle]
				   ,[database_id]
				   ,[object_id]
				   ,[equality_columns]
				   ,[inequality_columns]
				   ,[statement]
				   ,[K]
				   ,[Keys]
				   ,[include]
				   ,[sql_statement]
				   ,[user_seeks]
				   ,[user_scans]
				   ,[est_impact]
				   ,[SecondsUptime]
				   ,[InsertUTCDate])
				SELECT [ServerName]
				   ,[DBName]
				   ,[Schema]
				   ,[Name]
				   ,[index_advantage]
				   ,[group_handle]
				   ,[unique_compiles]
				   ,[last_user_seek]
				   ,[last_user_scan]
				   ,[avg_total_user_cost]
				   ,[avg_user_impact]
				   ,[system_seeks]
				   ,[last_system_scan]
				   ,[last_system_seek]
				   ,[avg_total_system_cost]
				   ,[avg_system_impact]
				   ,[index_group_handle]
				   ,[index_handle]
				   ,[database_id]
				   ,[object_id]
				   ,[equality_columns]
				   ,[inequality_columns]
				   ,[statement]
				   ,[K]
				   ,[Keys]
				   ,[include]
				   ,[sql_statement]
				   ,[user_seeks]
				   ,[user_scans]
				   ,[est_impact]
				   ,[SecondsUptime]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[NewIndexOptimizeStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';

				INSERT INTO [srv].[IndicatorServerDayStatistics]
				   ([Server]
				   ,[ExecutionCount]
				   ,[AvgDur]
				   ,[AvgCPUTime]
				   ,[AvgIOLogicalReads]
				   ,[AvgIOLogicalWrites]
				   ,[AvgIOPhysicalReads]
				   ,[DATE])
				SELECT [Server]
				   ,[ExecutionCount]
				   ,[AvgDur]
				   ,[AvgCPUTime]
				   ,[AvgIOLogicalReads]
				   ,[AvgIOLogicalWrites]
				   ,[AvgIOPhysicalReads]
				   ,[DATE]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[IndicatorServerDayStatistics] as t_src
				WHERE [DATE]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#ff00ff">DateAdd</font><font color="#808080">(</font><font color="#ff00ff">day</font><font color="#808080">,</font><font color="#808080">-</font><font color="#000000">1</font><font color="#808080">,</font><font color="#008080">@dt0</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">date</font><font color="#808080">)</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				and not exists (select top(1) 1 from [srv].[IndicatorServerDayStatistics] as t_trg where t_src.[DATE]=t_trg.[DATE] and t_src.[Server]=t_trg.[Server]);
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[IndexUsageStatsStatistics]
				   ([SERVER]
				   ,[DataBase]
				   ,[SCHEMA_NAME]
				   ,[OBJECT NAME]
				   ,[INDEX NAME]
				   ,[index_advantage]
				   ,[USER_SEEKS]
				   ,[USER_SCANS]
				   ,[USER_LOOKUPS]
				   ,[USER_UPDATES]
				   ,[Last_User_Seek]
				   ,[Last_User_Scan]
				   ,[Last_User_Lookup]
				   ,[Last_User_Update]
				   ,[System_Seeks]
				   ,[System_Scans]
				   ,[System_Lookups]
				   ,[System_Updates]
				   ,[Last_System_Seek]
				   ,[Last_System_Scan]
				   ,[Last_System_Lookup]
				   ,[Last_System_Update]
				   ,[schema_id]
				   ,[object_id]
				   ,[index_id]
				   ,[ObjectType]
				   ,[TYPE_DESC_OBJECT]
				   ,[IndexType]
				   ,[TYPE_DESC_INDEX]
				   ,[Is_Unique]
				   ,[Data_Space_ID]
				   ,[Ignore_Dup_Key]
				   ,[Is_Primary_Key]
				   ,[Is_Unique_Constraint]
				   ,[Fill_Factor]
				   ,[Is_Padded]
				   ,[Is_Disabled]
				   ,[Is_Hypothetical]
				   ,[Allow_Row_Locks]
				   ,[Allow_Page_Locks]
				   ,[Has_Filter]
				   ,[Filter_Definition]
				   ,[Columns]
				   ,[IncludeColumns]
				   ,[InsertUTCDate])
				SELECT [SERVER]
				   ,[DataBase]
				   ,[SCHEMA_NAME]
				   ,[OBJECT NAME]
				   ,[INDEX NAME]
				   ,[index_advantage]
				   ,[USER_SEEKS]
				   ,[USER_SCANS]
				   ,[USER_LOOKUPS]
				   ,[USER_UPDATES]
				   ,[Last_User_Seek]
				   ,[Last_User_Scan]
				   ,[Last_User_Lookup]
				   ,[Last_User_Update]
				   ,[System_Seeks]
				   ,[System_Scans]
				   ,[System_Lookups]
				   ,[System_Updates]
				   ,[Last_System_Seek]
				   ,[Last_System_Scan]
				   ,[Last_System_Lookup]
				   ,[Last_System_Update]
				   ,[schema_id]
				   ,[object_id]
				   ,[index_id]
				   ,[ObjectType]
				   ,[TYPE_DESC_OBJECT]
				   ,[IndexType]
				   ,[TYPE_DESC_INDEX]
				   ,[Is_Unique]
				   ,[Data_Space_ID]
				   ,[Ignore_Dup_Key]
				   ,[Is_Primary_Key]
				   ,[Is_Unique_Constraint]
				   ,[Fill_Factor]
				   ,[Is_Padded]
				   ,[Is_Disabled]
				   ,[Is_Hypothetical]
				   ,[Allow_Row_Locks]
				   ,[Allow_Page_Locks]
				   ,[Has_Filter]
				   ,[Filter_Definition]
				   ,[Columns]
				   ,[IncludeColumns]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[IndexUsageStatsStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';

				INSERT INTO [srv].[IndexDefragStatistics]
				   ([Server]
				   ,[db]
				   ,[shema]
				   ,[tb]
				   ,[idx]
				   ,[database_id]
				   ,[index_name]
				   ,[index_type_desc]
				   ,[level]
				   ,[object_id]
				   ,[frag_num]
				   ,[frag]
				   ,[frag_page]
				   ,[page]
				   ,[rec]
				   ,[ghost]
				   ,[func]
				   ,[InsertUTCDate])
				SELECT [Server]
				   ,[db]
				   ,[shema]
				   ,[tb]
				   ,[idx]
				   ,[database_id]
				   ,[index_name]
				   ,[index_type_desc]
				   ,[level]
				   ,[object_id]
				   ,[frag_num]
				   ,[frag]
				   ,[frag_page]
				   ,[page]
				   ,[rec]
				   ,[ghost]
				   ,[func]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[IndexDefragStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[DelIndexIncludeStatistics]
				   ([Server]
				   ,[DataBase]
				   ,[SchemaName]
				   ,[ObjectName]
				   ,[ObjectType]
				   ,[ObjectCreateDate]
				   ,[DelIndexName]
				   ,[IndexIsPrimaryKey]
				   ,[IndexType]
				   ,[IndexFragmentation]
				   ,[IndexFragmentCount]
				   ,[IndexAvgFragmentSizeInPages]
				   ,[IndexPages]
				   ,[IndexKeyColumns]
				   ,[IndexIncludedColumns]
				   ,[ActualIndexName]
				   ,[InsertUTCDate])
				SELECT [Server]
				   ,[DataBase]
				   ,[SchemaName]
				   ,[ObjectName]
				   ,[ObjectType]
				   ,[ObjectCreateDate]
				   ,[DelIndexName]
				   ,[IndexIsPrimaryKey]
				   ,[IndexType]
				   ,[IndexFragmentation]
				   ,[IndexFragmentCount]
				   ,[IndexAvgFragmentSizeInPages]
				   ,[IndexPages]
				   ,[IndexKeyColumns]
				   ,[IndexIncludedColumns]
				   ,[ActualIndexName]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[DelIndexIncludeStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[BigQueryStatistics]
				   ([Server]
				   ,[creation_time]
				   ,[last_execution_time]
				   ,[execution_count]
				   ,[CPU]
				   ,[AvgCPUTime]
				   ,[TotDuration]
				   ,[AvgDur]
				   ,[AvgIOLogicalReads]
				   ,[AvgIOLogicalWrites]
				   ,[AggIO]
				   ,[AvgIO]
				   ,[AvgIOPhysicalReads]
				   ,[plan_generation_num]
				   ,[AvgRows]
				   ,[AvgDop]
				   ,[AvgGrantKb]
				   ,[AvgUsedGrantKb]
				   ,[AvgIdealGrantKb]
				   ,[AvgReservedThreads]
				   ,[AvgUsedThreads]
				   ,[query_text]
				   ,[database_name]
				   ,[object_name]
				   ,[query_plan]
				   ,[sql_handle]
				   ,[plan_handle]
				   ,[query_hash]
				   ,[query_plan_hash]
				   ,[InsertUTCDate])
				SELECT [Server]
				   ,[creation_time]
				   ,[last_execution_time]
				   ,[execution_count]
				   ,[CPU]
				   ,[AvgCPUTime]
				   ,[TotDuration]
				   ,[AvgDur]
				   ,[AvgIOLogicalReads]
				   ,[AvgIOLogicalWrites]
				   ,[AggIO]
				   ,[AvgIO]
				   ,[AvgIOPhysicalReads]
				   ,[plan_generation_num]
				   ,[AvgRows]
				   ,[AvgDop]
				   ,[AvgGrantKb]
				   ,[AvgUsedGrantKb]
				   ,[AvgIdealGrantKb]
				   ,[AvgReservedThreads]
				   ,[AvgUsedThreads]
				   ,[query_text]
				   ,[database_name]
				   ,[object_name]
				   ,cast([query_plan] as XML)
				   ,[sql_handle]
				   ,[plan_handle]
				   ,[query_hash]
				   ,[query_plan_hash]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[vBigQueryStatisticsRemote]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[TableStatistics]
				   ([ServerName]
				   ,[DBName]
				   ,[SchemaName]
				   ,[TableName]
				   ,[CountRows]
				   ,[DataKB]
				   ,[IndexSizeKB]
				   ,[UnusedKB]
				   ,[ReservedKB]
				   ,[InsertUTCDate]
				   ,[CountRowsBack]
				   ,[CountRowsNext]
				   ,[DataKBBack]
				   ,[DataKBNext]
				   ,[IndexSizeKBBack]
				   ,[IndexSizeKBNext]
				   ,[UnusedKBBack]
				   ,[UnusedKBNext]
				   ,[ReservedKBBack]
				   ,[ReservedKBNext]
				   ,[TotalPageSizeKB]
				   ,[TotalPageSizeKBBack]
				   ,[TotalPageSizeKBNext]
				   ,[UsedPageSizeKB]
				   ,[UsedPageSizeKBBack]
				   ,[UsedPageSizeKBNext]
				   ,[DataPageSizeKB]
				   ,[DataPageSizeKBBack]
				   ,[DataPageSizeKBNext])
				SELECT [ServerName]
				   ,[DBName]
				   ,[SchemaName]
				   ,[TableName]
				   ,[CountRows]
				   ,[DataKB]
				   ,[IndexSizeKB]
				   ,[UnusedKB]
				   ,[ReservedKB]
				   ,[InsertUTCDate]
				   ,[CountRowsBack]
				   ,[CountRowsNext]
				   ,[DataKBBack]
				   ,[DataKBNext]
				   ,[IndexSizeKBBack]
				   ,[IndexSizeKBNext]
				   ,[UnusedKBBack]
				   ,[UnusedKBNext]
				   ,[ReservedKBBack]
				   ,[ReservedKBNext]
				   ,[TotalPageSizeKB]
				   ,[TotalPageSizeKBBack]
				   ,[TotalPageSizeKBNext]
				   ,[UsedPageSizeKB]
				   ,[UsedPageSizeKBBack]
				   ,[UsedPageSizeKBNext]
				   ,[DataPageSizeKB]
				   ,[DataPageSizeKBBack]
				   ,[DataPageSizeKBNext]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[TableStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';

				INSERT INTO [srv].[TableIndexStatistics]
				   ([ServerName]
				   ,[DBName]
				   ,[SchemaName]
				   ,[TableName]
				   ,[IndexUsedForCounts]
				   ,[CountRows]
				   ,[InsertUTCDate])
				SELECT [ServerName]
				   ,[DBName]
				   ,[SchemaName]
				   ,[TableName]
				   ,[IndexUsedForCounts]
				   ,[CountRows]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[TableIndexStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[ServerDBFileInfoStatistics]
				   ([ServerName]
				   ,[DBName]
				   ,[File_id]
				   ,[Type_desc]
				   ,[FileName]
				   ,[Drive]
				   ,[Ext]
				   ,[CountPage]
				   ,[SizeMb]
				   ,[SizeGb]
				   ,[InsertUTCDate])
				SELECT [ServerName]
				   ,[DBName]
				   ,[File_id]
				   ,[Type_desc]
				   ,[FileName]
				   ,[Drive]
				   ,[Ext]
				   ,[CountPage]
				   ,[SizeMb]
				   ,[SizeGb]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[ServerDBFileInfoStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';

				INSERT INTO [srv].[DefragServers]
				   ([Server]
				   ,[db]
				   ,[shema]
				   ,[table]
				   ,[IndexName]
				   ,[frag_num]
				   ,[frag]
				   ,[page]
				   ,[rec]
				   ,[ts]
				   ,[tf]
				   ,[frag_after]
				   ,[object_id]
				   ,[idx]
				   ,[InsertUTCDate])
				SELECT '''</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N''' AS [Server]
				   ,[db]
				   ,[shema]
				   ,[table]
				   ,[IndexName]
				   ,[frag_num]
				   ,[frag]
				   ,[page]
				   ,[rec]
				   ,[ts]
				   ,[tf]
				   ,[frag_after]
				   ,[object_id]
				   ,[idx]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[Defrag]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[ShortInfoRunJobsServers]
				   ([Job_GUID]
				   ,[Job_Name]
				   ,[LastFinishRunState]
				   ,[LastRunDurationString]
				   ,[LastRunDurationInt]
				   ,[LastOutcomeMessage]
				   ,[LastRunOutcome]
				   ,[Server]
				   ,[InsertUTCDate]
				   ,[TargetServer]
				   ,[LastDateTime])
				SELECT [Job_GUID]
				   ,[Job_Name]
				   ,[LastFinishRunState]
				   ,[LastRunDurationString]
				   ,[LastRunDurationInt]
				   ,[LastOutcomeMessage]
				   ,[LastRunOutcome]
				   ,[Server]
				   ,[InsertUTCDate]
				   ,[TargetServer]
				   ,[LastDateTime]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[ShortInfoRunJobsServers]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';

				INSERT INTO [srv].[StatisticsIOInTempDBStatistics]
				   ([Server]
				   ,[physical_name]
				   ,[name]
				   ,[num_of_writes]
				   ,[avg_write_stall_ms]
				   ,[num_of_reads]
				   ,[avg_read_stall_ms]
				   ,[InsertUTCDate])
				SELECT [Server]
				   ,[physical_name]
				   ,[name]
				   ,[num_of_writes]
				   ,[avg_write_stall_ms]
				   ,[num_of_reads]
				   ,[avg_read_stall_ms]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[StatisticsIOInTempDBStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[DiskSpaceStatistics]
				   ([Server]
				   ,[Disk]
				   ,[Disk_Space_Mb]
				   ,[Available_Mb]
				   ,[Available_Percent]
				   ,[State]
				   ,[InsertUTCDate])
				SELECT [Server]
				   ,[Disk]
				   ,[Disk_Space_Mb]
				   ,[Available_Mb]
				   ,[Available_Percent]
				   ,[State]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[DiskSpaceStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';

				INSERT INTO [srv].[RAMSpaceStatistics]
				   ([Server]
				   ,[TotalAvailOSRam_Mb]
				   ,[RAM_Avail_Percent]
				   ,[Server_physical_memory_Mb]
				   ,[SQL_server_committed_target_Mb]
				   ,[SQL_server_physical_memory_in_use_Mb]
				   ,[State]
				   ,[InsertUTCDate])
				SELECT [Server]
				   ,[TotalAvailOSRam_Mb]
				   ,[RAM_Avail_Percent]
				   ,[Server_physical_memory_Mb]
				   ,[SQL_server_committed_target_Mb]
				   ,[SQL_server_physical_memory_in_use_Mb]
				   ,[State]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[RAMSpaceStatistics]
				WHERE [InsertUTCDate]>='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N'''
				  AND [InsertUTCDate]<='''</font><font color="#808080">+</font><font color="#ff00ff">cast</font><font color="#808080">(</font><font color="#008080">@dt0</font>&nbsp;<font color="#0000ff">as</font>&nbsp;<font color="#0000ff">nvarchar</font><font color="#808080">(</font><font color="#000000">255</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">+</font><br><font color="#ff0000">N''';
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[BigQueryGroupStatistics]
				   ([Server]
				   ,[creation_time]
				   ,[last_execution_time]
				   ,[execution_count]
				   ,[CPU]
				   ,[AvgCPUTime]
				   ,[TotDuration]
				   ,[AvgDur]
				   ,[AvgIOLogicalReads]
				   ,[AvgIOLogicalWrites]
				   ,[AggIO]
				   ,[AvgIO]
				   ,[AvgIOPhysicalReads]
				   ,[plan_generation_num]
				   ,[AvgRows]
				   ,[AvgDop]
				   ,[AvgGrantKb]
				   ,[AvgUsedGrantKb]
				   ,[AvgIdealGrantKb]
				   ,[AvgReservedThreads]
				   ,[AvgUsedThreads]
				   ,[query_text]
				   ,[database_name]
				   ,[object_name]
				   ,[query_plan]
				   ,[sql_handle]
				   ,[plan_handle]
				   ,[query_hash]
				   ,[query_plan_hash]
				   ,[InsertUTCDate])
				SELECT [Server]
				   ,[creation_time]
				   ,[last_execution_time]
				   ,[execution_count]
				   ,[CPU]
				   ,[AvgCPUTime]
				   ,[TotDuration]
				   ,[AvgDur]
				   ,[AvgIOLogicalReads]
				   ,[AvgIOLogicalWrites]
				   ,[AggIO]
				   ,[AvgIO]
				   ,[AvgIOPhysicalReads]
				   ,[plan_generation_num]
				   ,[AvgRows]
				   ,[AvgDop]
				   ,[AvgGrantKb]
				   ,[AvgUsedGrantKb]
				   ,[AvgIdealGrantKb]
				   ,[AvgReservedThreads]
				   ,[AvgUsedThreads]
				   ,[query_text]
				   ,[database_name]
				   ,[object_name]
				   ,cast([query_plan] as XML)
				   ,[sql_handle]
				   ,[plan_handle]
				   ,[query_hash]
				   ,[query_plan_hash]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[vBigQueryGroupStatisticsRemote];
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">set</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">=</font><br><font color="#ff0000">N'
			begin
				INSERT INTO [srv].[DBFileStatistics]
				   ([Server]
				   ,[DBName]
				   ,[FileId]
				   ,[NumberReads]
				   ,[BytesRead]
				   ,[IoStallReadMS]
				   ,[NumberWrites]
				   ,[BytesWritten]
				   ,[IoStallWriteMS]
				   ,[IoStallMS]
				   ,[BytesOnDisk]
				   ,[TimeStamp]
				   ,[FileHandle]
				   ,[Type_desc]
				   ,[FileName]
				   ,[Drive]
				   ,[Physical_Name]
				   ,[Ext]
				   ,[CountPage]
				   ,[SizeMb]
				   ,[SizeGb]
				   ,[Growth]
				   ,[GrowthMb]
				   ,[GrowthGb]
				   ,[GrowthPercent]
				   ,[is_percent_growth]
				   ,[database_id]
				   ,[State]
				   ,[StateDesc]
				   ,[IsMediaReadOnly]
				   ,[IsReadOnly]
				   ,[IsSpace]
				   ,[IsNameReserved]
				   ,[CreateLsn]
				   ,[DropLsn]
				   ,[ReadOnlyLsn]
				   ,[ReadWriteLsn]
				   ,[DifferentialBaseLsn]
				   ,[DifferentialBaseGuid]
				   ,[DifferentialBaseTime]
				   ,[RedoStartLsn]
				   ,[RedoStartForkGuid]
				   ,[RedoTargetLsn]
				   ,[RedoTargetForkGuid]
				   ,[BackupLsn]
				   ,[InsertUTCDate])
				SELECT [Server]
				   ,[DBName]
				   ,[FileId]
				   ,[NumberReads]
				   ,[BytesRead]
				   ,[IoStallReadMS]
				   ,[NumberWrites]
				   ,[BytesWritten]
				   ,[IoStallWriteMS]
				   ,[IoStallMS]
				   ,[BytesOnDisk]
				   ,[TimeStamp]
				   ,[FileHandle]
				   ,[Type_desc]
				   ,[FileName]
				   ,[Drive]
				   ,[Physical_Name]
				   ,[Ext]
				   ,[CountPage]
				   ,[SizeMb]
				   ,[SizeGb]
				   ,[Growth]
				   ,[GrowthMb]
				   ,[GrowthGb]
				   ,[GrowthPercent]
				   ,[is_percent_growth]
				   ,[database_id]
				   ,[State]
				   ,[StateDesc]
				   ,[IsMediaReadOnly]
				   ,[IsReadOnly]
				   ,[IsSpace]
				   ,[IsNameReserved]
				   ,[CreateLsn]
				   ,[DropLsn]
				   ,[ReadOnlyLsn]
				   ,[ReadWriteLsn]
				   ,[DifferentialBaseLsn]
				   ,[DifferentialBaseGuid]
				   ,[DifferentialBaseTime]
				   ,[RedoStartLsn]
				   ,[RedoStartForkGuid]
				   ,[RedoTargetLsn]
				   ,[RedoTargetForkGuid]
				   ,[BackupLsn]
				   ,[InsertUTCDate]
				FROM ['</font><font color="#808080">+</font><font color="#008080">@server</font><font color="#808080">+</font><br><font color="#ff0000">N'].[FortisAdmin].[srv].[DBFileStatistics];
			end'</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">exec</font>&nbsp;<font color="#800000">sp_executesql</font>&nbsp;<font color="#008080">@sql</font><font color="#808080">;</font><font color="#008000">--,</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--N'@IsSRV bit',  </font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">--@IsSRV = @IsSRV;</font><br>&nbsp;&nbsp;<font color="#0000ff">end</font><br><font color="#000000"></font><br>&nbsp;&nbsp;<font color="#0000ff">FETCH</font>&nbsp;<font color="#0000ff">NEXT</font>&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">sql_cursor</font><br>&nbsp;&nbsp;<font color="#0000ff">INTO</font>&nbsp;<font color="#008080">@server</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">end</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">CLOSE</font>&nbsp;<font color="#008080">sql_cursor</font><font color="#808080">;</font><br>&nbsp;<font color="#0000ff">DEALLOCATE</font>&nbsp;<font color="#008080">sql_cursor</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">drop</font>&nbsp;<font color="#0000ff">table</font>&nbsp;<font color="#008080">#tbl</font><font color="#808080">;</font><br><font color="#000000"></font><br>&nbsp;<font color="#0000ff">INSERT</font>&nbsp;<font color="#0000ff">INTO</font>&nbsp;<font color="#008080">[srv]</font><font color="#808080">.</font><font color="#008080">[DefragServers]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">(</font><font color="#008080">[Server]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[db]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[shema]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[table]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[IndexName]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[frag_num]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[frag]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[page]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[rec]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[ts]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[tf]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[frag_after]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[object_id]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[idx]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[InsertUTCDate]</font><font color="#808080">)</font><br>&nbsp;&nbsp;<font color="#0000ff">SELECT</font>&nbsp;<font color="#008080">@servername</font>&nbsp;<font color="#0000ff">AS</font>&nbsp;<font color="#008080">[Server]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[db]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[shema]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[table]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[IndexName]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[frag_num]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[frag]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[page]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[rec]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[ts]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[tf]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[frag_after]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[object_id]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[idx]</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">,</font><font color="#008080">[InsertUTCDate]</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font>&nbsp;<font color="#008080">[srv]</font><font color="#808080">.</font><font color="#008080">[Defrag]</font><br>&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font>&nbsp;<font color="#008080">[InsertUTCDate]</font><font color="#808080">></font><font color="#808080">=</font><font color="#008080">@dt</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#808080">AND</font>&nbsp;<font color="#008080">[InsertUTCDate]</font><font color="#808080"><</font><font color="#808080">=</font><font color="#008080">@dt0</font><font color="#808080">;</font><br><font color="#0000ff">END</font><br><font color="#0000ff">GO</font><br><font color="#000000"></font><br><font color="#0000ff">EXEC</font>&nbsp;<font color="#008000">sys</font><font color="#808080">.</font><font color="#800000">sp_addextendedproperty</font>&nbsp;<font color="#ff0000">N'MS_Description'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'Сбор данных с удаленных серверов'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'SCHEMA'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'srv'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">'PROCEDURE'</font><font color="#808080">,</font>&nbsp;<font color="#ff0000">N'AutoDataCollectionRemote'</font><br><font color="#0000ff">GO</font></div>
          </div>
        </div>
      </div>
      <div id="DependsOn" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Depends On</h2>
          <span class="badge inline-middle">3</span>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <ul class="items-list">
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Security\Schemas\srv.html" data-mapping-enabled="true"><span>srv</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Tables\srv.DefragServers.html" data-mapping-enabled="true"><span>srv.DefragServers</span></a></li>
              <li><a href="../../../../../../Servers\SRV\UserDatabases\SRV\Tables\srv.Defrag.html" data-mapping-enabled="true"><span>srv.Defrag</span></a></li>
            </ul>
          </div>
        </div>
      </div>
      <div id="UsedBy" class="panel panel-default">
        <div class="panel-heading">
          <span class="icon-bottom inline-middle expanded icon-small"></span>
          <span class="icon-right inline-middle collapsed icon-small" style="display:none"></span>
          <h2 class="inline-middle">Used By</h2>
        </div>
        <div class="panel-collapse collapse in">
          <div class="panel-body">
            <span class="text-muted">No items found</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    <div class="col-xs-4">Author:&nbsp;</div>
    <div class="col-xs-4 align-center">Copyright &#169; All Rights Reserved</div>
    <div class="col-xs-4 align-right">Created:&nbsp;26.12.2019</div>
  </div>
</body>
</html>